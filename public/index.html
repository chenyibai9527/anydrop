<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Drop | Â±ÄÂüüÁΩëÊñá‰ª∂‰∫í‰º†</title>
  <meta name="description" content="DropÊòØ‰∏Ä‰∏™ÁÆÄÂçï„ÄÅÂø´ÈÄü„ÄÅÊó†ÈúÄÂÆâË£ÖÁöÑÂ±ÄÂüüÁΩëÊñá‰ª∂‰º†ËæìÂ∑•ÂÖ∑ÔºåËÆ©ÊÇ®Âú®Âêå‰∏ÄÁΩëÁªú‰∏ãÁöÑËÆæÂ§áÈó¥ËΩªÊùæÂàÜ‰∫´Êñá‰ª∂„ÄÇ">
  <meta name="keywords" content="Êñá‰ª∂‰º†Ëæì,Â±ÄÂüüÁΩë‰º†Ëæì,Êñá‰ª∂ÂàÜ‰∫´,Êó†Á∫ø‰º†Ëæì,P2P‰º†Ëæì">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí´</text></svg>">
  <script src="/socket.io/socket.io.js"></script>
  <!-- Ë∞ÉËØïÂ∑•ÂÖ∑ -->
  <script>
    // Ë∞ÉËØïÂ∑•ÂÖ∑
    function debugLog(tag, ...args) {
      const timestamp = new Date().toISOString().substr(11, 8);
      console.log(`[${tag}] ${timestamp}`, ...args);
    }
    
    // ÂÖ®Â±ÄÈîôËØØÊçïËé∑
    window.addEventListener('error', function(event) {
      debugLog('ERROR', 'ÂÖ®Â±ÄÈîôËØØ:', event.error);
      console.error(event.error);
    });
  </script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #3B82F6;
      --color-primary-light: #60A5FA;
      --color-primary-dark: #2563EB;
      --color-secondary: #A78BFA;
      --color-accent: #F472B6;
      --color-background: #FFFFFF;
      --color-surface: #F9FAFB;
      --color-border: #E5E7EB;
      --color-text-primary: #1F2937;
      --color-text-secondary: #4B5563;
      --color-text-tertiary: #9CA3AF;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius-sm: 0.375rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.5rem;
      --radius-full: 9999px;
      --animation-speed: 300ms;
    }

    [data-theme="dark"] {
      --color-primary: #60A5FA;
      --color-primary-light: #93C5FD;
      --color-primary-dark: #3B82F6;
      --color-secondary: #A78BFA;
      --color-accent: #F472B6;
      --color-background: #111827;
      --color-surface: #1F2937;
      --color-border: #374151;
      --color-text-primary: #F9FAFB;
      --color-text-secondary: #E5E7EB;
      --color-text-tertiary: #9CA3AF;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.25);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--color-text-primary);
      background: var(--color-background);
      overflow-x: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.5rem;
      background: var(--color-background);
      position: relative;
      z-index: 10;
      transition: background-color 0.3s ease;
    }

    .app-logo {
      display: flex;
      align-items: center;
      font-weight: 600;
      font-size: 1.25rem;
      color: var(--color-primary);
    }

    .app-logo span {
      margin-left: 0.5rem;
    }

    .topbar-actions {
      display: flex;
      gap: 1rem;
    }

    .icon-btn {
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
      color: var(--color-text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
    }

    .icon-btn:hover {
      background: var(--color-surface);
      color: var(--color-primary);
    }

    .icon-btn i {
      font-size: 1.25rem;
    }

    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      padding-top: 1rem;
      padding-bottom: 1rem;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .radar-container {
      position: relative;
      width: 100%;
      max-width: 480px;
      height: 320px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .radar-circle {
      position: absolute;
      border-radius: 50%;
      border: 1px solid rgba(59, 130, 246, 0.1);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.05);
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .radar-circle {
      border-color: rgba(96, 165, 250, 0.15);
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.08);
    }

    .circle-1 {
      width: 80px;
      height: 80px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
      animation: pulse 3s infinite;
    }

    .circle-2 {
      width: 160px;
      height: 160px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
      animation: pulse 3s infinite 0.5s;
    }

    .circle-3 {
      width: 240px;
      height: 240px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.03) 0%, transparent 70%);
      animation: pulse 3s infinite 1s;
    }

    .circle-4 {
      width: 320px;
      height: 320px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.02) 0%, transparent 70%);
      animation: pulse 3s infinite 1.5s;
    }

    [data-theme="dark"] .circle-1 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.12) 0%, transparent 70%);
    }

    [data-theme="dark"] .circle-2 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.08) 0%, transparent 70%);
    }

    [data-theme="dark"] .circle-3 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.05) 0%, transparent 70%);
    }

    [data-theme="dark"] .circle-4 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.03) 0%, transparent 70%);
    }

    @keyframes pulse {
      0% {
        opacity: 0.7;
        transform: scale(0.95);
      }
      50% {
        opacity: 0.9;
        transform: scale(1);
      }
      100% {
        opacity: 0.7;
        transform: scale(0.95);
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.25rem 0;
      font-size: 0.85rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      justify-content: center;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      max-width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
    }

    /* ËÆæÂ§áÂàóË°®‰∏≠ÁöÑ"Êõ¥Â§ö"ÊåâÈíÆ */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
    }

    .more-devices-btn:hover {
      border-color: var(--color-primary-light);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .more-devices-btn:active {
      transform: scale(0.95);
    }

    /* ÂºπÁ™ó‰∏≠ÁöÑËÆæÂ§áÂàóË°®Ê†∑Âºè */
    .devices-modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      margin: 1rem 0;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .devices-modal-grid .device-chip {
      margin: 0;
      justify-content: flex-start;
      width: 100%;
    }

    @media (max-width: 768px) {
      .devices-modal-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }

    /* ËÆæÂ§áÂàóË°®ÊªöÂä®Êù°Ê†∑Âºè */
    .device-list::-webkit-scrollbar {
      height: 4px;
      width: 4px;
    }

    .device-list::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    /* ËÆæÂ§áÂàóË°®ÊäòÂè†/Â±ïÂºÄÊéßÂà∂ */
    .device-list-toggle {
      display: none;
    }

    .device-list.collapsed {
      display: flex;
    }

    .device-list.collapsed .device-list-toggle i {
      transform: none;
    }

    .device-list.collapsed .device-list-inner {
      display: flex;
    }

    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .device-chip:hover {
      border-color: var(--color-primary-light);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .device-chip.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-chip.selected {
      position: relative;
    }

    .device-chip.selected:after {
      content: "";
      position: absolute;
      top: -4px;
      right: -4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-chip i {
      font-size: 1rem;
      color: inherit;
    }

    .notification {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--color-background);
      border-radius: var(--radius-lg);
      padding: 1rem 1.5rem;
      font-weight: 500;
      color: var(--color-text-primary);
      box-shadow: var(--shadow-lg);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      z-index: 2000;
      border: 1px solid var(--color-border);
      max-width: 280px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    [data-theme="dark"] .modal {
      background: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      max-width: 400px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      animation: modal-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid var(--color-border);
    }

    @keyframes modal-in {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 1rem;
    }

    .modal-buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      border: none;
    }

    .modal-btn.primary {
      background: var(--color-primary);
      color: white;
    }

    .modal-btn.primary:hover {
      background: var(--color-primary-dark);
    }

    .modal-btn.secondary {
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
    }

    .modal-btn.secondary:hover {
      background: var(--color-border);
    }

    .transfer-progress {
      margin-top: 1rem;
      width: 100%;
      background: var(--color-surface);
      border-radius: var(--radius-full);
      height: 6px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
      border-radius: var(--radius-full);
      transition: width 0.3s ease;
    }

    .load-animation {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-background);
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    .load-animation.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .load-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-surface);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 2rem 0;
      color: var(--color-text-tertiary);
    }

    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }

    .device-select-container {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-bottom: 1rem;
      max-height: 150px;
      overflow-y: auto;
    }

    .device-select-container .device-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .device-select-container .device-option:hover {
      background: var(--color-background);
    }

    .device-select-container .checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--color-border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
    }

    .device-select-container .checkbox.checked {
      background: var(--color-primary);
      border-color: var(--color-primary);
    }

    .device-select-all {
      font-size: 0.875rem;
      color: var(--color-primary);
      cursor: pointer;
      margin-top: 0.5rem;
      display: inline-block;
    }

    .transfer-progress-container {
      transition: all 0.3s ease !important;
      border: 1px solid var(--color-border);
    }

    @media (max-width: 768px) {
      .radar-container {
        height: 240px;
      }
      
      .circle-4 {
        width: 200px;
        height: 200px;
      }
      
      .circle-3 {
        width: 150px;
        height: 150px;
      }
      
      .circle-2 {
        width: 100px;
        height: 100px;
      }
      
      .upload-button {
        width: 70px;
        height: 70px;
        font-size: 1.25rem;
      }
      
      .topbar {
        padding: 0.75rem 1rem;
      }
      
      .device-list {
        padding: 0.75rem 0.75rem calc(0.75rem + env(safe-area-inset-bottom, 0.75rem));
      }
      
      .device-info {
        margin-top: 0.5rem;
      }
      
      .main-area {
        padding-top: 1rem;
      }
      
      .device-chip {
        padding: 0.4rem 0.9rem;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .radar-container {
        height: 160px;
        margin-bottom: 0;
      }
      
      .circle-4 {
        width: 160px;
        height: 160px;
      }
      
      .circle-3 {
        width: 120px;
        height: 120px;
      }
      
      .circle-2 {
        width: 80px;
        height: 80px;
      }
      
      .circle-1 {
        width: 40px;
        height: 40px;
      }
      
      .upload-button {
        width: 45px;
        height: 45px;
        font-size: 1rem;
      }
      
      .action-buttons {
        flex-direction: column;
        gap: 0.5rem;
        width: 100%;
        max-width: 260px;
        margin-bottom: 0.6rem;
      }
      
      .action-btn {
        width: 100%;
        padding: 0.5rem;
        text-align: center;
        font-size: 0.8rem;
        justify-content: center;
      }
      
      .action-btn i {
        font-size: 1rem;
      }
      
      .device-name-field input {
        font-size: 1.1rem;
      }
      
      .device-name-field {
        margin-bottom: 0.5rem;
      }
      
      .instructions {
        font-size: 0.8rem;
        margin: 0.15rem 0;
      }
      
      .device-info {
        margin-top: 0.5rem;
      }
    }

    /* ÁßªÈô§ÊâÄÊúâÊåâÈíÆÂíåÂèØ‰∫§‰∫íÂÖÉÁ¥†ÁöÑËß¶Êë∏È´ò‰∫Æ */
    button, a, .device-chip, .icon-btn, .action-btn, .modal-btn {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      outline: none;
      user-select: none;
    }

    /* Á°Æ‰øùÊåâÈíÆÁÇπÂáªÊïàÊûú */
    .action-btn:active, .device-chip:active, .icon-btn:active {
      transform: scale(0.95);
    }

    /* ‰øÆÂ§çÊåâÈíÆÁÑ¶ÁÇπÊ†∑Âºè */
    .action-btn:focus, .device-chip:focus, .icon-btn:focus, .modal-btn:focus {
      outline: none;
    }

    /* Ê∑ªÂä†ËøõÂ∫¶Êù°Ê†∑ÂºèÂà∞Â§¥ÈÉ®Ê†∑ÂºèÂå∫Âüü */
    .transfer-progress .progress-container {
      height: 6px;
      background: var(--color-background);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin: 0.5rem 0 0.25rem 0;
    }

    .transfer-progress .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
      border-radius: var(--radius-full);
      transition: width 0.2s ease-out;
    }

    .transfer-progress .transfer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
    }

    .transfer-progress .transfer-filename {
      font-weight: 500;
      font-size: 0.875rem;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .transfer-progress .cancel-transfer {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      cursor: pointer;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      padding: 0;
      transition: all 0.2s ease;
    }

    .transfer-progress .cancel-transfer:hover {
      background: var(--color-background);
      color: var(--color-text-secondary);
    }

    #transfersContainer {
      position: fixed;
      bottom: calc(70px + env(safe-area-inset-bottom, 0px));
      right: 1rem;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 50vh;
      overflow-y: auto;
      padding-right: 0.5rem;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      pointer-events: auto;
    }

    #transfersContainer::-webkit-scrollbar {
      width: 4px;
    }

    #transfersContainer::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    /* ÁßªÂä®Á´ØÈÄÇÈÖç */
    @media (max-width: 768px) {
      #transfersContainer {
        right: 0.5rem;
        max-width: calc(100vw - 2rem);
      }
      
      .transfer-progress {
        max-width: calc(100vw - 2rem);
      }
    }
  </style>
</head>
<body ontouchstart="">
  <div class="load-animation">
    <div class="load-spinner"></div>
  </div>

  <div class="app-container">
    <!-- È°∂ÈÉ®ÂØºËà™ -->
    <header class="topbar">
      <div class="app-logo">
        <i class="ri-share-forward-fill"></i>
        <span>AnyDrop</span>
      </div>
      <div class="topbar-actions">
        <button class="icon-btn" id="themeToggle" title="ÂàáÊç¢‰∏ªÈ¢ò">
          <i class="ri-sun-line"></i>
        </button>
        <button class="icon-btn" id="languageToggle" title="ÂàáÊç¢ËØ≠Ë®Ä">
          <i class="ri-translate-2"></i>
        </button>
        <button class="icon-btn" title="ÂÖ≥‰∫é">
          <i class="ri-information-line"></i>
        </button>
        <button class="icon-btn" title="Â∏ÆÂä©">
          <i class="ri-question-line"></i>
        </button>
      </div>
    </header>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫ -->
    <main class="main-area">
      <div class="radar-container">
        <!-- Èõ∑ËææÂúÜÂúà -->
        <div class="radar-circle circle-1"></div>
        <div class="radar-circle circle-2"></div>
        <div class="radar-circle circle-3"></div>
        <div class="radar-circle circle-4"></div>

        <!-- ‰∏ä‰º†ÊåâÈíÆ -->
        <button class="upload-button" id="mainUploadBtn" title="ÁÇπÂáª‰∏ä‰º†Êñá‰ª∂">
          <i class="ri-upload-cloud-line"></i>
          <input type="file" id="fileInput" multiple>
        </button>
      </div>

      <!-- ËÆæÂ§á‰ø°ÊÅØ -->
      <div class="device-info">
        <div class="action-buttons">
          <button class="action-btn" id="uploadFolderBtn">
            <i class="ri-folder-upload-line"></i>
            ‰∏ä‰º†Êñá‰ª∂Â§π
          </button>
          <button class="action-btn" id="sendTextBtn">
            <i class="ri-message-2-line"></i>
            ÂèëÈÄÅÊñáÊú¨
          </button>
        </div>
        
        <div class="device-label">
          <i class="ri-device-line" id="deviceTypeIcon"></i>
          <span>ÊàëÁöÑËÆæÂ§á</span>
        </div>
        <div class="device-name-field">
          <input id="deviceName" value="ÊàëÁöÑËÆæÂ§á" maxlength="20" />
          <button class="edit-btn" title="ÁºñËæëÂêçÁß∞">
            <i class="ri-edit-line"></i>
          </button>
        </div>
        <p class="instructions">Âêå‰∏ÄÁΩëÁªú‰∏ãËÆæÂ§á‰ºöËá™Âä®ÊòæÁ§∫ÔºåÁÇπÂáªËÆæÂ§áÂèëÈÄÅÊñá‰ª∂</p>
      </div>
    </main>

    <!-- ËÆæÂ§áÂàóË°® -->
    <div class="device-list" id="deviceFooter">
      <div class="device-list-inner" id="deviceListInner"></div>
    </div>
  </div>

  <!-- Êñá‰ª∂Â§π‰∏ä‰º†ÈöêËóèinput -->
  <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none">
  
  <!-- ÈÄöÁü• -->
  <div id="notification" class="notification"></div>
  
  <!-- ÂºπÁ™óÂå∫ -->
  <div id="modal" style="display:none"></div>

  <!-- ËÑöÊú¨ÈÉ®ÂàÜ -->
  <script>
    // ÈÖçÁΩÆSocket.IOÊ≠£Á°ÆÂ§ÑÁêÜ‰∫åËøõÂà∂Êï∞ÊçÆ
    // Ëá™Âä®ÈÄÇÈÖçÂêéÁ´ØÂú∞ÂùÄÔºåÊîØÊåÅÊú¨Âú∞Âíå‰∫ëÁ´Ø
    const socket = io(window.location.origin, {
      binaryType: 'arraybuffer'
    });
    
    debugLog('INIT', 'Socket.IOÂ∑≤ÂàùÂßãÂåñÔºåÈÖçÁΩÆ‰∏∫Â§ÑÁêÜ‰∫åËøõÂà∂Êï∞ÊçÆ');
    
    let myDeviceId = null;
    let devices = new Map();
    let myDeviceInfo = {};
    let transferStartTime = null;
    let activeTransfers = new Map();
    let selectedDeviceId = null;
    let selectedDevices = new Set(); // Â≠òÂÇ®Â∑≤ÈÄâÊã©ÁöÑÂ§ö‰∏™ËÆæÂ§áID
    let isDarkMode = false;
    let fileTransferMappings = new Map(); // Â≠òÂÇ®transferIdÂà∞targetIdÁöÑÊò†Â∞ÑÔºåÁî®‰∫éÂ§öËÆæÂ§á‰º†Ëæì
    let currentLanguage = 'en'; // ÈªòËÆ§ËØ≠Ë®Ä‰∏∫Ëã±Êñá

    // Â§öËØ≠Ë®ÄÊîØÊåÅ
    const translations = {
      zh: {
        appTitle: 'AnyDrop | Â±ÄÂüüÁΩëÊñá‰ª∂‰∫í‰º†Â∑•ÂÖ∑,Á±ª‰ºº Snapdrop',
        myDevice: 'ÊàëÁöÑËÆæÂ§á',
        uploadFileFolder: '‰∏ä‰º†Êñá‰ª∂Â§π',
        sendText: 'ÂèëÈÄÅÊñáÊú¨',
        searching: 'Ê≠£Âú®ÂØªÊâæÈôÑËøëÁöÑËÆæÂ§á...',
        instruction: 'Âêå‰∏ÄÁΩëÁªú‰∏ãËÆæÂ§á‰ºöËá™Âä®ÊòæÁ§∫ÔºåÁÇπÂáªËÆæÂ§áÂèëÈÄÅÊñá‰ª∂',
        multiSelect: 'Â§öÈÄâ',
        selected: 'Â∑≤ÈÄâ',
        more: 'Êõ¥Â§ö',
        receive: 'Êé•Êî∂',
        reject: 'ÊãíÁªù',
        send: 'ÂèëÈÄÅ',
        cancel: 'ÂèñÊ∂à',
        waiting: 'Á≠âÂæÖÁ°ÆËÆ§...',
        preparing: 'ÂáÜÂ§á‰∏≠...',
        receiving: 'Ê≠£Âú®Êé•Êî∂',
        fileSending: 'Ê≠£Âú®Âêë {0} ‰∏™ËÆæÂ§áÂèëÈÄÅ {1} ‰∏™Êñá‰ª∂',
        fileReceiving: 'Ê≠£Âú®Êé•Êî∂ {0}',
        fileCompleted: 'Êñá‰ª∂ {0} ‰º†ËæìÂÆåÊàê',
        fileCancelled: 'Â∑≤ÂèñÊ∂à{0}Êñá‰ª∂ {1}',
        noDevices: 'Ê≤°ÊúâÂèØÁî®ÁöÑËÆæÂ§á',
        selectDeviceTitle: 'ÈÄâÊã©ËÆæÂ§á',
        confirm: 'Á°ÆËÆ§',
        selectAtLeastOne: 'ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ËÆæÂ§á',
        sendToDevice: 'ÂèëÈÄÅÊñá‰ª∂Ëá≥ {0}',
        sendToMultiDevices: 'ÂèëÈÄÅÊñá‰ª∂Ëá≥ {0} ‰∏™ËÆæÂ§á',
        receivingFromDevice: 'Êù•Ëá™ {0} ÁöÑÊñá‰ª∂Ôºö',
        saveFile: '‰øùÂ≠òÊñá‰ª∂',
        openInNewWindow: 'Âú®Êñ∞Á™óÂè£ÊâìÂºÄ',
        deviceJoined: '{0} Â∑≤Âä†ÂÖ•',
        selectAll: 'ÂÖ®ÈÄâ',
        fileReceived: 'Êñá‰ª∂Â∑≤Êé•Êî∂',
        downloadTip: 'ÊèêÁ§∫: Â¶ÇÊûú‰∏ãËΩΩ‰∏çËá™Âä®ÂºÄÂßãÔºåËØ∑ÁÇπÂáª"‰øùÂ≠òÊñá‰ª∂"ÊåâÈíÆ',
        receiveFiles: 'Êé•Êî∂Êñá‰ª∂',
        aboutTitle: 'ÂÖ≥‰∫é AnyDrop',
        appDescription: '‰∏Ä‰∏™ÁÆÄÂçï„ÄÅÂø´ÈÄü„ÄÅÊó†ÈúÄÂÆâË£ÖÁöÑÂ±ÄÂüüÁΩëÊñá‰ª∂‰º†ËæìÂ∑•ÂÖ∑„ÄÇËÆ©ÊÇ®Âú®Âêå‰∏ÄÁΩëÁªú‰∏ãÁöÑËÆæÂ§áÈó¥ËΩªÊùæÂàÜ‰∫´Êñá‰ª∂„ÄÇ',
        versionInfo: 'ÁâàÊú¨‰ø°ÊÅØ',
        version: 'ÁâàÊú¨: 1.0.0',
        releaseDate: 'ÂèëÂ∏ÉÊó•Êúü: 2025Âπ¥5Êúà',
        techStack: 'ÊäÄÊúØÊ†à',
        techDescription: 'Êú¨È°πÁõÆÂü∫‰∫éWebÊäÄÊúØÊûÑÂª∫Ôºå‰ΩøÁî®Socket.ioÂÆûÁé∞ÂÆûÊó∂ÈÄö‰ø°ÔºåÊó†ÈúÄÈ¢ùÂ§ñÂÆâË£Ö‰ªª‰ΩïËΩØ‰ª∂„ÄÇ',
        openSource: 'ÂºÄÊ∫ê‰ø°ÊÅØ',
        githubRepo: 'GitHub ‰ªìÂ∫ì',
        license: 'ÂºÄÊ∫êÂçèËÆÆ: MIT License',
        contact: 'ËÅîÁ≥ª‰∏éÂèçÈ¶à',
        feedback: 'Â¶ÇÊúâÈóÆÈ¢òÊàñÂª∫ËÆÆÔºåÊ¨¢ËøéÂú®GitHubÊèê‰∫§IssueÊàñÁõ¥Êé•ËÅîÁ≥ªÂºÄÂèëËÄÖ„ÄÇ',
        helpTitle: '‰ΩøÁî®Â∏ÆÂä©',
        help1: '1. Âú®Âêå‰∏ÄÂ±ÄÂüüÁΩë‰∏ãÊâìÂºÄÊú¨È°µÈù¢Âç≥ÂèØ‰∫í‰º†Êñá‰ª∂',
        help2: '2. ÁÇπÂáª‰∏≠ÂøÉÊåâÈíÆÈÄâÊã©Ë¶Å‰º†ËæìÁöÑÊñá‰ª∂',
        help3: '3. ÁÇπÂáªÂ∫ïÈÉ®ËÆæÂ§áÂàóË°®‰∏≠ÁöÑËÆæÂ§áËøõË°åÈÄâÊã©',
        help4: '4. ÊîØÊåÅÊãñÊîæÊñá‰ª∂Âà∞‰∏≠ÂøÉÊåâÈíÆËøõË°å‰∏ä‰º†',
        help5: '5. ÊîØÊåÅÊñáÊú¨Ê∂àÊÅØÂíåÊñá‰ª∂Â§πÁöÑ‰º†Ëæì',
        gotIt: 'Áü•ÈÅì‰∫Ü',
        close: 'ÂÖ≥Èó≠',
        messageSent: 'Ê∂àÊÅØÂ∑≤ÂèëÈÄÅ',
        sendToSingleDevice: 'ÂèëÈÄÅÊ∂àÊÅØËá≥ {0}',
        sendToMultiDevices: 'ÂèëÈÄÅÊ∂àÊÅØËá≥ {0} ‰∏™ËÆæÂ§á',
        receiverDevices: 'Êé•Êî∂ËÆæÂ§áÔºö',
        messageSentMulti: 'Â∑≤Âêë {0} ‰∏™ËÆæÂ§áÂèëÈÄÅÊ∂àÊÅØ',
        receivedMessage: 'Êî∂Âà∞Ê∂àÊÅØ',
        messageFrom: 'Êù•Ëá™ {0}Ôºö',
        themeDark: 'Â∑≤ÂàáÊç¢Âà∞ÊöóËâ≤Ê®°Âºè',
        themeLight: 'Â∑≤ÂàáÊç¢Âà∞‰∫ÆËâ≤Ê®°Âºè',
        switchToEnglish: 'Switch to English',
        switchToChinese: 'Â∑≤ÂàáÊç¢Âà∞‰∏≠Êñá',
        switchTheme: 'ÂàáÊç¢‰∏ªÈ¢ò',
        about: 'ÂÖ≥‰∫é',
        help: 'Â∏ÆÂä©',
        switchLanguage: 'ÂàáÊç¢ËØ≠Ë®Ä',
        browser: 'ÊµèËßàÂô®',
        phone: 'ÊâãÊú∫',
        tablet: 'Âπ≥Êùø',
        computer: 'ÁîµËÑë',
        unknownDevice: 'Êú™Áü•ËÆæÂ§á',
        requestSendFile: 'Á≠âÂæÖÂØπÊñπÊé•ÂèóÊñá‰ª∂...',
        selectDevice: 'ÈÄâÊã©ËÆæÂ§á',
        device: 'ËÆæÂ§á', 
        files: '‰∏™Êñá‰ª∂',
        totalSize: 'ÊÄªÂ§ßÂ∞è',
        fileSize: 'Êñá‰ª∂Â§ßÂ∞è',
        receivedFile: 'Êé•Êî∂ÁöÑÊñá‰ª∂',
        completed: 'Â∑≤ÂÆåÊàê',
        failed: 'Â§±Ë¥•',
        rejected: 'Â∑≤ÊãíÁªù',
        transferCancelled: 'Â∑≤ÂèñÊ∂à',
        formatSeconds: 'Áßí',
        formatMinutes: 'ÂàÜ',
        formatHours: 'Â∞èÊó∂',
        sendingFile: 'Ê≠£Âú®ÂèëÈÄÅ',
        sending: 'ÂèëÈÄÅ‰∏≠',
      },
      en: {
        appTitle: 'AnyDrop | LAN File Transfer Tool Like Snapdrop',
        myDevice: 'My Device',
        uploadFileFolder: 'Upload Folder',
        sendText: 'Send Text',
        searching: 'Searching for nearby devices...',
        instruction: 'Devices on the same network will appear automatically. Click a device to send files.',
        multiSelect: 'Multi',
        selected: 'Selected',
        more: 'More',
        receive: 'Receive',
        reject: 'Reject',
        send: 'Send',
        cancel: 'Cancel',
        waiting: 'Waiting...',
        preparing: 'Preparing...',
        receiving: 'Receiving',
        fileSending: 'Sending {1} files to {0} devices',
        fileReceiving: 'Receiving {0}',
        fileCompleted: 'File {0} transfer completed',
        fileCancelled: 'Cancelled {0} file {1}',
        noDevices: 'No devices available',
        selectDeviceTitle: 'Select Device',
        confirm: 'Confirm',
        selectAtLeastOne: 'Please select at least one device',
        sendToDevice: 'Send file to {0}',
        sendToMultiDevices: 'Send file to {0} devices',
        receivingFromDevice: 'File from {0}:',
        saveFile: 'Save File',
        openInNewWindow: 'Open in New Window',
        deviceJoined: '{0} joined',
        selectAll: 'Select All',
        fileReceived: 'File Received',
        downloadTip: 'Tip: If download doesn\'t start automatically, click "Save File" button',
        receiveFiles: 'Receive File',
        aboutTitle: 'About AnyDrop',
        appDescription: 'A simple, fast, and installation-free LAN file transfer tool. Easily share files between devices on the same network.',
        versionInfo: 'Version Info',
        version: 'Version: 1.0.0',
        releaseDate: 'Release Date: May 2025',
        techStack: 'Technology Stack',
        techDescription: 'This project is built with web technologies, using Socket.io for real-time communication, requiring no additional software installation.',
        openSource: 'Open Source Info',
        githubRepo: 'GitHub Repository',
        license: 'License: MIT License',
        contact: 'Contact & Feedback',
        feedback: 'For issues or suggestions, please submit an issue on GitHub or contact the developer directly.',
        helpTitle: 'Usage Help',
        help1: '1. Open this page on devices within the same local network to transfer files',
        help2: '2. Click the center button to select files for transfer',
        help3: '3. Click a device in the bottom list to select it',
        help4: '4. You can also drag and drop files to the center button',
        help5: '5. Text messages and folders are also supported',
        gotIt: 'Got it',
        close: 'Close',
        messageSent: 'Message sent',
        sendToSingleDevice: 'Send message to {0}',
        sendToMultiDevices: 'Send message to {0} devices',
        receiverDevices: 'Receiving devices:',
        messageSentMulti: 'Message sent to {0} devices',
        receivedMessage: 'Message Received',
        messageFrom: 'From {0}:',
        themeDark: 'Switched to dark mode',
        themeLight: 'Switched to light mode',
        switchToEnglish: 'Switched to English',
        switchToChinese: 'Switch to Chinese',
        switchTheme: 'Switch Theme',
        about: 'About',
        help: 'Help',
        switchLanguage: 'Switch Language',
        browser: 'Browser',
        phone: 'Phone',
        tablet: 'Tablet',
        computer: 'Computer', 
        unknownDevice: 'Unknown Device',
        requestSendFile: 'Waiting for receiver to accept...',
        selectDevice: 'Select Device',
        device: 'Device',
        files: 'files',
        totalSize: 'Total size',
        fileSize: 'File size',
        receivedFile: 'Received file',
        completed: 'Completed',
        failed: 'Failed',
        rejected: 'Rejected',
        transferCancelled: 'Cancelled',
        formatSeconds: 'sec',
        formatMinutes: 'min',
        formatHours: 'hr',
        sendingFile: 'Sending',
        sending: 'Sending',
      }
    };

    // Ëé∑ÂèñÁøªËØëÊñáÊú¨
    function t(key, ...args) {
      let text = translations[currentLanguage][key] || key;
      
      // ÊõøÊç¢ÂèÇÊï∞ {0}, {1}, Á≠â
      if (args.length > 0) {
        args.forEach((arg, index) => {
          text = text.replace(`{${index}}`, arg);
        });
      }
      
      return text;
    }

    // ÂàáÊç¢ËØ≠Ë®Ä
    function switchLanguage() {
      currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
      localStorage.setItem('language', currentLanguage);
      updateUI();
      
      // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
      document.title = t('appTitle');
      
      // ÊòæÁ§∫ËØ≠Ë®ÄÂàáÊç¢ÈÄöÁü•
      showNotification(t(currentLanguage === 'zh' ? 'switchToChinese' : 'switchToEnglish'));
    }

    // Êõ¥Êñ∞UIËØ≠Ë®Ä
    function updateUI() {
      // Êõ¥Êñ∞ËÆæÂ§áÂêçÁß∞Ê†áÁ≠æ
      document.querySelector('.device-label span').textContent = t('myDevice');
      
      // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
      document.getElementById('uploadFolderBtn').innerHTML = `<i class="ri-folder-upload-line"></i> ${t('uploadFileFolder')}`;
      document.getElementById('sendTextBtn').innerHTML = `<i class="ri-message-2-line"></i> ${t('sendText')}`;
      
      // Êõ¥Êñ∞ËØ¥ÊòéÊñáÂ≠ó
      document.querySelector('.instructions').textContent = t('instruction');
      
      // Êõ¥Êñ∞Ê†áÈ¢òÊèêÁ§∫ÊñáÊú¨
      document.querySelector('[title="ÂàáÊç¢‰∏ªÈ¢ò"]').title = t('switchTheme');
      document.querySelector('[title="ÂÖ≥‰∫é"]').title = t('about');
      document.querySelector('[title="Â∏ÆÂä©"]').title = t('help');
      document.getElementById('languageToggle').title = t('switchLanguage');
      
      // Êõ¥Êñ∞ËÆæÂ§áÂàóË°®
      updateDeviceList();
      
      // Â¶ÇÊûúÊòØËã±ÊñáÊ®°ÂºèÔºåÊàñÂ±èÂπïÂÆΩÂ∫¶Â∞è‰∫é480pxÔºåÂàôË∞ÉÊï¥ÊåâÈíÆ‰∏∫Á∫µÂêëÊéíÂàó
      const actionButtons = document.querySelector('.action-buttons');
      if (currentLanguage === 'en' || window.innerWidth <= 480) {
        actionButtons.style.flexDirection = 'column';
        const actionBtns = document.querySelectorAll('.action-btn');
        actionBtns.forEach(btn => {
          btn.style.width = '100%';
        });
      } else {
        actionButtons.style.flexDirection = 'row';
        const actionBtns = document.querySelectorAll('.action-btn');
        actionBtns.forEach(btn => {
          btn.style.width = 'auto';
        });
      }
    }

    // Êñá‰ª∂Êé•Êî∂ÁÆ°ÁêÜ - ‰ΩøÁî®MapÊõø‰ª£ÂÖ®Â±ÄwindowÂèòÈáè
    const fileReceivers = new Map();

    // Ê£ÄÊü•ÂíåÂ∫îÁî®‰∏ªÈ¢òËÆæÁΩÆ
    function applyTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeToggle').innerHTML = '<i class="ri-moon-line"></i>';
        isDarkMode = true;
      } else {
        document.documentElement.removeAttribute('data-theme');
        document.getElementById('themeToggle').innerHTML = '<i class="ri-sun-line"></i>';
        isDarkMode = false;
      }
    }

    // ÂàáÊç¢‰∏ªÈ¢ò
    function toggleTheme() {
      if (isDarkMode) {
        localStorage.setItem('theme', 'light');
      } else {
        localStorage.setItem('theme', 'dark');
      }
      applyTheme();
      showNotification(t(isDarkMode ? 'themeDark' : 'themeLight'));
    }

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêé
    window.addEventListener('load', () => {
      // Â∫îÁî®‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
      applyTheme();
      
      // Âä†ËΩΩ‰øùÂ≠òÁöÑËØ≠Ë®ÄËÆæÁΩÆ
      const savedLanguage = localStorage.getItem('language');
      if (savedLanguage && (savedLanguage === 'zh' || savedLanguage === 'en')) {
        currentLanguage = savedLanguage;
        // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
        document.title = t('appTitle');
      }
      
      // Êõ¥Êñ∞UIËØ≠Ë®Ä
      updateUI();
      
      // ÈöêËóèÂä†ËΩΩÂä®Áîª
      setTimeout(() => {
        document.querySelector('.load-animation').classList.add('hidden');
      }, 800);
    });

    // ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    
    // ËØ≠Ë®ÄÂàáÊç¢ÊåâÈíÆ
    document.getElementById('languageToggle').addEventListener('click', switchLanguage);

    // ÂèëÈÄÅÂøÉË∑≥ÂåÖ
    setInterval(() => { socket.emit('heartbeat'); }, 5000);

    // Ëé∑ÂèñËÆæÂ§áÁ±ªÂûãÂíåÂõæÊ†á
    function getDeviceInfo() {
      const ua = navigator.userAgent.toLowerCase();
      let type = t('unknownDevice');
      let icon = 'ri-device-line';
      
      if (ua.includes('iphone') || ua.includes('android') && !ua.includes('tablet')) { 
        type = t('phone'); 
        icon = 'ri-smartphone-line'; 
      }
      else if (ua.includes('ipad') || ua.includes('tablet')) { 
        type = t('tablet'); 
        icon = 'ri-tablet-line'; 
      }
      else if (ua.includes('windows') || ua.includes('macintosh') || ua.includes('linux')) { 
        type = t('computer'); 
        icon = 'ri-computer-line'; 
      }
      
      return { type, icon };
    }

    // Êõ¥Êñ∞ËÆæÂ§áÂõæÊ†á
    function updateDeviceTypeIcon() {
      const deviceIcon = document.getElementById('deviceTypeIcon');
      if (deviceIcon && myDeviceInfo.icon) {
        deviceIcon.className = myDeviceInfo.icon;
      }
    }

    // ÈÄöÁü•
    function showNotification(message) {
      const notification = document.getElementById('notification');
      // Â§ÑÁêÜÂèØËÉΩËøáÈïøÁöÑÊñá‰ª∂Âêç
      if (message.includes('Êñá‰ª∂') && message.length > 30) {
        // Êü•ÊâæÊñá‰ª∂ÂêçÈÉ®ÂàÜÂπ∂Êà™Êñ≠
        const parts = message.split('Êñá‰ª∂');
        if (parts.length >= 2) {
          const prefix = parts[0] + 'Êñá‰ª∂';
          let fileName = parts[1].trim();
          if (fileName.startsWith(':')) fileName = fileName.substring(1).trim();
          
          // Â¶ÇÊûúÊñá‰ª∂ÂêçËøáÈïøÔºåÊà™Êñ≠ÂÆÉ
          if (fileName.length > 15) {
            const extension = fileName.lastIndexOf('.') > 0 ? fileName.substring(fileName.lastIndexOf('.')) : '';
            fileName = fileName.substring(0, 12) + '...' + extension;
          }
          message = prefix + ': ' + fileName;
        }
      }
      
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => { notification.classList.remove('show'); }, 3000);
    }

    // ÁîüÊàêÈªòËÆ§ËÆæÂ§áÂêçÁß∞
    function generateDeviceName() {
      const deviceType = getDeviceInfo().type;
      const randomId = Math.random().toString(36).substring(2, 7);
      return `${deviceType} ${randomId}`;
    }

    // ËÆæÂ§áÂêçÁß∞ËÆæÁΩÆ
    const deviceNameInput = document.getElementById('deviceName');
    
    // ÂàùÂßãÂåñËÆæÂ§áÂêçÁß∞
    function initDeviceName() {
      let name = localStorage.getItem('deviceName');
      if (!name) {
        name = generateDeviceName();
        localStorage.setItem('deviceName', name);
      }
      deviceNameInput.value = name;
      return name;
    }
    
    deviceNameInput.addEventListener('change', function() {
      const name = this.value.trim();
      if (name) {
        myDeviceInfo.name = name;
        localStorage.setItem('deviceName', name);
        // ÂèëÈÄÅËÆæÂ§á‰ø°ÊÅØÊõ¥Êñ∞Âà∞ÊúçÂä°Âô®Ôºå‰ΩøÂÖ∂‰ªñËÆæÂ§áÁ´ãÂç≥ÁúãÂà∞Êõ¥Êîπ
        socket.emit('device-info', { ...getDeviceInfo(), name });
        showNotification('ËÆæÂ§áÂêçÁß∞Â∑≤Êõ¥Êñ∞');
      } else {
        // Â¶ÇÊûúÂêçÁß∞‰∏∫Á©∫ÔºåÊÅ¢Â§ç‰πãÂâçÁöÑÂêçÁß∞
        this.value = myDeviceInfo.name || initDeviceName();
      }
    });
    
    deviceNameInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') this.blur();
    });
    
    document.querySelector('.edit-btn').addEventListener('click', () => {
      deviceNameInput.focus();
    });

    // Êñá‰ª∂‰∏ä‰º†
    const fileInput = document.getElementById('fileInput');
    const mainUploadBtn = document.getElementById('mainUploadBtn');
    
    mainUploadBtn.addEventListener('click', () => {
      const deviceList = Array.from(devices.keys()).filter(id => id !== myDeviceId);
      if (deviceList.length === 0) {
        showNotification('Ê≤°ÊúâÂèØÁî®ÁöÑËÆæÂ§á');
        return;
      }
      // ÂÖàÊ∏ÖÁ©∫inputÁöÑvalueÔºåÁ°Æ‰øùÁõ∏ÂêåÊñá‰ª∂ÂèØ‰ª•ÂÜçÊ¨°ÈÄâÊã©
      fileInput.value = '';
      fileInput.click();
    });
    
    mainUploadBtn.addEventListener('dragover', e => { 
      e.preventDefault(); 
      mainUploadBtn.style.transform = 'scale(1.05)';
      mainUploadBtn.style.boxShadow = 'var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15)';
    });
    
    mainUploadBtn.addEventListener('dragleave', e => { 
      mainUploadBtn.style.transform = '';
      mainUploadBtn.style.boxShadow = '';
    });
    
    mainUploadBtn.addEventListener('drop', e => {
      e.preventDefault();
      mainUploadBtn.style.transform = '';
      mainUploadBtn.style.boxShadow = '';
      handleFiles(e.dataTransfer.files);
      // Ê∏ÖÁ©∫ÊãñÊîæ‰∫ã‰ª∂Êï∞ÊçÆ
      e.dataTransfer.clearData();
    });
    
    fileInput.addEventListener('change', e => {
      debugLog('FILE-SELECT', `Áî®Êà∑ÈÄâÊã©‰∫Ü ${e.target.files?.length || 0} ‰∏™Êñá‰ª∂`);
      if (e.target.files?.length) {
        handleFiles(e.target.files);
      }
    });

    // Êñá‰ª∂Â§π‰∏ä‰º†
    const folderInput = document.getElementById('folderInput');
    document.getElementById('uploadFolderBtn').onclick = () => {
      const deviceList = Array.from(devices.keys()).filter(id => id !== myDeviceId);
      if (deviceList.length === 0) {
        showNotification('Ê≤°ÊúâÂèØÁî®ÁöÑËÆæÂ§á');
        return;
      }
      // ÂÖàÊ∏ÖÁ©∫inputÁöÑvalue
      folderInput.value = '';
      folderInput.click();
    };
    folderInput.addEventListener('change', e => {
      debugLog('FOLDER-SELECT', `Áî®Êà∑ÈÄâÊã©‰∫Ü ${e.target.files?.length || 0} ‰∏™Êñá‰ª∂`);
      if (e.target.files?.length) {
        handleFiles(e.target.files);
      }
    });

    // ÂèëÈÄÅÊñáÊú¨Ê∂àÊÅØ
    document.getElementById('sendTextBtn').addEventListener('click', () => {
      const deviceList = Array.from(devices.keys()).filter(id => id !== myDeviceId);
      if (deviceList.length === 0) {
        showNotification('Ê≤°ÊúâÂèØÁî®ÁöÑËÆæÂ§á');
        return;
      }
      
      // Â¶ÇÊûúÂ∑≤ÁªèÈÄâÊã©‰∫ÜÂ§ö‰∏™ËÆæÂ§áÔºåÁõ¥Êé•‰ΩøÁî®Ëøô‰∫õËÆæÂ§á
      if (selectedDevices.size > 0) {
        showMessageInputMulti(Array.from(selectedDevices));
      } 
      // Â¶ÇÊûúÂ∑≤ÁªèÈÄâÊã©‰∫ÜÂçï‰∏™ËÆæÂ§áÔºå‰ΩøÁî®ËØ•ËÆæÂ§á
      else if (selectedDeviceId) {
        showMessageInput(selectedDeviceId);
      } 
      // Âê¶ÂàôÊòæÁ§∫ËÆæÂ§áÈÄâÊã©
      else {
        showDeviceSelector(deviceList, (targetIds) => {
          if (targetIds.length === 1) {
            showMessageInput(targetIds[0]);
          } else if (targetIds.length > 1) {
            showMessageInputMulti(targetIds);
          }
        });
      }
    });

    // Â§ÑÁêÜÊñá‰ª∂
    function handleFiles(files) {
      if (!files || files.length === 0) return;
      
      const deviceList = Array.from(devices.keys()).filter(id => id !== myDeviceId);
      if (deviceList.length === 0) { 
        showNotification('Ê≤°ÊúâÂèØÁî®ÁöÑËÆæÂ§á'); 
        return; 
      }
      
      // Â¶ÇÊûúÂ∑≤ÁªèÈÄâÊã©‰∫ÜÂ§ö‰∏™ËÆæÂ§áÔºåÁõ¥Êé•‰ΩøÁî®Ëøô‰∫õËÆæÂ§á
      if (selectedDevices.size > 0) {
        showFileTransferConfirmMulti(files, Array.from(selectedDevices));
      } 
      // Â¶ÇÊûúÂ∑≤ÁªèÈÄâÊã©‰∫ÜÂçï‰∏™ËÆæÂ§áÔºå‰ΩøÁî®ËØ•ËÆæÂ§á
      else if (selectedDeviceId) {
        showFileTransferConfirm(files, selectedDeviceId);
      } 
      // Âê¶ÂàôÊòæÁ§∫ËÆæÂ§áÈÄâÊã©
      else {
        showDeviceSelector(deviceList, (targetIds) => {
          if (targetIds.length === 1) {
            showFileTransferConfirm(files, targetIds[0]);
          } else if (targetIds.length > 1) {
            showFileTransferConfirmMulti(files, targetIds);
          }
        });
      }
    }
    
    // ÊòæÁ§∫ËÆæÂ§áÈÄâÊã©Âô®
    function showDeviceSelector(deviceList, callback) {
      let deviceListHtml = '<div class="device-select-container">';
      
      deviceList.forEach(deviceId => {
        const device = devices.get(deviceId);
        if (!device) return;
        
        const name = device.name || `${t('device')} ${deviceId.slice(0, 6)}`;
        const icon = device.icon || 'ri-device-line';
        
        deviceListHtml += `
          <div class="device-option" data-id="${deviceId}">
            <div class="checkbox"><i class="ri-check-line"></i></div>
            <i class="${icon}"></i>
            <span>${name}</span>
          </div>
        `;
      });
      
      deviceListHtml += '</div>';
      deviceListHtml += `<span class="device-select-all">${t('selectAll')}</span>`;
      
      showModal(
        t('selectDeviceTitle'),
        deviceListHtml,
        [
          {
            text: t('confirm'),
            class: 'primary',
            action: () => {
              const selectedIds = [];
              document.querySelectorAll('.device-option .checkbox.checked').forEach(checkbox => {
                const deviceId = checkbox.parentElement.dataset.id;
                selectedIds.push(deviceId);
              });
              
              if (selectedIds.length === 0) {
                showNotification(t('selectAtLeastOne'));
                return;
              }
              
              closeModal();
              callback(selectedIds);
            }
          },
          {
            text: t('cancel'),
            class: 'secondary',
            action: closeModal
          }
        ]
      );
      
      // ËÆæÁΩÆÁÇπÂáª‰∫ã‰ª∂
      setTimeout(() => {
        const checkboxes = document.querySelectorAll('.device-option');
        checkboxes.forEach(option => {
          option.addEventListener('click', () => {
            const checkbox = option.querySelector('.checkbox');
            checkbox.classList.toggle('checked');
          });
        });
        
        const selectAllBtn = document.querySelector('.device-select-all');
        selectAllBtn.addEventListener('click', () => {
          const allChecked = document.querySelectorAll('.device-option .checkbox.checked').length === checkboxes.length;
          
          checkboxes.forEach(option => {
            const checkbox = option.querySelector('.checkbox');
            if (allChecked) {
              checkbox.classList.remove('checked');
            } else {
              checkbox.classList.add('checked');
            }
          });
        });
      }, 100);
    }
    
    // Á°ÆËÆ§Êñá‰ª∂‰º†ËæìÂà∞Âçï‰∏™ËÆæÂ§á
    function showFileTransferConfirm(files, targetId) {
      const device = devices.get(targetId);
      const deviceName = device ? device.name || `${t('device')} ${targetId.slice(0, 6)}` : `${t('device')} ${targetId.slice(0, 6)}`;
      
      let fileListHtml = '';
      if (files.length <= 3) {
        for (const file of files) {
          // Â§ÑÁêÜÈïøÊñá‰ª∂Âêç
          const fileName = truncateFileName(file.name, 20);
          fileListHtml += `<div style="text-align:left;margin:3px 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
            <i class="ri-file-line"></i> ${fileName} (${formatFileSize(file.size)})
          </div>`;
        }
      } else {
        fileListHtml = `<div>${files.length} ${t('files')}, ${t('totalSize')}: ${formatFileSize(Array.from(files).reduce((total, file) => total + file.size, 0))}</div>`;
      }
      
      showModal(
        t('sendToDevice', deviceName),
        `<div style="margin-bottom:1rem;">${fileListHtml}</div>`,
        [
          { 
            text: t('send'), 
            class: 'primary', 
            action: () => {
              for (const file of files) {
                startFileTransfer(file, targetId);
              }
              closeModal();
              
              // Ê∏ÖÈô§ËæìÂÖ•Áä∂ÊÄÅÔºåÁ°Æ‰øùÂêå‰∏ÄÊñá‰ª∂ÂèØ‰ª•ÂÜçÊ¨°ÈÄâÊã©
              fileInput.value = '';
              folderInput.value = '';
            }
          },
          { 
            text: t('cancel'), 
            class: 'secondary', 
            action: () => {
              closeModal();
              // Ê∏ÖÈô§ËæìÂÖ•Áä∂ÊÄÅ
              fileInput.value = '';
              folderInput.value = '';
            } 
          }
        ]
      );
    }
    
    // Á°ÆËÆ§Êñá‰ª∂‰º†ËæìÂà∞Â§ö‰∏™ËÆæÂ§á
    function showFileTransferConfirmMulti(files, targetIds) {
      const deviceNames = targetIds.map(id => {
        const device = devices.get(id);
        return device ? device.name || `${t('device')} ${id.slice(0, 6)}` : `${t('device')} ${id.slice(0, 6)}`;
      });
      
      let fileListHtml = '';
      if (files.length <= 3) {
        for (const file of files) {
          // Â§ÑÁêÜÈïøÊñá‰ª∂Âêç
          const fileName = truncateFileName(file.name, 20);
          fileListHtml += `<div style="text-align:left;margin:3px 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
            <i class="ri-file-line"></i> ${fileName} (${formatFileSize(file.size)})
          </div>`;
        }
      } else {
        fileListHtml = `<div>${files.length} ${t('files')}, ${t('totalSize')}: ${formatFileSize(Array.from(files).reduce((total, file) => total + file.size, 0))}</div>`;
      }
      
      showModal(
        t('sendToMultiDevices', targetIds.length),
        `
          <div style="margin-bottom:1rem;">${fileListHtml}</div>
          <div style="font-size:0.875rem;color:var(--color-text-secondary);margin-bottom:0.5rem;">${t('receiverDevices')}</div>
          <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;">
            ${deviceNames.map(name => `<span style="background:var(--color-surface);padding:2px 8px;border-radius:var(--radius-full);font-size:0.75rem;">${name}</span>`).join('')}
          </div>
        `,
        [
          { 
            text: t('send'), 
            class: 'primary', 
            action: () => {
              for (const file of files) {
                // ËÆ∞ÂΩïÂºÄÂßãÊó∂Èó¥Áî®‰∫éËÆ°ÁÆóÊÄªÈÄüÂ∫¶
                const startTime = Date.now();
                
                // ‰∏∫ÊØè‰∏™ÁõÆÊ†áËÆæÂ§áÂçïÁã¨ÂêØÂä®‰º†Ëæì
                const transferMappings = [];
                for (const targetId of targetIds) {
                  const transferId = startFileTransfer(file, targetId);
                  transferMappings.push({ targetId, transferId });
                  // Âª∫Á´ãÊò†Â∞ÑÂÖ≥Á≥ª
                  fileTransferMappings.set(transferId, targetId);
                }
                
                debugLog('MULTI-SEND', `Â§öËÆæÂ§á‰º†ËæìÂºÄÂßã`, { 
                  fileName: file.name, 
                  targetCount: targetIds.length, 
                  mappings: transferMappings 
                });
              }
              closeModal();
              showNotification(t('fileSending', targetIds.length, files.length));
              
              // Ê∏ÖÈô§ËæìÂÖ•Áä∂ÊÄÅÔºåÁ°Æ‰øùÂêå‰∏ÄÊñá‰ª∂ÂèØ‰ª•ÂÜçÊ¨°ÈÄâÊã©
              fileInput.value = '';
              folderInput.value = '';
            }
          },
          { 
            text: t('cancel'), 
            class: 'secondary', 
            action: () => {
              closeModal();
              // Ê∏ÖÈô§ËæìÂÖ•Áä∂ÊÄÅ
              fileInput.value = '';
              folderInput.value = '';
            }
          }
        ]
      );
    }

    // Ê∂àÊÅØËæìÂÖ•Âà∞Âçï‰∏™ËÆæÂ§á
    function showMessageInput(targetId) {
      const device = devices.get(targetId);
      const deviceName = device ? device.name || `ËÆæÂ§á ${targetId.slice(0, 6)}` : `ËÆæÂ§á ${targetId.slice(0, 6)}`;
      
      showModal(
        `ÂèëÈÄÅÊ∂àÊÅØËá≥ ${deviceName}`,
        `<textarea id='msgInput' style='width:100%;height:100px;border-radius:var(--radius-md);border:1px solid var(--color-border);padding:0.75rem;font-size:0.875rem;resize:none;outline:none;background:var(--color-surface);color:var(--color-text-primary);'></textarea>`,
        [
          { 
            text: 'ÂèëÈÄÅ', 
            class: 'primary', 
            action: () => {
              const msg = document.getElementById('msgInput').value.trim();
              if (msg) {
                socket.emit('send-message', { targetId, message: msg });
                showNotification('Ê∂àÊÅØÂ∑≤ÂèëÈÄÅ');
              }
              closeModal();
            }
          },
          { 
            text: 'ÂèñÊ∂à', 
            class: 'secondary', 
            action: closeModal 
          }
        ]
      );
      
      // Ëá™Âä®ËÅöÁÑ¶ÊñáÊú¨Ê°Ü
      setTimeout(() => {
        document.getElementById('msgInput').focus();
      }, 300);
    }
    
    // Ê∂àÊÅØËæìÂÖ•Âà∞Â§ö‰∏™ËÆæÂ§á
    function showMessageInputMulti(targetIds) {
      const deviceNames = targetIds.map(id => {
        const device = devices.get(id);
        return device ? device.name || `ËÆæÂ§á ${id.slice(0, 6)}` : `ËÆæÂ§á ${id.slice(0, 6)}`;
      });
      
      showModal(
        `ÂèëÈÄÅÊ∂àÊÅØËá≥ ${targetIds.length} ‰∏™ËÆæÂ§á`,
        `
          <div style="font-size:0.875rem;color:var(--color-text-secondary);margin-bottom:0.5rem;">Êé•Êî∂ËÆæÂ§áÔºö</div>
          <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;">
            ${deviceNames.map(name => `<span style="background:var(--color-surface);padding:2px 8px;border-radius:var(--radius-full);font-size:0.75rem;">${name}</span>`).join('')}
          </div>
          <textarea id='msgInput' style='width:100%;height:100px;border-radius:var(--radius-md);border:1px solid var(--color-border);padding:0.75rem;font-size:0.875rem;resize:none;outline:none;background:var(--color-surface);color:var(--color-text-primary);'></textarea>
        `,
        [
          { 
            text: 'ÂèëÈÄÅ', 
            class: 'primary', 
            action: () => {
              const msg = document.getElementById('msgInput').value.trim();
              if (msg) {
                for (const targetId of targetIds) {
                  socket.emit('send-message', { targetId, message: msg });
                }
                showNotification(`Â∑≤Âêë ${targetIds.length} ‰∏™ËÆæÂ§áÂèëÈÄÅÊ∂àÊÅØ`);
              }
              closeModal();
            }
          },
          { 
            text: 'ÂèñÊ∂à', 
            class: 'secondary', 
            action: closeModal 
          }
        ]
      );
      
      // Ëá™Âä®ËÅöÁÑ¶ÊñáÊú¨Ê°Ü
      setTimeout(() => {
        document.getElementById('msgInput').focus();
      }, 300);
    }

    // Êñá‰ª∂‰º†Ëæì
    function startFileTransfer(file, targetId) {
      // ‰ΩøÁî®Êõ¥Â§çÊùÇÁöÑÊñπÂºèÁîüÊàêÂîØ‰∏ÄIDÔºåÁ°Æ‰øùÊØèÊ¨°‰º†ËæìÁöÑIDÈÉΩ‰∏çÂêå
      const transferId = `${Date.now().toString()}-${Math.random().toString(36).substr(2, 9)}-${file.name.substring(0, 6).replace(/\s+/g, '-')}`;
      
      activeTransfers.set(transferId, { 
        file, 
        targetId, 
        progress: 0, 
        startTime: Date.now(),
        name: file.name,
        size: file.size,
        status: 'waiting' // Êñ∞Áä∂ÊÄÅÔºöÁ≠âÂæÖÊé•Êî∂ÊñπÁ°ÆËÆ§
      });
      
      debugLog('SEND', `ËØ∑Ê±Ç‰º†ËæìÊñá‰ª∂ ${file.name} Âà∞ ${targetId}`, {
        transferId,
        fileSize: file.size
      });
      
      // Ê∑ªÂä†Âà∞Êò†Â∞ÑË°®
      fileTransferMappings.set(transferId, targetId);
      
      // ÂèëÈÄÅ‰º†ËæìËØ∑Ê±ÇÔºåÁ≠âÂæÖÁ°ÆËÆ§
      socket.emit('file-transfer-request', { 
        targetId, 
        fileName: file.name, 
        fileSize: file.size, 
        transferId 
      });
      
      // ÊòæÁ§∫Á≠âÂæÖÊé•Êî∂ÊñπÁ°ÆËÆ§ÁöÑËøõÂ∫¶UI
      showTransferWaitingUI(transferId);
      
      showNotification(t('requestSendFile'));
      
      return transferId;
    }

    // ÊòæÁ§∫Á≠âÂæÖÊé•Êî∂ÊñπÁ°ÆËÆ§ÁöÑUI
    function showTransferWaitingUI(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) return;
      
      debugLog('UI', 'ÊòæÁ§∫Á≠âÂæÖÁ°ÆËÆ§UI', { transferId });
      
      // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
      if (document.getElementById(`send-${transferId}`)) return;
      
      // ÂáÜÂ§áÊòæÁ§∫ÂêçÁß∞ÔºåÈÅøÂÖçËøáÈïø
      const fileName = transfer.name.length > 15 ? 
        transfer.name.substring(0, 12) + '...' + 
        transfer.name.substring(transfer.name.lastIndexOf('.')) : 
        transfer.name;
      
      // ÂàõÂª∫Á≠âÂæÖUIÂÖÉÁ¥†
      const waitingElement = document.createElement('div');
      waitingElement.id = `send-${transferId}`;
      waitingElement.className = 'transfer-progress-container';
      waitingElement.style.position = 'fixed';
      waitingElement.style.top = '70px';
      waitingElement.style.right = '1rem';
      waitingElement.style.background = 'var(--color-background)';
      waitingElement.style.borderRadius = 'var(--radius-lg)';
      waitingElement.style.padding = '0.75rem 1rem';
      waitingElement.style.boxShadow = 'var(--shadow-md)';
      waitingElement.style.width = '280px';
      waitingElement.style.zIndex = '100';
      
      waitingElement.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
          <div style="font-size:0.875rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px;">
            <i class="ri-upload-line"></i> ${fileName}
          </div>
          <div style="font-size:0.75rem;color:var(--color-text-tertiary);" class="transfer-size">
            ${formatFileSize(transfer.size)}
          </div>
        </div>
        <div class="transfer-progress">
          <div class="progress-bar progress-bar-waiting" style="width:100%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--color-text-tertiary);margin-top:0.25rem;">
          <span class="progress-text">Á≠âÂæÖÁ°ÆËÆ§...</span>
          <button class="cancel-transfer" title="ÂèñÊ∂à" style="background:none;border:none;color:var(--color-text-tertiary);cursor:pointer;padding:0;">
            <i class="ri-close-line"></i>
          </button>
        </div>
      `;
      
      document.body.appendChild(waitingElement);
      
      // Ê∑ªÂä†CSSÊ†∑Âºè
      if (!document.getElementById('transfer-waiting-style')) {
        const styleElement = document.createElement('style');
        styleElement.id = 'transfer-waiting-style';
        styleElement.textContent = `
          .progress-bar-waiting {
            background: #999;
            animation: progress-waiting 1.5s ease-in-out infinite;
            background-image: linear-gradient(
              -45deg,
              rgba(255, 255, 255, 0.2) 25%,
              transparent 25%,
              transparent 50%,
              rgba(255, 255, 255, 0.2) 50%,
              rgba(255, 255, 255, 0.2) 75%,
              transparent 75%,
              transparent
            );
            background-size: 50px 50px;
          }
          
          @keyframes progress-waiting {
            0% {
              background-position: 0 0;
            }
            100% {
              background-position: 50px 50px;
            }
          }
        `;
        document.head.appendChild(styleElement);
      }
      
      // Ê∑ªÂä†ÂèñÊ∂àÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
      const cancelButton = waitingElement.querySelector('.cancel-transfer');
      if (cancelButton) {
        cancelButton.addEventListener('click', () => {
          cancelTransfer(transferId);
        });
      }
    }

    // ÊòæÁ§∫‰º†ËæìË¢´ÊãíÁªùÁöÑUI
    function showTransferRejectedUI(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) return;
      
      transfer.status = 'rejected';
      activeTransfers.set(transferId, transfer);
      
      // Êõ¥Êñ∞UI
      updateTransferProgress(transferId);
    }

    // ÂçïÁã¨ÁöÑÂèëÈÄÅÊñá‰ª∂Êï∞ÊçÆÂáΩÊï∞
    function sendFileData(file, targetId, transferId) {
      const chunkSize = 64 * 1024; // 64KB
      let offset = 0;
      let lastUpdateTime = Date.now();
      
      function readNextChunk() {
        const transfer = activeTransfers.get(transferId);
        if (!transfer || transfer.status !== 'active') {
          debugLog('SEND', `‰º†Ëæì ${transferId} Â∑≤ÂÅúÊ≠¢ÊàñÂèñÊ∂à`);
          return; // Â¶ÇÊûú‰º†ËæìÂ∑≤ÂèñÊ∂àÊàñÂÆåÊàêÔºåÂÅúÊ≠¢Â§ÑÁêÜ
        }
        
        const chunk = file.slice(offset, offset + chunkSize);
        const reader = new FileReader();
        
        reader.onload = (e) => {
          // ÂÜçÊ¨°Ê£ÄÊü•‰º†ËæìÁä∂ÊÄÅ
          const transfer = activeTransfers.get(transferId);
          if (!transfer || transfer.status !== 'active') {
            return; // Â¶ÇÊûú‰º†ËæìÂ∑≤ÂèñÊ∂àÊàñÂÆåÊàêÔºåÂÅúÊ≠¢Â§ÑÁêÜ
          }
          
          debugLog('SEND', `ÂèëÈÄÅÊï∞ÊçÆÂùó ${Math.round((offset / file.size) * 100)}%`, {
            transferId,
            offset,
            chunkSize: chunk.size
          });
          
          socket.emit('file-data', { 
            targetId, 
            chunk: e.target.result, 
            offset, 
            totalSize: file.size, 
            transferId, 
            fileName: file.name 
          });
          
          offset += chunk.size;
          
          // Êõ¥Êñ∞ËøõÂ∫¶
          if (transfer) {
            const now = Date.now();
            transfer.progress = (offset / file.size) * 100;
            
            // ËÆ°ÁÆóÈÄüÂ∫¶ÔºàÊØè 500ms Êõ¥Êñ∞‰∏ÄÊ¨°Ôºâ
            if (now - lastUpdateTime > 500) {
              const elapsedTime = (now - transfer.startTime) / 1000; // Áßí
              if (elapsedTime > 0) {
                transfer.speed = offset / elapsedTime; // Â≠óËäÇ/Áßí
              }
              lastUpdateTime = now;
              updateTransferProgress(transferId);
            }
            
            activeTransfers.set(transferId, transfer);
          }
          
          if (offset < file.size) {
            // ‰ΩøÁî®setTimeoutÊ∑ªÂä†Â∞èÂª∂ËøüÔºåÈÅøÂÖçÁü≠Êó∂Èó¥ÂÜÖÂèëÈÄÅËøáÂ§öÊï∞ÊçÆ
            setTimeout(readNextChunk, 10);
          } else {
            // ‰º†ËæìÂÆåÊàê
            debugLog('SEND', `Êñá‰ª∂ ${file.name} ‰º†ËæìÂÆåÊàê`);
            const transfer = activeTransfers.get(transferId);
            if (transfer) {
              transfer.progress = 100;
              transfer.status = 'completed';
              activeTransfers.set(transferId, transfer);
              updateTransferProgress(transferId);
            }
            showNotification(`Êñá‰ª∂ ${file.name} ‰º†ËæìÂÆåÊàê`);
            
            // Âá†ÁßíÂêéÁßªÈô§ËøõÂ∫¶Êù°
            setTimeout(() => {
              document.getElementById(`send-${transferId}`)?.remove();
            }, 3000);
          }
        };
        
        reader.onerror = (err) => {
          debugLog('SEND ERROR', `ËØªÂèñÊñá‰ª∂ÂùóÂá∫Èîô: ${err}`);
          const transfer = activeTransfers.get(transferId);
          if (transfer) {
            transfer.status = 'failed';
            activeTransfers.set(transferId, transfer);
            updateTransferProgress(transferId);
            showNotification(`Êñá‰ª∂ ${file.name} ‰º†ËæìÂ§±Ë¥•`);
          }
        };
        
        reader.readAsArrayBuffer(chunk);
      }
      
      readNextChunk();
    }

    // ÂèñÊ∂àÊñá‰ª∂‰º†Ëæì
    function cancelTransfer(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) return;
      
      debugLog('CANCEL', `ÂèñÊ∂àÊñá‰ª∂‰º†Ëæì`, { transferId, status: transfer.status });
      
      // Êõ¥Êñ∞Áä∂ÊÄÅ
      transfer.status = 'cancelled';
      activeTransfers.set(transferId, transfer);
      
      // ÈÄöÁü•ÂØπÊñπ‰º†ËæìÂ∑≤ÂèñÊ∂à
      if (transfer.targetId) {
        socket.emit('cancel-transfer', {
          targetId: transfer.targetId,
          transferId
        });
      }
      
      // Êõ¥Êñ∞UI
      updateTransferProgress(transferId);
      
      // ÊòæÁ§∫ÈÄöÁü•
      const actionText = transfer.targetId ? 'ÂèëÈÄÅ' : 'Êé•Êî∂';
      showNotification(`Â∑≤ÂèñÊ∂à${actionText}Êñá‰ª∂ ${transfer.name}`);
      
      // ‰∏ÄÊÆµÊó∂Èó¥ÂêéÁßªÈô§UI
      setTimeout(() => {
        const element = document.getElementById(`send-${transferId}`);
        if (element) {
          element.style.opacity = '0';
          element.style.transition = 'opacity 0.5s ease';
          setTimeout(() => element.remove(), 500);
        }
      }, 3000);
    }
    
    // ÊòæÁ§∫‰º†ËæìËøõÂ∫¶
    function showTransferProgress(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) {
        debugLog('ERROR', 'Êó†Ê≥ïÊòæÁ§∫ËøõÂ∫¶ÔºöÊâæ‰∏çÂà∞transferId', { transferId });
        return;
      }
      
      // Ê∏ÖÈô§Áé∞ÊúâÁöÑËøõÂ∫¶UIÔºàÂ¶ÇÊûúÊúâÔºâ
      const existingUI = document.getElementById(`send-${transferId}`);
      if (existingUI) existingUI.remove();
      
      debugLog('UI', 'ÂàõÂª∫Êñá‰ª∂‰º†ËæìËøõÂ∫¶UI', { transferId, status: transfer.status });
      
      // ÂáÜÂ§áÊòæÁ§∫ÂêçÁß∞ÔºåÈÅøÂÖçËøáÈïø
      const fileName = transfer.name.length > 15 ? 
        transfer.name.substring(0, 12) + '...' + 
        transfer.name.substring(transfer.name.lastIndexOf('.')) : 
        transfer.name;
      
      // ÂàõÂª∫ËøõÂ∫¶Êù°ÂÖÉÁ¥†
      const progressElement = document.createElement('div');
      progressElement.id = `send-${transferId}`;
      progressElement.className = 'transfer-progress-container';
      progressElement.style.position = 'fixed';
      progressElement.style.top = '70px';
      progressElement.style.right = '1rem';
      progressElement.style.background = 'var(--color-background)';
      progressElement.style.borderRadius = 'var(--radius-lg)';
      progressElement.style.padding = '0.75rem 1rem';
      progressElement.style.boxShadow = 'var(--shadow-md)';
      progressElement.style.width = '280px';
      progressElement.style.zIndex = '100';
      
      progressElement.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
          <div style="font-size:0.875rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px;">
            <i class="ri-upload-line"></i> ${fileName}
          </div>
          <div style="font-size:0.75rem;color:var(--color-text-tertiary);" class="transfer-size">
            ${formatFileSize(transfer.size)}
          </div>
        </div>
        <div class="transfer-progress">
          <div class="progress-bar" style="width:0%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--color-text-tertiary);margin-top:0.25rem;">
          <div>
            <span class="progress-text">0%</span>
            <span class="progress-speed">ÂáÜÂ§á‰∏≠...</span>
          </div>
          <button class="cancel-transfer" title="ÂèñÊ∂à" style="background:none;border:none;color:var(--color-text-tertiary);cursor:pointer;padding:0;">
            <i class="ri-close-line"></i>
          </button>
        </div>
      `;
      
      document.body.appendChild(progressElement);
      
      // Ê∑ªÂä†ÂèñÊ∂àÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
      const cancelButton = progressElement.querySelector('.cancel-transfer');
      if (cancelButton) {
        cancelButton.addEventListener('click', () => {
          cancelTransfer(transferId);
        });
      }
      
      // ÂàùÂßãÊõ¥Êñ∞
      updateTransferProgress(transferId);
    }
    
    // Êõ¥Êñ∞‰º†ËæìËøõÂ∫¶
    function updateTransferProgress(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) return;
      
      const progressContainer = document.getElementById(`send-${transferId}`);
      if (!progressContainer) {
        // Â¶ÇÊûúÂÆπÂô®‰∏çÂ≠òÂú®ÔºåÂÖàÂàõÂª∫ÂÆÉ
        showTransferProgress(transferId);
        return;
      }
      
      const progressBar = progressContainer.querySelector('.progress-bar');
      const progressText = progressContainer.querySelector('.progress-text');
      const speedText = progressContainer.querySelector('.progress-speed');
      const cancelButton = progressContainer.querySelector('.cancel-transfer');
      
      // Ê£ÄÊü•ÊâÄÊúâÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
      if (!progressBar || !progressText) {
        debugLog('ERROR', 'ËøõÂ∫¶UIÂÖÉÁ¥†‰∏çÂÆåÊï¥ÔºåÈáçÊñ∞ÂàõÂª∫', { transferId });
        progressContainer.remove();
        showTransferProgress(transferId);
        return;
      }
      
      // Ê†πÊçÆ‰º†ËæìÁä∂ÊÄÅÊõ¥Êñ∞UI
      switch (transfer.status) {
        case 'active':
          progressBar.style.width = `${transfer.progress}%`;
          progressText.textContent = `${Math.round(transfer.progress)}%`;
          
          if (transfer.speed) {
            speedText.textContent = `${formatFileSize(transfer.speed)}/s`;
          } else {
            speedText.textContent = `${t('preparing')}`;
          }
          
          if (cancelButton) cancelButton.style.display = 'block';
          break;
          
        case 'completed':
          progressBar.style.width = '100%';
          progressText.textContent = '100%';
          speedText.textContent = t('completed');
          if (cancelButton) cancelButton.style.display = 'none';
          
          // Âá†ÁßíÂêéÁßªÈô§UI
          setTimeout(() => {
            progressContainer.remove();
          }, 3000);
          break;
          
        case 'cancelled':
          progressBar.style.width = `${transfer.progress}%`;
          progressBar.style.background = 'var(--color-text-tertiary)';
          progressText.textContent = t('transferCancelled');
          speedText.textContent = '';
          if (cancelButton) cancelButton.style.display = 'none';
          
          // Âá†ÁßíÂêéÁßªÈô§UI
          setTimeout(() => {
            progressContainer.remove();
          }, 3000);
          break;
          
        case 'failed':
          progressBar.style.width = `${transfer.progress}%`;
          progressBar.style.background = '#EF4444';
          progressText.textContent = t('failed');
          speedText.textContent = '';
          if (cancelButton) cancelButton.style.display = 'none';
          
          // Âá†ÁßíÂêéÁßªÈô§UI
          setTimeout(() => {
            progressContainer.remove();
          }, 3000);
          break;
          
        case 'rejected':
          progressBar.style.width = '100%';
          progressBar.style.background = '#EF4444';
          progressText.textContent = t('rejected');
          speedText.textContent = '';
          if (cancelButton) cancelButton.style.display = 'none';
          
          // Âá†ÁßíÂêéÁßªÈô§UI
          setTimeout(() => {
            progressContainer.remove();
          }, 3000);
          break;
      }
    }

    // Êñá‰ª∂Êé•Êî∂ - ÂÆåÂÖ®ÈáçÂÜô
    function handleFileReceive(data) {
      const sender = devices.get(data.fromId);
      const senderName = sender ? sender.name || `${t('device')} ${data.fromId.slice(0, 6)}` : `${t('device')} ${data.fromId.slice(0, 6)}`;
      const transferId = data.transferId || `receive-${Date.now()}`;
      
      // Â§ÑÁêÜÈïøÊñá‰ª∂Âêç
      const fileName = truncateFileName(data.fileName, 25);
      
      debugLog('RECEIVE', 'Êî∂Âà∞Êñá‰ª∂‰º†ËæìËØ∑Ê±Ç', { 
        fromId: data.fromId, 
        fileName: data.fileName, 
        fileSize: data.fileSize,
        transferId: transferId
      });
      
      showModal(
        t('receiveFiles'),
        `<div style="margin-bottom:1rem;">
          <div style="margin-bottom:0.5rem;font-weight:500;">${t('receivingFromDevice', senderName)}</div>
          <div style="display:flex;align-items:center;gap:0.5rem;border-radius:var(--radius-md);background:var(--color-surface);padding:0.75rem;">
            <i class="ri-file-line" style="font-size:1.5rem;color:var(--color-primary);"></i>
            <div style="max-width:calc(100% - 2.5rem);overflow:hidden;">
              <div style="font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${fileName}</div>
              <div style="font-size:0.75rem;color:var(--color-text-tertiary);">${formatFileSize(data.fileSize)}</div>
            </div>
          </div>
        </div>`,
        [
          { 
            text: t('receive'), 
            class: 'primary', 
            action: () => { 
              debugLog('RECEIVE', 'Áî®Êà∑Êé•ÂèóÊñá‰ª∂‰º†Ëæì');
              
              // 1. ÂèëÈÄÅÊé•ÂèóÂìçÂ∫îÁªôÂèëÈÄÅÊñπ
              socket.emit('file-transfer-response', {
                targetId: data.fromId,
                transferId: transferId,
                accepted: true
              });
              
              // 2. ÂàõÂª∫Êé•Êî∂Áä∂ÊÄÅ
              fileReceivers.set(transferId, {
                fileName: data.fileName,
                fileSize: data.fileSize,
                chunks: [],
                receivedSize: 0,
                active: true,
                startTime: Date.now()
              });
              
              // 3. ÊòæÁ§∫Êé•Êî∂ËøõÂ∫¶UI
              createReceiveProgressUI(transferId, data.fileName, data.fileSize);
              
              showNotification(t('fileReceiving', data.fileName));
              closeModal(); 
            } 
          },
          { 
            text: t('reject'), 
            class: 'secondary', 
            action: () => { 
              debugLog('RECEIVE', 'Áî®Êà∑ÊãíÁªùÊñá‰ª∂‰º†Ëæì');
              
              // ÂèëÈÄÅÊãíÁªùÂìçÂ∫îÁªôÂèëÈÄÅÊñπ
              socket.emit('file-transfer-response', {
                targetId: data.fromId,
                transferId: transferId,
                accepted: false
              });
              
              closeModal(); 
            }
          }
        ]
      );
    }
    
    // ÂàõÂª∫Êñá‰ª∂Êé•Êî∂ËøõÂ∫¶UI
    function createReceiveProgressUI(transferId, fileName, fileSize) {
      const containerId = `receive-${transferId}`;
      
      // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
      if (document.getElementById(containerId)) return;
      
      // Â§ÑÁêÜÈïøÊñá‰ª∂Âêç
      const truncatedFileName = truncateFileName(fileName, 20);
      
      const container = document.createElement('div');
      container.id = containerId;
      container.className = 'transfer-progress-container';
      container.style.position = 'fixed';
      container.style.bottom = '70px';
      container.style.left = '50%';
      container.style.transform = 'translateX(-50%)';
      container.style.background = 'var(--color-background)';
      container.style.borderRadius = 'var(--radius-lg)';
      container.style.padding = '0.75rem 1rem';
      container.style.boxShadow = 'var(--shadow-md)';
      container.style.width = '280px';
      container.style.zIndex = '50';
      
      container.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
          <div style="font-size:0.875rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px;">
            ${t('receiving')}: ${truncatedFileName}
          </div>
          <div style="font-size:0.75rem;color:var(--color-text-tertiary);" class="transfer-size">
            ${formatFileSize(fileSize)}
          </div>
        </div>
        <div class="transfer-progress">
          <div class="progress-bar" style="width:0%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--color-text-tertiary);margin-top:0.25rem;">
          <span class="progress-text">0%</span>
          <span class="progress-speed">${t('receiving')}...</span>
        </div>
      `;
      
      document.body.appendChild(container);
      debugLog('UI', 'ÂàõÂª∫Êé•Êî∂ËøõÂ∫¶UI');
    }
    
    // Êõ¥Êñ∞Êé•Êî∂ËøõÂ∫¶UI
    function updateReceiveProgressUI(transferId, progress, status = 'active') {
      const container = document.getElementById(`receive-${transferId}`);
      if (!container) return;
      
      const progressBar = container.querySelector('.progress-bar');
      const progressText = container.querySelector('.progress-text');
      const speedText = container.querySelector('.progress-speed');
      
      // Á°Æ‰øùËøõÂ∫¶‰∏çË∂ÖËøá100%
      progress = Math.min(100, progress);
      
      switch (status) {
        case 'active':
          progressBar.style.width = `${progress}%`;
          progressText.textContent = `${Math.round(progress)}%`;
          break;
          
        case 'completed':
          progressBar.style.width = '100%';
          progressText.textContent = '100%';
          speedText.textContent = t('completed');
          
          // Âá†ÁßíÂêéÁßªÈô§UI
          setTimeout(() => {
            container.remove();
          }, 3000);
          break;
          
        case 'failed':
          progressBar.style.width = `${progress}%`;
          progressBar.style.background = '#EF4444';
          progressText.textContent = t('failed');
          speedText.textContent = '';
          
          // Âá†ÁßíÂêéÁßªÈô§UI
          setTimeout(() => {
            container.remove();
          }, 3000);
          break;
      }
    }
    
    // ÈáçÂÜôÊñá‰ª∂Êï∞ÊçÆÊé•Êî∂Â§ÑÁêÜ
    socket.on('file-data', (data) => {
      try {
        const transferId = data.transferId || 'default';
        
        debugLog('FILE-DATA', 'Êî∂Âà∞Êñá‰ª∂Êï∞ÊçÆ', { 
          transferId,
          chunkType: data.chunk ? (typeof data.chunk) : 'Êú™Áü•',
          chunkConstructor: data.chunk ? (data.chunk.constructor ? data.chunk.constructor.name : 'Êú™Áü•') : 'Êú™Áü•',
          offset: data.offset,
          totalSize: data.totalSize
        });
        
        // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®Êé•Êî∂Áä∂ÊÄÅ
        if (!fileReceivers.has(transferId)) {
          debugLog('FILE-DATA', 'Êú™ÊâæÂà∞Êé•Êî∂Áä∂ÊÄÅÔºåÂøΩÁï•Êï∞ÊçÆ');
          return;
        }
        
        const receiver = fileReceivers.get(transferId);
        
        // Ê£ÄÊü•ÊòØÂê¶Â§Ñ‰∫éÊ¥ªÂä®Áä∂ÊÄÅ
        if (!receiver.active) {
          debugLog('FILE-DATA', 'Êé•Êî∂Â∑≤ÂÅúÊ≠¢ÔºåÂøΩÁï•Êï∞ÊçÆ');
          return;
        }
        
        // Â§ÑÁêÜÊï∞ÊçÆÂùó
        let chunk = data.chunk;
        let chunkSize = 0;
        
        // Â∞ùËØïÁ°ÆÂÆöÊï∞ÊçÆÂ§ßÂ∞è
        if (chunk.byteLength !== undefined) {
          chunkSize = chunk.byteLength;
        } else if (chunk.length !== undefined) {
          chunkSize = chunk.length;
        } else {
          debugLog('FILE-DATA', 'Êó†Ê≥ïÁ°ÆÂÆöÊï∞ÊçÆÂùóÂ§ßÂ∞èÔºå‰ΩøÁî®‰º∞ÁÆóÂÄº');
          chunkSize = 1024; // ‰º∞ÁÆóÂÄº
        }
        
        // Ê∑ªÂä†Êï∞ÊçÆÂùó
        receiver.chunks.push(chunk);
        receiver.receivedSize += chunkSize;
        
        // ËÆ°ÁÆóËøõÂ∫¶
        const progress = (receiver.receivedSize / receiver.fileSize) * 100;
        
        // Êõ¥Êñ∞UIËøõÂ∫¶
        updateReceiveProgressUI(transferId, progress);
        
        // Ê£ÄÊü•ÊòØÂê¶Êé•Êî∂ÂÆåÊàêÔºàÂÖÅËÆ∏1KBËØØÂ∑ÆÔºâ
        if (Math.abs(receiver.receivedSize - receiver.fileSize) <= 1024) {
          debugLog('FILE-DATA', 'Êñá‰ª∂Êé•Êî∂ÂÆåÊàê', {
            fileName: receiver.fileName,
            receivedSize: receiver.receivedSize,
            fileSize: receiver.fileSize
          });
          
          // Êõ¥Êñ∞UI‰∏∫ÂÆåÊàêÁä∂ÊÄÅ
          updateReceiveProgressUI(transferId, 100, 'completed');
          
          // ‰øùÂ≠òÊñá‰ª∂
          saveReceivedFile(transferId);
        }
      } catch (error) {
        debugLog('FILE-DATA ERROR', 'Â§ÑÁêÜÊñá‰ª∂Êï∞ÊçÆÂá∫Èîô', error);
        console.error('Â§ÑÁêÜÊñá‰ª∂Êï∞ÊçÆÂá∫Èîô:', error);
        showNotification('Êñá‰ª∂Êé•Êî∂Â§±Ë¥•: ' + error.message);
      }
    });
    
    // ‰øùÂ≠òÊé•Êî∂Âà∞ÁöÑÊñá‰ª∂
    function saveReceivedFile(transferId) {
      try {
        const receiver = fileReceivers.get(transferId);
        if (!receiver || !receiver.chunks || receiver.chunks.length === 0) {
          throw new Error('Ê≤°ÊúâÊúâÊïàÁöÑÊñá‰ª∂Êï∞ÊçÆ');
        }
        
        debugLog('SAVE', 'ÂáÜÂ§á‰øùÂ≠òÊñá‰ª∂', {
          fileName: receiver.fileName,
          chunksCount: receiver.chunks.length,
          totalSize: receiver.receivedSize
        });
        
        // ÂàõÂª∫BlobÂØπË±°
        const blob = new Blob(receiver.chunks, { type: getMimeType(receiver.fileName.split('.').pop().toLowerCase()) });
        debugLog('SAVE', 'BlobÂàõÂª∫ÊàêÂäü', { size: blob.size });
        
        // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
        const url = URL.createObjectURL(blob);
        debugLog('SAVE', 'URLÂàõÂª∫ÊàêÂäü');
        
        // ÊòæÁ§∫‰øùÂ≠òÂØπËØùÊ°Ü
        showSaveFileDialog(url, receiver.fileName, blob.size, transferId);
        
        // Ê†áËÆ∞Êé•Êî∂ÂÆåÊàê
        receiver.active = false;
        
      } catch (error) {
        debugLog('SAVE ERROR', '‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•', error);
        console.error('‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•:', error);
        showNotification('‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•: ' + error.message);
      }
    }
    
    // ‰øÆÊîπ‰øùÂ≠òÊñá‰ª∂ÂØπËØùÊ°ÜÂáΩÊï∞ÔºåÊ∑ªÂä†transferIdÂèÇÊï∞
    function showSaveFileDialog(url, fileName, fileSize, transferId) {
      // Ê£ÄÊµãÊñá‰ª∂Á±ªÂûã
      const fileExt = fileName.split('.').pop().toLowerCase();
      
      // Êà™Êñ≠Êñá‰ª∂Âêç‰ª•ÈÅøÂÖçÊ∫¢Âá∫
      const truncatedFileName = truncateFileName(fileName, 25);
      
      // Ëé∑ÂèñMIMEÁ±ªÂûã
      const mimeType = getMimeType(fileExt);
      const isPreviewable = isFilePreviewable(fileExt, mimeType);
      
      debugLog('SAVE', 'ÂáÜÂ§áÊòæÁ§∫Êñá‰ª∂‰øùÂ≠òÂØπËØùÊ°Ü', { 
        fileName, 
        fileSize, 
        fileExt, 
        mimeType, 
        isPreviewable,
        transferId
      });
      
      let previewHtml = '';
      if (isPreviewable) {
        if (mimeType.startsWith('image/')) {
          previewHtml = `<img src="${url}" style="max-width:100%;max-height:200px;margin-bottom:1rem;border-radius:var(--radius-md);" />`;
        } else if (mimeType.startsWith('video/')) {
          previewHtml = `<video src="${url}" controls style="max-width:100%;max-height:200px;margin-bottom:1rem;border-radius:var(--radius-md);"></video>`;
        } else if (mimeType.startsWith('audio/')) {
          previewHtml = `<audio src="${url}" controls style="width:100%;margin-bottom:1rem;"></audio>`;
        }
      }
      
      showModal(
        t('fileReceived'),
        `
        <div style="text-align:center;margin-bottom:1rem;">
          ${previewHtml}
          <div style="font-size:1.2rem;font-weight:500;margin-bottom:0.5rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
            ${truncatedFileName || t('receivedFile')}
          </div>
          <div style="font-size:0.9rem;color:var(--color-text-secondary);">
            ${t('fileSize')}: ${formatFileSize(fileSize)}
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:0.75rem;">
          <a id="saveFileBtn" href="${url}" download="${fileName}" style="text-decoration:none;text-align:center;width:100%;padding:0.75rem;border-radius:var(--radius-md);background:var(--color-primary);color:white;font-weight:500;border:none;cursor:pointer;">
            ${t('saveFile')}
          </a>
          <button id="openFileBtn" data-transfer-id="${transferId}" style="width:100%;padding:0.75rem;border-radius:var(--radius-md);background:var(--color-surface);color:var(--color-text-primary);font-weight:500;border:1px solid var(--color-border);cursor:pointer;">
            ${t('openInNewWindow')}
          </button>
        </div>
        <div style="margin-top:1rem;font-size:0.8rem;color:var(--color-text-tertiary);text-align:center;">
          ${t('downloadTip')}
        </div>
        `,
        [{ text: t('close'), class: 'secondary', action: () => {
          // Âª∂ËøüÈáäÊîæURLÔºåÁ°Æ‰øùÊúâË∂≥Â§üÊó∂Èó¥‰∏ãËΩΩ
          setTimeout(() => {
            URL.revokeObjectURL(url);
            debugLog('SAVE', 'URLÂ∑≤ÈáäÊîæ');
          }, 5000);
          closeModal();
        }}]
      );
      
      // ËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂
      setTimeout(() => {
        document.getElementById('saveFileBtn').addEventListener('click', () => {
          debugLog('SAVE', 'Áî®Êà∑ÁÇπÂáª‰øùÂ≠òÊñá‰ª∂ÊåâÈíÆ');
          showNotification('Êñá‰ª∂ÂºÄÂßã‰∏ãËΩΩ');
        });
        
        document.getElementById('openFileBtn').addEventListener('click', (e) => {
          debugLog('SAVE', 'Áî®Êà∑ÁÇπÂáªÂú®Êñ∞Á™óÂè£ÊâìÂºÄÊåâÈíÆ');
          
          // Ëé∑ÂèñtransferId
          const openTransferId = e.currentTarget.dataset.transferId || transferId;
          const receiver = fileReceivers.get(openTransferId);
          
          if (!receiver || !receiver.chunks) {
            showNotification('Êó†Ê≥ïÊâìÂºÄÊñá‰ª∂ÔºöÊï∞ÊçÆÂ∑≤‰∏¢Â§±');
            return;
          }
          
          // ÂàõÂª∫‰∏Ä‰∏™Â∏¶ÊúâÊ≠£Á°ÆMIMEÁ±ªÂûãÁöÑÊñ∞URL
          const blob = new Blob(receiver.chunks, { type: mimeType });
          const typedUrl = URL.createObjectURL(blob);
          
          window.open(typedUrl, '_blank');
          
          // Âú®ÈÄÇÂΩìÁöÑÊó∂ÂÄôÈáäÊîæËøô‰∏™URL
          setTimeout(() => URL.revokeObjectURL(typedUrl), 30000);
        });
        
        // ÈùûÁßªÂä®ËÆæÂ§áËá™Âä®Ëß¶Âèë‰∏ãËΩΩ
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (!isPreviewable && !isMobile) {
          debugLog('SAVE', 'ÈùûÁßªÂä®ËÆæÂ§áÔºåËá™Âä®Ëß¶Âèë‰∏ãËΩΩ');
          document.getElementById('saveFileBtn').click();
        }
      }, 100);
    }

    // Ëé∑ÂèñÊñá‰ª∂MIMEÁ±ªÂûã
    function getMimeType(fileExt) {
      const mimeTypes = {
        // ÂõæÁâá
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'png': 'image/png',
        'gif': 'image/gif',
        'webp': 'image/webp',
        'svg': 'image/svg+xml',
        'ico': 'image/x-icon',
        
        // ÊñáÊ°£
        'pdf': 'application/pdf',
        'doc': 'application/msword',
        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'xls': 'application/vnd.ms-excel',
        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'ppt': 'application/vnd.ms-powerpoint',
        'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'txt': 'text/plain',
        'csv': 'text/csv',
        'json': 'application/json',
        'xml': 'application/xml',
        'html': 'text/html',
        'htm': 'text/html',
        'css': 'text/css',
        'js': 'text/javascript',
        
        // Èü≥ËßÜÈ¢ë
        'mp3': 'audio/mpeg',
        'wav': 'audio/wav',
        'mp4': 'video/mp4',
        'webm': 'video/webm',
        'ogg': 'audio/ogg',
        'ogv': 'video/ogg',
        'm4a': 'audio/mp4',
        
        // ÂéãÁº©Êñá‰ª∂
        'zip': 'application/zip',
        'rar': 'application/x-rar-compressed',
        '7z': 'application/x-7z-compressed',
        'gz': 'application/gzip',
        'tar': 'application/x-tar',
        
        // ÂÖ∂‰ªñÂ∏∏ËßÅÊ†ºÂºè
        'apk': 'application/vnd.android.package-archive',
        'exe': 'application/x-msdownload',
        'dmg': 'application/x-apple-diskimage'
      };
      
      return mimeTypes[fileExt] || 'application/octet-stream';
    }

    // Âà§Êñ≠Êñá‰ª∂ÊòØÂê¶ÂèØÈ¢ÑËßà
    function isFilePreviewable(fileExt, mimeType) {
      // ÂèØÈ¢ÑËßàÁöÑÊñá‰ª∂Êâ©Â±ïÂêçÂàóË°®
      const previewableExts = [
        // ÂõæÁâá
        'jpg', 'jpeg', 'png', 'gif', 'webp', 'svg',
        
        // Èü≥È¢ë
        'mp3', 'wav', 'ogg', 'm4a',
        
        // ËßÜÈ¢ë
        'mp4', 'webm', 'ogv'
      ];
      
      // È¶ñÂÖàÊ£ÄÊü•Êñá‰ª∂Êâ©Â±ïÂêç
      if (previewableExts.includes(fileExt)) {
        return true;
      }
      
      // ÁÑ∂ÂêéÊ£ÄÊü•MIMEÁ±ªÂûã
      if (mimeType.startsWith('image/') || 
          mimeType.startsWith('video/') || 
          mimeType.startsWith('audio/')) {
        return true;
      }
      
      return false;
    }

    // ËÆæÂ§áÂàóË°®Ê∏≤Êüì
    function updateDeviceList() {
      const footer = document.getElementById('deviceFooter');
      const listInner = document.getElementById('deviceListInner');
      const deviceList = Array.from(devices.values()).filter(device => device.id !== myDeviceId);
      
      if (deviceList.length === 0) {
        listInner.innerHTML = `
          <div class="empty-state">
            <i class="ri-radar-line"></i>
            <p>${t('searching')}</p>
          </div>
        `;
        return;
      }
      
      listInner.innerHTML = '';
      
      // Ê∑ªÂä†Â§öÈÄâÊåâÈíÆÔºåÂßãÁªàÊòæÁ§∫Âú®Â∫ïÈÉ®ËÆæÂ§áÂàóË°®‰∏≠
      if (deviceList.length > 1) {
        const multiSelectBtn = document.createElement('button');
        multiSelectBtn.className = 'device-chip';
        multiSelectBtn.style.background = selectedDevices.size > 0 ? 'var(--color-primary)' : '';
        multiSelectBtn.style.color = selectedDevices.size > 0 ? 'white' : '';
        multiSelectBtn.innerHTML = `<i class="ri-checkbox-multiple-line"></i>${selectedDevices.size > 0 ? 
          `${t('selected')}${selectedDevices.size}` : t('multiSelect')}`;
        
        multiSelectBtn.onclick = () => {
          showDeviceSelector(
            Array.from(devices.keys()).filter(id => id !== myDeviceId),
            (targetIds) => {
              selectedDevices = new Set(targetIds);
              selectedDeviceId = null; // Ê∏ÖÈô§ÂçïÈÄâ
              updateDeviceList();
              
              if (targetIds.length > 0) {
                showNotification(`Â∑≤ÈÄâÊã© ${targetIds.length} ‰∏™ËÆæÂ§á`);
              }
            }
          );
        };
        
        listInner.appendChild(multiSelectBtn);
      }
      
      // ÈôêÂà∂Âè™ÊòæÁ§∫Ââç1-2‰∏™ËÆæÂ§áÔºàÂú®ÁßªÂä®ËÆæÂ§á‰∏äÔºâÊàñÂâç2-3‰∏™ËÆæÂ§áÔºàÂú®Ê°åÈù¢ËÆæÂ§á‰∏äÔºâ
      const isMobile = window.innerWidth <= 768;
      const maxVisibleDevices = isMobile ? (deviceList.length > 3 ? 1 : 2) : (deviceList.length > 4 ? 2 : 3);
      
      // Â¶ÇÊûúÊúâË∂ÖËøáÊòæÁ§∫‰∏äÈôêÁöÑËÆæÂ§áÔºåÊ∑ªÂä†"Êõ¥Â§ö"ÊåâÈíÆ
      const hasMoreDevices = deviceList.length > maxVisibleDevices;
      const visibleDevices = hasMoreDevices ? deviceList.slice(0, maxVisibleDevices) : deviceList;
      
      // Ê∏≤ÊüìÂèØËßÅËÆæÂ§á
      visibleDevices.forEach(device => {
        const chip = createDeviceChip(device);
        listInner.appendChild(chip);
      });
      
      // Â¶ÇÊûúÊúâÊõ¥Â§öËÆæÂ§áÔºåÊ∑ªÂä†"Êõ¥Â§ö"ÊåâÈíÆ
      if (hasMoreDevices) {
        const moreBtn = document.createElement('button');
        moreBtn.className = 'more-devices-btn';
        moreBtn.innerHTML = `<i class="ri-more-line"></i>(${deviceList.length - maxVisibleDevices})`;
        
        moreBtn.addEventListener('click', () => {
          showDevicesModal(deviceList);
        });
        
        listInner.appendChild(moreBtn);
      }
    }
    
    // ÂàõÂª∫ËÆæÂ§áchipÂÖÉÁ¥†
    function createDeviceChip(device) {
      const chip = document.createElement('div');
      
      // ËÆæÁΩÆÊ†∑ÂºèÁ±ª
      let className = 'device-chip';
      if (selectedDeviceId === device.id) {
        className += ' active';
      }
      if (selectedDevices.has(device.id)) {
        className += ' selected';
      }
      
      chip.className = className;
      chip.innerHTML = `<i class="${device.icon || 'ri-device-line'}"></i>${device.name || `ËÆæÂ§á ${device.id.slice(0,6)}`}`;
      chip.title = device.type || 'ÁÇπÂáªÈÄâÊã©ËÆæÂ§á';
      chip.dataset.id = device.id;
      
      chip.onclick = () => {
        // Â¶ÇÊûúÂ∑≤ÁªèÂ§Ñ‰∫éÂ§öÈÄâÊ®°Âºè
        if (selectedDevices.size > 0) {
          if (selectedDevices.has(device.id)) {
            selectedDevices.delete(device.id);
          } else {
            selectedDevices.add(device.id);
          }
          
          updateDeviceList();
          return;
        }
        
        // ÂçïÈÄâÊ®°Âºè
        selectedDeviceId = device.id;
        selectedDevices.clear(); // Ê∏ÖÈô§Â§öÈÄâ
        document.querySelectorAll('.device-chip').forEach(el => el.classList.remove('active'));
        chip.classList.add('active');
        showNotification(`Â∑≤ÈÄâÊã©ËÆæÂ§á: ${device.name || `ËÆæÂ§á ${device.id.slice(0,6)}`}`);
      };
      
      return chip;
    }
    
    // ÊòæÁ§∫ÂÆåÊï¥ËÆæÂ§áÂàóË°®ÂºπÁ™ó
    function showDevicesModal(deviceList) {
      let content = '<div class="devices-modal-grid">';
      
      // Ê∑ªÂä†ÊâÄÊúâËÆæÂ§á
      deviceList.forEach(device => {
        let className = 'device-chip';
        if (selectedDeviceId === device.id) {
          className += ' active';
        }
        if (selectedDevices.has(device.id)) {
          className += ' selected';
        }
        
        content += `
          <div class="${className}" data-id="${device.id}">
            <i class="${device.icon || 'ri-device-line'}"></i>
            <span>${device.name || `ËÆæÂ§á ${device.id.slice(0,6)}`}</span>
          </div>
        `;
      });
      
      content += '</div>';
      
      showModal(
        'ÊâÄÊúâËÆæÂ§á',
        content,
        [{ text: 'ÂÖ≥Èó≠', class: 'primary', action: closeModal }]
      );
      
      // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
      setTimeout(() => {
        document.querySelectorAll('.devices-modal-grid .device-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            const deviceId = chip.dataset.id;
            if (!deviceId) return;
            
            // Â¶ÇÊûúÂ∑≤ÁªèÂ§Ñ‰∫éÂ§öÈÄâÊ®°Âºè
            if (selectedDevices.size > 0) {
              if (selectedDevices.has(deviceId)) {
                selectedDevices.delete(deviceId);
                chip.classList.remove('selected');
              } else {
                selectedDevices.add(deviceId);
                chip.classList.add('selected');
              }
              return;
            }
            
            // ÂçïÈÄâÊ®°Âºè
            selectedDeviceId = deviceId;
            selectedDevices.clear(); // Ê∏ÖÈô§Â§öÈÄâ
            
            document.querySelectorAll('.device-chip').forEach(el => el.classList.remove('active'));
            chip.classList.add('active');
            
            showNotification(`Â∑≤ÈÄâÊã©ËÆæÂ§á: ${devices.get(deviceId)?.name || `ËÆæÂ§á ${deviceId.slice(0,6)}`}`);
            closeModal();
            updateDeviceList();
          });
        });
      }, 100);
    }

    // Socket.io ‰∫ã‰ª∂
    socket.on('connect', () => {
      debugLog('CONNECT', 'Â∑≤ËøûÊé•Âà∞ÊúçÂä°Âô®');
      // ÂàùÂßãÂåñËÆæÂ§áÂêçÁß∞
      const deviceName = initDeviceName();
      
      // ÂàùÂßãÂåñËÆæÂ§á‰ø°ÊÅØ
      myDeviceInfo = {
        ...getDeviceInfo(),
        name: deviceName
      };
      
      // ÂèëÈÄÅËÆæÂ§á‰ø°ÊÅØÂà∞ÊúçÂä°Âô®
      socket.emit('device-info', myDeviceInfo);
      
      // Êõ¥Êñ∞ËÆæÂ§áÂõæÊ†á
      updateDeviceTypeIcon();
    });
    
    socket.on('device-info', (data) => {
      myDeviceId = data.id;
      data.devices.forEach(device => { 
        devices.set(device.id, device); 
      });
      updateDeviceList();
    });
    
    socket.on('device-joined', (data) => {
      devices.set(data.id, { 
        id: data.id, 
        lastSeen: Date.now(), 
        type: data.type, 
        icon: data.icon, 
        name: data.name 
      });
      updateDeviceList();
      showNotification(t('deviceJoined', data.name || `${t('device')} ${data.id.slice(0, 6)}`));
    });
    
    socket.on('device-left', (data) => {
      devices.delete(data.id);
      
      // Â¶ÇÊûúËÆæÂ§áË¢´ÈÄâ‰∏≠ÔºåÁßªÈô§ÈÄâÊã©
      if (selectedDeviceId === data.id) {
        selectedDeviceId = null;
      }
      
      if (selectedDevices.has(data.id)) {
        selectedDevices.delete(data.id);
      }
      
      updateDeviceList();
    });
    
    socket.on('device-info-update', (data) => {
      if (devices.has(data.id)) {
        const device = devices.get(data.id);
        device.name = data.name;
        device.type = data.type;
        device.icon = data.icon;
        devices.set(data.id, device);
        updateDeviceList();
      }
    });
    
    socket.on('message', (data) => {
      const { fromId, message } = data;
      const device = devices.get(fromId);
      const deviceName = device ? device.name || `${t('device')} ${fromId.slice(0, 6)}` : `${t('device')} ${fromId.slice(0, 6)}`;
      
      showModal(
        t('receivedMessage'),
        `<div style="margin-bottom:1rem;">
          <div style="margin-bottom:0.5rem;font-weight:500;">${t('messageFrom', deviceName)}</div>
          <div style="border-radius:var(--radius-md);background:var(--color-surface);padding:0.75rem;word-break:break-all;">
            ${message}
          </div>
        </div>`,
        [{ text: t('close'), class: 'primary', action: closeModal }]
      );
    });

    socket.on('file-transfer-request', (data) => { 
      handleFileReceive(data); 
    });

    // ModalÂºπÁ™ó
    function showModal(title, content, buttons=[]) {
      const modal = document.getElementById('modal');
      
      let buttonsHtml = '';
      if (buttons.length > 0) {
        buttonsHtml = `<div class="modal-buttons">`;
        buttons.forEach(btn => {
          buttonsHtml += `<button class="modal-btn ${btn.class || ''}">${btn.text}</button>`;
        });
        buttonsHtml += `</div>`;
      }
      
      modal.innerHTML = `
        <div class="modal">
          <div class="modal-content">
            <div class="modal-title">${title}</div>
            <div>${content}</div>
            ${buttonsHtml}
          </div>
        </div>
      `;
      
      modal.style.display = 'block';
      
      if (buttons.length > 0) {
        modal.querySelectorAll('.modal-btn').forEach((btn, i) => {
          if (buttons[i].action) {
            btn.onclick = buttons[i].action;
          }
        });
      }
    }

    function closeModal() { 
      document.getElementById('modal').style.display = 'none'; 
    }

    // Êñá‰ª∂Â§ßÂ∞èÊ†ºÂºèÂåñ
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024, sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Êñá‰ª∂ÂêçÊà™Êñ≠Â§ÑÁêÜ
    function truncateFileName(fileName, maxLength = 20) {
      if (!fileName || fileName.length <= maxLength) return fileName;
      
      const extension = fileName.lastIndexOf('.') > 0 ? 
        fileName.substring(fileName.lastIndexOf('.')) : '';
      
      // ‰∏∫Êâ©Â±ïÂêç‰øùÁïôÁ©∫Èó¥
      const nameLength = maxLength - extension.length - 3; // 3ÊòØ"..."ÁöÑÈïøÂ∫¶
      if (nameLength < 5) {
        // Â¶ÇÊûúÊâ©Â±ïÂêçÂ§™ÈïøÔºåÂè™ÊòæÁ§∫Êñá‰ª∂ÂêçÁöÑÂºÄÂ§¥
        return fileName.substring(0, maxLength - 3) + '...';
      }
      
      // ËøîÂõûÊà™Êñ≠ÂêéÁöÑÊñá‰ª∂Âêç + ... + Êâ©Â±ïÂêç
      return fileName.substring(0, nameLength) + '...' + extension;
    }

    // Â∏ÆÂä©ÊåâÈíÆ
    document.querySelector('[title="Â∏ÆÂä©"]').addEventListener('click', () => {
      showModal(
        t('helpTitle'),
        `<div style="text-align:left;">
          <p style="margin-bottom:0.75rem;">${t('help1')}</p>
          <p style="margin-bottom:0.75rem;">${t('help2')}</p>
          <p style="margin-bottom:0.75rem;">${t('help3')}</p>
          <p style="margin-bottom:0.75rem;">${t('help4')}</p>
          <p>${t('help5')}</p>
        </div>`,
        [{ text: t('gotIt'), class: 'primary', action: closeModal }]
      );
    });

    // ËÆæÁΩÆÊåâÈíÆ
    document.querySelector('[title="ÂÖ≥‰∫é"]').addEventListener('click', () => {
      showModal(
        t('aboutTitle'),
        `<div style="text-align:left;">
          <div style="margin-bottom:1.25rem;">
            <h3 style="margin-bottom:0.5rem;font-size:1.1rem;color:var(--color-primary);">AnyDrop - ${currentLanguage === 'zh' ? 'Â±ÄÂüüÁΩëÊñá‰ª∂‰º†Ëæì' : 'LAN File Transfer'}</h3>
            <p style="color:var(--color-text-secondary);font-size:0.9rem;">
              ${t('appDescription')}
            </p>
          </div>
          
          <div style="margin-bottom:1.25rem;">
            <h4 style="margin-bottom:0.5rem;font-size:0.95rem;">${t('versionInfo')}</h4>
            <p style="font-size:0.85rem;margin-bottom:0.25rem;">${t('version')}</p>
            <p style="font-size:0.85rem;">${t('releaseDate')}</p>
          </div>
          
          <div style="margin-bottom:1.25rem;">
            <h4 style="margin-bottom:0.5rem;font-size:0.95rem;">${t('techStack')}</h4>
            <p style="font-size:0.85rem;color:var(--color-text-secondary);">
              ${t('techDescription')}
            </p>
          </div>
          
          <div style="margin-bottom:1.25rem;">
            <h4 style="margin-bottom:0.5rem;font-size:0.95rem;">${t('openSource')}</h4>
            <p style="font-size:0.85rem;margin-bottom:0.5rem;">
              <a href="https://github.com/chenyibai9527/anydrop" target="_blank" style="color:var(--color-primary);text-decoration:none;display:flex;align-items:center;gap:0.25rem;">
                <i class="ri-github-fill"></i> ${t('githubRepo')}
              </a>
            </p>
            <p style="font-size:0.85rem;color:var(--color-text-secondary);">
              ${t('license')}
            </p>
          </div>
          
          <div>
            <h4 style="margin-bottom:0.5rem;font-size:0.95rem;">${t('contact')}</h4>
            <p style="font-size:0.85rem;color:var(--color-text-secondary);">
              ${t('feedback')}
            </p>
          </div>
        </div>`,
        [{ text: t('close'), class: 'primary', action: closeModal }]
      );
    });

    // ÁõëÂê¨ÂèñÊ∂à‰º†Ëæì
    socket.on('cancel-transfer', (data) => {
      const { fromId, transferId } = data;
      debugLog('RECEIVED_CANCEL', 'Êî∂Âà∞ÂèñÊ∂à‰º†ËæìËØ∑Ê±Ç', { fromId, transferId });
      
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÊé•Êî∂‰∏≠ÁöÑÊñá‰ª∂
      if (fileReceivers.has(transferId)) {
        // ÂèñÊ∂àÊé•Êî∂
        fileReceivers.delete(transferId);
        showNotification('ÂØπÊñπÂ∑≤ÂèñÊ∂àÊñá‰ª∂‰º†Ëæì');
        
        // ÂÖ≥Èó≠‰ªª‰ΩïÊ≠£Âú®ÊòæÁ§∫ÁöÑËøõÂ∫¶Êù°
        const progressElement = document.getElementById(`transfer-${transferId}`);
        if (progressElement) {
          progressElement.querySelector('.progress-bar').style.background = 'var(--color-text-tertiary)';
          const progressText = progressElement.querySelector('.transfer-progress-text');
          if (progressText) progressText.textContent = 'Â∑≤ÂèñÊ∂à';
          
          // ‰∏ÄÊÆµÊó∂Èó¥ÂêéÁßªÈô§UI
          setTimeout(() => {
            progressElement.style.opacity = '0';
            progressElement.style.transition = 'opacity 0.5s ease';
            setTimeout(() => progressElement.remove(), 500);
          }, 3000);
        }
      }
      
      // Êõ¥Êñ∞‰º†ËæìÁä∂ÊÄÅ
      if (activeTransfers.has(transferId)) {
        const transfer = activeTransfers.get(transferId);
        transfer.status = 'cancelled';
        activeTransfers.set(transferId, transfer);
        updateTransferProgress(transferId);
      }
    });

    // ‰øÆÊîπfile-transfer-response‰∫ã‰ª∂Â§ÑÁêÜÂáΩÊï∞
    socket.on('file-transfer-response', (data) => {
      const { fromId, transferId, accepted } = data;
      debugLog('RESPONSE', `Êî∂Âà∞‰º†ËæìÂìçÂ∫î`, { fromId, transferId, accepted });
      
      // Êü•ÊâæÊ≠§‰º†ËæìIDÂØπÂ∫îÁöÑÊ¥ªË∑É‰º†Ëæì
      const transfer = activeTransfers.get(transferId);
      
      // Êü•ÊâæÊ≠§‰º†ËæìIDÂØπÂ∫îÁöÑÁõÆÊ†áËÆæÂ§áID
      const targetId = fileTransferMappings.get(transferId);
      
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÂêàÊ≥ïÁöÑÂìçÂ∫î
      if (transfer && fromId === targetId) {
        if (accepted) {
          debugLog('SEND', `ÁõÆÊ†áËÆæÂ§áÂ∑≤Êé•ÂèóÊñá‰ª∂‰º†ËæìËØ∑Ê±ÇÔºåÂºÄÂßãÂèëÈÄÅÊï∞ÊçÆ`, { transferId, targetId });
          
          // Êõ¥Êñ∞‰º†ËæìÁä∂ÊÄÅ
          transfer.status = 'active';
          activeTransfers.set(transferId, transfer);
          
          // ÊòæÁ§∫‰º†ËæìËøõÂ∫¶
          showTransferProgress(transferId);
          
          // ÂºÄÂßã‰º†ËæìÊñá‰ª∂Êï∞ÊçÆ
          sendFileData(transfer.file, targetId, transferId);
        } else {
          debugLog('SEND', `ÁõÆÊ†áËÆæÂ§áÊãíÁªù‰∫ÜÊñá‰ª∂‰º†ËæìËØ∑Ê±Ç`, { transferId, targetId });
          
          // Êõ¥Êñ∞‰º†ËæìÁä∂ÊÄÅ
          transfer.status = 'rejected';
          activeTransfers.set(transferId, transfer);
          
          // Êõ¥Êñ∞UI
          showTransferRejectedUI(transferId);
          
          showNotification(`ÂØπÊñπÊãíÁªùÊé•Êî∂Êñá‰ª∂ ${transfer.name}`);
        }
      }
    });

    // Ê∑ªÂä†Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂáΩÊï∞‰∏≠
    // ËÆæÂ§áÂàóË°®ÊäòÂè†/Â±ïÂºÄÂàáÊç¢
    document.getElementById('deviceListToggle').addEventListener('click', function() {
      const footer = document.getElementById('deviceFooter');
      footer.classList.toggle('collapsed');
      
      // ËÆ∞ÂΩïÁî®Êà∑ÊâãÂä®Â±ïÂºÄÁöÑÁä∂ÊÄÅ
      if (!footer.classList.contains('collapsed')) {
        footer.classList.add('user-expanded');
      } else {
        footer.classList.remove('user-expanded');
      }
      
      // ‰øùÂ≠òÊäòÂè†Áä∂ÊÄÅÂà∞Êú¨Âú∞Â≠òÂÇ®
      localStorage.setItem('deviceListCollapsed', footer.classList.contains('collapsed'));
    });
  </script>
</body>
</html>