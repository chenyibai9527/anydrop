<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Drop | å±€åŸŸç½‘æ–‡ä»¶äº’ä¼ </title>
  <meta name="description" content="Dropæ˜¯ä¸€ä¸ªç®€å•ã€å¿«é€Ÿã€æ— éœ€å®‰è£…çš„å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“å·¥å…·ï¼Œè®©æ‚¨åœ¨åŒä¸€ç½‘ç»œä¸‹çš„è®¾å¤‡é—´è½»æ¾åˆ†äº«æ–‡ä»¶ã€‚">
  <meta name="keywords" content="æ–‡ä»¶ä¼ è¾“,å±€åŸŸç½‘ä¼ è¾“,æ–‡ä»¶åˆ†äº«,æ— çº¿ä¼ è¾“,P2Pä¼ è¾“">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’«</text></svg>">
  <script src="/socket.io/socket.io.js"></script>
  <!-- è°ƒè¯•å·¥å…· -->
  <script>
    // è°ƒè¯•å·¥å…·
    function debugLog(tag, ...args) {
      const timestamp = new Date().toISOString().substr(11, 8);
      console.log(`[${tag}] ${timestamp}`, ...args);
    }
    
    // å…¨å±€é”™è¯¯æ•è·
    window.addEventListener('error', function(event) {
      debugLog('ERROR', 'å…¨å±€é”™è¯¯:', event.error);
      console.error(event.error);
    });
  </script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #3B82F6;
      --color-primary-light: #60A5FA;
      --color-primary-dark: #2563EB;
      --color-secondary: #A78BFA;
      --color-accent: #F472B6;
      --color-background: #FFFFFF;
      --color-surface: #F9FAFB;
      --color-border: #E5E7EB;
      --color-text-primary: #1F2937;
      --color-text-secondary: #4B5563;
      --color-text-tertiary: #9CA3AF;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius-sm: 0.375rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.5rem;
      --radius-full: 9999px;
      --animation-speed: 300ms;
    }

    [data-theme="dark"] {
      --color-primary: #60A5FA;
      --color-primary-light: #93C5FD;
      --color-primary-dark: #3B82F6;
      --color-secondary: #A78BFA;
      --color-accent: #F472B6;
      --color-background: #111827;
      --color-surface: #1F2937;
      --color-border: #374151;
      --color-text-primary: #F9FAFB;
      --color-text-secondary: #E5E7EB;
      --color-text-tertiary: #9CA3AF;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.25);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--color-text-primary);
      background: var(--color-background);
      overflow-x: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.5rem;
      background: var(--color-background);
      position: relative;
      z-index: 10;
      transition: background-color 0.3s ease;
    }

    .app-logo {
      display: flex;
      align-items: center;
      font-weight: 600;
      font-size: 1.25rem;
      color: var(--color-primary);
    }

    .app-logo span {
      margin-left: 0.5rem;
    }

    .topbar-actions {
      display: flex;
      gap: 1rem;
    }

    .icon-btn {
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
      color: var(--color-text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
    }

    .icon-btn:hover {
      background: var(--color-surface);
      color: var(--color-primary);
    }

    .icon-btn i {
      font-size: 1.25rem;
    }

    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      padding-top: 1rem;
      padding-bottom: 1rem;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .radar-container {
      position: relative;
      width: 100%;
      max-width: 480px;
      height: 320px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .radar-circle {
      position: absolute;
      border-radius: 50%;
      border: 1px solid rgba(59, 130, 246, 0.1);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.05);
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .radar-circle {
      border-color: rgba(96, 165, 250, 0.15);
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.08);
    }

    .circle-1 {
      width: 80px;
      height: 80px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
      animation: pulse 3s infinite;
    }

    .circle-2 {
      width: 160px;
      height: 160px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
      animation: pulse 3s infinite 0.5s;
    }

    .circle-3 {
      width: 240px;
      height: 240px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.03) 0%, transparent 70%);
      animation: pulse 3s infinite 1s;
    }

    .circle-4 {
      width: 320px;
      height: 320px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.02) 0%, transparent 70%);
      animation: pulse 3s infinite 1.5s;
    }

    [data-theme="dark"] .circle-1 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.12) 0%, transparent 70%);
    }

    [data-theme="dark"] .circle-2 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.08) 0%, transparent 70%);
    }

    [data-theme="dark"] .circle-3 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.05) 0%, transparent 70%);
    }

    [data-theme="dark"] .circle-4 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.03) 0%, transparent 70%);
    }

    @keyframes pulse {
      0% {
        opacity: 0.7;
        transform: scale(0.95);
      }
      50% {
        opacity: 0.9;
        transform: scale(1);
      }
      100% {
        opacity: 0.7;
        transform: scale(0.95);
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.25rem 0;
      font-size: 0.85rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      justify-content: center;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      max-width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
    }

    /* è®¾å¤‡åˆ—è¡¨ä¸­çš„"æ›´å¤š"æŒ‰é’® */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
    }

    .more-devices-btn:hover {
      border-color: var(--color-primary-light);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .more-devices-btn:active {
      transform: scale(0.95);
    }

    /* å¼¹çª—ä¸­çš„è®¾å¤‡åˆ—è¡¨æ ·å¼ */
    .devices-modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      margin: 1rem 0;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .devices-modal-grid .device-chip {
      margin: 0;
      justify-content: flex-start;
      width: 100%;
    }

    @media (max-width: 768px) {
      .devices-modal-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }

    /* è®¾å¤‡åˆ—è¡¨æ»šåŠ¨æ¡æ ·å¼ */
    .device-list::-webkit-scrollbar {
      height: 4px;
      width: 4px;
    }

    .device-list::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    /* è®¾å¤‡åˆ—è¡¨æŠ˜å /å±•å¼€æ§åˆ¶ */
    .device-list-toggle {
      display: none;
    }

    .device-list.collapsed {
      display: flex;
    }

    .device-list.collapsed .device-list-toggle i {
      transform: none;
    }

    .device-list.collapsed .device-list-inner {
      display: flex;
    }

    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .device-chip:hover {
      border-color: var(--color-primary-light);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .device-chip.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-chip.selected {
      position: relative;
    }

    .device-chip.selected:after {
      content: "";
      position: absolute;
      top: -4px;
      right: -4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-chip i {
      font-size: 1rem;
      color: inherit;
    }

    .notification {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--color-background);
      border-radius: var(--radius-lg);
      padding: 1rem 1.5rem;
      font-weight: 500;
      color: var(--color-text-primary);
      box-shadow: var(--shadow-lg);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      z-index: 2000;
      border: 1px solid var(--color-border);
      max-width: 280px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    [data-theme="dark"] .modal {
      background: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      max-width: 400px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      animation: modal-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid var(--color-border);
    }

    @keyframes modal-in {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 1rem;
    }

    .modal-buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      border: none;
    }

    .modal-btn.primary {
      background: var(--color-primary);
      color: white;
    }

    .modal-btn.primary:hover {
      background: var(--color-primary-dark);
    }

    .modal-btn.secondary {
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
    }

    .modal-btn.secondary:hover {
      background: var(--color-border);
    }

    .transfer-progress {
      margin-top: 1rem;
      width: 100%;
      background: var(--color-surface);
      border-radius: var(--radius-full);
      height: 6px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
      border-radius: var(--radius-full);
      transition: width 0.3s ease;
    }

    .load-animation {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-background);
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    .load-animation.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .load-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-surface);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 2rem 0;
      color: var(--color-text-tertiary);
    }

    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }

    .device-select-container {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-bottom: 1rem;
      max-height: 150px;
      overflow-y: auto;
    }

    .device-select-container .device-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .device-select-container .device-option:hover {
      background: var(--color-background);
    }

    .device-select-container .checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--color-border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
    }

    .device-select-container .checkbox.checked {
      background: var(--color-primary);
      border-color: var(--color-primary);
    }

    .device-select-all {
      font-size: 0.875rem;
      color: var(--color-primary);
      cursor: pointer;
      margin-top: 0.5rem;
      display: inline-block;
    }

    .transfer-progress-container {
      transition: all 0.3s ease !important;
      border: 1px solid var(--color-border);
    }

    @media (max-width: 768px) {
      .radar-container {
        height: 240px;
      }
      
      .circle-4 {
        width: 200px;
        height: 200px;
      }
      
      .circle-3 {
        width: 150px;
        height: 150px;
      }
      
      .circle-2 {
        width: 100px;
        height: 100px;
      }
      
      .upload-button {
        width: 70px;
        height: 70px;
        font-size: 1.25rem;
      }
      
      .topbar {
        padding: 0.75rem 1rem;
      }
      
      .device-list {
        padding: 0.75rem 0.75rem calc(0.75rem + env(safe-area-inset-bottom, 0.75rem));
      }
      
      .device-info {
        margin-top: 0.5rem;
      }
      
      .main-area {
        padding-top: 1rem;
      }
      
      .device-chip {
        padding: 0.4rem 0.9rem;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .radar-container {
        height: 160px;
        margin-bottom: 0;
      }
      
      .circle-4 {
        width: 160px;
        height: 160px;
      }
      
      .circle-3 {
        width: 120px;
        height: 120px;
      }
      
      .circle-2 {
        width: 80px;
        height: 80px;
      }
      
      .circle-1 {
        width: 40px;
        height: 40px;
      }
      
      .upload-button {
        width: 45px;
        height: 45px;
        font-size: 1rem;
      }
      
      .action-buttons {
        flex-direction: column;
        gap: 0.5rem;
        width: 100%;
        max-width: 260px;
        margin-bottom: 0.6rem;
      }
      
      .action-btn {
        width: 100%;
        padding: 0.5rem;
        text-align: center;
        font-size: 0.8rem;
        justify-content: center;
      }
      
      .action-btn i {
        font-size: 1rem;
      }
      
      .device-name-field input {
        font-size: 1.1rem;
      }
      
      .device-name-field {
        margin-bottom: 0.5rem;
      }
      
      .instructions {
        font-size: 0.8rem;
        margin: 0.15rem 0;
      }
      
      .device-info {
        margin-top: 0.5rem;
      }
    }

    /* ç§»é™¤æ‰€æœ‰æŒ‰é’®å’Œå¯äº¤äº’å…ƒç´ çš„è§¦æ‘¸é«˜äº® */
    button, a, .device-chip, .icon-btn, .action-btn, .modal-btn {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      outline: none;
      user-select: none;
    }

    /* ç¡®ä¿æŒ‰é’®ç‚¹å‡»æ•ˆæœ */
    .action-btn:active, .device-chip:active, .icon-btn:active {
      transform: scale(0.95);
    }

    /* ä¿®å¤æŒ‰é’®ç„¦ç‚¹æ ·å¼ */
    .action-btn:focus, .device-chip:focus, .icon-btn:focus, .modal-btn:focus {
      outline: none;
    }

    /* æ·»åŠ è¿›åº¦æ¡æ ·å¼åˆ°å¤´éƒ¨æ ·å¼åŒºåŸŸ */
    .transfer-progress .progress-container {
      height: 6px;
      background: var(--color-background);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin: 0.5rem 0 0.25rem 0;
    }

    .transfer-progress .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
      border-radius: var(--radius-full);
      transition: width 0.2s ease-out;
    }

    .transfer-progress .transfer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
    }

    .transfer-progress .transfer-filename {
      font-weight: 500;
      font-size: 0.875rem;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .transfer-progress .cancel-transfer {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      cursor: pointer;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      padding: 0;
      transition: all 0.2s ease;
    }

    .transfer-progress .cancel-transfer:hover {
      background: var(--color-background);
      color: var(--color-text-secondary);
    }

    #transfersContainer {
      position: fixed;
      bottom: calc(70px + env(safe-area-inset-bottom, 0px));
      right: 1rem;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 50vh;
      overflow-y: auto;
      padding-right: 0.5rem;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      pointer-events: auto;
    }

    #transfersContainer::-webkit-scrollbar {
      width: 4px;
    }

    #transfersContainer::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      #transfersContainer {
        right: 0.5rem;
        max-width: calc(100vw - 2rem);
      }
      
      .transfer-progress {
        max-width: calc(100vw - 2rem);
      }
    }
  </style>
</head>
<body ontouchstart="">
  <div class="load-animation">
    <div class="load-spinner"></div>
  </div>

  <div class="app-container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="topbar">
      <div class="app-logo">
        <i class="ri-share-forward-fill"></i>
        <span>AnyDrop</span>
      </div>
      <div class="topbar-actions">
        <button class="icon-btn" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">
          <i class="ri-sun-line"></i>
        </button>
        <button class="icon-btn" id="languageToggle" title="åˆ‡æ¢è¯­è¨€">
          <i class="ri-translate-2"></i>
        </button>
        <button class="icon-btn" title="å…³äº">
          <i class="ri-information-line"></i>
        </button>
        <button class="icon-btn" title="å¸®åŠ©">
          <i class="ri-question-line"></i>
        </button>
      </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <main class="main-area">
      <div class="radar-container">
        <!-- é›·è¾¾åœ†åœˆ -->
        <div class="radar-circle circle-1"></div>
        <div class="radar-circle circle-2"></div>
        <div class="radar-circle circle-3"></div>
        <div class="radar-circle circle-4"></div>

        <!-- ä¸Šä¼ æŒ‰é’® -->
        <button class="upload-button" id="mainUploadBtn" title="ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶">
          <i class="ri-upload-cloud-line"></i>
          <input type="file" id="fileInput" multiple>
        </button>
      </div>

      <!-- è®¾å¤‡ä¿¡æ¯ -->
      <div class="device-info">
        <div class="action-buttons">
          <button class="action-btn" id="uploadFolderBtn">
            <i class="ri-folder-upload-line"></i>
            ä¸Šä¼ æ–‡ä»¶å¤¹
          </button>
          <button class="action-btn" id="sendTextBtn">
            <i class="ri-message-2-line"></i>
            å‘é€æ–‡æœ¬
          </button>
        </div>
        
        <div class="device-label">
          <i class="ri-device-line" id="deviceTypeIcon"></i>
          <span>æˆ‘çš„è®¾å¤‡</span>
        </div>
        <div class="device-name-field">
          <input id="deviceName" value="æˆ‘çš„è®¾å¤‡" maxlength="20" />
          <button class="edit-btn" title="ç¼–è¾‘åç§°">
            <i class="ri-edit-line"></i>
          </button>
        </div>
        <p class="instructions">åŒä¸€ç½‘ç»œä¸‹è®¾å¤‡ä¼šè‡ªåŠ¨æ˜¾ç¤ºï¼Œç‚¹å‡»è®¾å¤‡å‘é€æ–‡ä»¶</p>
      </div>
    </main>

    <!-- è®¾å¤‡åˆ—è¡¨ -->
    <div class="device-list" id="deviceFooter">
      <div class="device-list-inner" id="deviceListInner"></div>
    </div>
  </div>

  <!-- æ–‡ä»¶å¤¹ä¸Šä¼ éšè—input -->
  <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none">
  
  <!-- é€šçŸ¥ -->
  <div id="notification" class="notification"></div>
  
  <!-- å¼¹çª—åŒº -->
  <div id="modal" style="display:none"></div>

  <!-- è„šæœ¬éƒ¨åˆ† -->
  <script>
    // é…ç½®Socket.IOæ­£ç¡®å¤„ç†äºŒè¿›åˆ¶æ•°æ®
    // è‡ªåŠ¨é€‚é…åç«¯åœ°å€ï¼Œæ”¯æŒæœ¬åœ°å’Œäº‘ç«¯
    const socket = io(window.location.origin, {
      binaryType: 'arraybuffer'
    });
    
    debugLog('INIT', 'Socket.IOå·²åˆå§‹åŒ–ï¼Œé…ç½®ä¸ºå¤„ç†äºŒè¿›åˆ¶æ•°æ®');
    
    let myDeviceId = null;
    let devices = new Map();
    let myDeviceInfo = {};
    let transferStartTime = null;
    let activeTransfers = new Map();
    let selectedDeviceId = null;
    let selectedDevices = new Set(); // å­˜å‚¨å·²é€‰æ‹©çš„å¤šä¸ªè®¾å¤‡ID
    let isDarkMode = false;
    let fileTransferMappings = new Map(); // å­˜å‚¨transferIdåˆ°targetIdçš„æ˜ å°„ï¼Œç”¨äºå¤šè®¾å¤‡ä¼ è¾“
    let currentLanguage = 'en'; // é»˜è®¤è¯­è¨€ä¸ºè‹±æ–‡

    // å¤šè¯­è¨€æ”¯æŒ
    const translations = {
      zh: {
        appTitle: 'AnyDrop | å±€åŸŸç½‘æ–‡ä»¶äº’ä¼ å·¥å…·,ç±»ä¼¼ Snapdrop',
        myDevice: 'æˆ‘çš„è®¾å¤‡',
        uploadFileFolder: 'ä¸Šä¼ æ–‡ä»¶å¤¹',
        sendText: 'å‘é€æ–‡æœ¬',
        searching: 'æ­£åœ¨å¯»æ‰¾é™„è¿‘çš„è®¾å¤‡...',
        instruction: 'åŒä¸€ç½‘ç»œä¸‹è®¾å¤‡ä¼šè‡ªåŠ¨æ˜¾ç¤ºï¼Œç‚¹å‡»è®¾å¤‡å‘é€æ–‡ä»¶',
        multiSelect: 'å¤šé€‰',
        selected: 'å·²é€‰',
        more: 'æ›´å¤š',
        receive: 'æ¥æ”¶',
        reject: 'æ‹’ç»',
        send: 'å‘é€',
        cancel: 'å–æ¶ˆ',
        waiting: 'ç­‰å¾…ç¡®è®¤...',
        preparing: 'å‡†å¤‡ä¸­...',
        receiving: 'æ­£åœ¨æ¥æ”¶',
        fileSending: 'æ­£åœ¨å‘ {0} ä¸ªè®¾å¤‡å‘é€ {1} ä¸ªæ–‡ä»¶',
        fileReceiving: 'æ­£åœ¨æ¥æ”¶ {0}',
        fileCompleted: 'æ–‡ä»¶ {0} ä¼ è¾“å®Œæˆ',
        fileCancelled: 'å·²å–æ¶ˆ{0}æ–‡ä»¶ {1}',
        noDevices: 'æ²¡æœ‰å¯ç”¨çš„è®¾å¤‡',
        selectDeviceTitle: 'é€‰æ‹©è®¾å¤‡',
        confirm: 'ç¡®è®¤',
        selectAtLeastOne: 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®¾å¤‡',
        sendToDevice: 'å‘é€æ–‡ä»¶è‡³ {0}',
        sendToMultiDevices: 'å‘é€æ–‡ä»¶è‡³ {0} ä¸ªè®¾å¤‡',
        receivingFromDevice: 'æ¥è‡ª {0} çš„æ–‡ä»¶ï¼š',
        saveFile: 'ä¿å­˜æ–‡ä»¶',
        openInNewWindow: 'åœ¨æ–°çª—å£æ‰“å¼€',
        deviceJoined: '{0} å·²åŠ å…¥',
        selectAll: 'å…¨é€‰',
        fileReceived: 'æ–‡ä»¶å·²æ¥æ”¶',
        downloadTip: 'æç¤º: å¦‚æœä¸‹è½½ä¸è‡ªåŠ¨å¼€å§‹ï¼Œè¯·ç‚¹å‡»"ä¿å­˜æ–‡ä»¶"æŒ‰é’®',
        receiveFiles: 'æ¥æ”¶æ–‡ä»¶',
        aboutTitle: 'å…³äº AnyDrop',
        appDescription: 'ä¸€ä¸ªç®€å•ã€å¿«é€Ÿã€æ— éœ€å®‰è£…çš„å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“å·¥å…·ã€‚è®©æ‚¨åœ¨åŒä¸€ç½‘ç»œä¸‹çš„è®¾å¤‡é—´è½»æ¾åˆ†äº«æ–‡ä»¶ã€‚',
        versionInfo: 'ç‰ˆæœ¬ä¿¡æ¯',
        version: 'ç‰ˆæœ¬: 1.0.0',
        releaseDate: 'å‘å¸ƒæ—¥æœŸ: 2025å¹´5æœˆ',
        techStack: 'æŠ€æœ¯æ ˆ',
        techDescription: 'æœ¬é¡¹ç›®åŸºäºWebæŠ€æœ¯æ„å»ºï¼Œä½¿ç”¨Socket.ioå®ç°å®æ—¶é€šä¿¡ï¼Œæ— éœ€é¢å¤–å®‰è£…ä»»ä½•è½¯ä»¶ã€‚',
        openSource: 'å¼€æºä¿¡æ¯',
        githubRepo: 'GitHub ä»“åº“',
        license: 'å¼€æºåè®®: MIT License',
        contact: 'è”ç³»ä¸åé¦ˆ',
        feedback: 'å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨GitHubæäº¤Issueæˆ–ç›´æ¥è”ç³»å¼€å‘è€…ã€‚',
        helpTitle: 'ä½¿ç”¨å¸®åŠ©',
        help1: '1. åœ¨åŒä¸€å±€åŸŸç½‘ä¸‹æ‰“å¼€æœ¬é¡µé¢å³å¯äº’ä¼ æ–‡ä»¶',
        help2: '2. ç‚¹å‡»ä¸­å¿ƒæŒ‰é’®é€‰æ‹©è¦ä¼ è¾“çš„æ–‡ä»¶',
        help3: '3. ç‚¹å‡»åº•éƒ¨è®¾å¤‡åˆ—è¡¨ä¸­çš„è®¾å¤‡è¿›è¡Œé€‰æ‹©',
        help4: '4. æ”¯æŒæ‹–æ”¾æ–‡ä»¶åˆ°ä¸­å¿ƒæŒ‰é’®è¿›è¡Œä¸Šä¼ ',
        help5: '5. æ”¯æŒæ–‡æœ¬æ¶ˆæ¯å’Œæ–‡ä»¶å¤¹çš„ä¼ è¾“',
        gotIt: 'çŸ¥é“äº†',
        close: 'å…³é—­',
        messageSent: 'æ¶ˆæ¯å·²å‘é€',
        sendToSingleDevice: 'å‘é€æ¶ˆæ¯è‡³ {0}',
        sendToMultiDevices: 'å‘é€æ¶ˆæ¯è‡³ {0} ä¸ªè®¾å¤‡',
        receiverDevices: 'æ¥æ”¶è®¾å¤‡ï¼š',
        messageSentMulti: 'å·²å‘ {0} ä¸ªè®¾å¤‡å‘é€æ¶ˆæ¯',
        receivedMessage: 'æ”¶åˆ°æ¶ˆæ¯',
        messageFrom: 'æ¥è‡ª {0}ï¼š',
        themeDark: 'å·²åˆ‡æ¢åˆ°æš—è‰²æ¨¡å¼',
        themeLight: 'å·²åˆ‡æ¢åˆ°äº®è‰²æ¨¡å¼',
        switchToEnglish: 'Switch to English',
        switchToChinese: 'å·²åˆ‡æ¢åˆ°ä¸­æ–‡',
        switchTheme: 'åˆ‡æ¢ä¸»é¢˜',
        about: 'å…³äº',
        help: 'å¸®åŠ©',
        switchLanguage: 'åˆ‡æ¢è¯­è¨€',
        browser: 'æµè§ˆå™¨',
        phone: 'æ‰‹æœº',
        tablet: 'å¹³æ¿',
        computer: 'ç”µè„‘',
        unknownDevice: 'æœªçŸ¥è®¾å¤‡',
        requestSendFile: 'ç­‰å¾…å¯¹æ–¹æ¥å—æ–‡ä»¶...',
        selectDevice: 'é€‰æ‹©è®¾å¤‡',
        device: 'è®¾å¤‡', 
        files: 'ä¸ªæ–‡ä»¶',
        totalSize: 'æ€»å¤§å°',
        fileSize: 'æ–‡ä»¶å¤§å°',
        receivedFile: 'æ¥æ”¶çš„æ–‡ä»¶',
        completed: 'å·²å®Œæˆ',
        failed: 'å¤±è´¥',
        rejected: 'å·²æ‹’ç»',
        transferCancelled: 'å·²å–æ¶ˆ',
        formatSeconds: 'ç§’',
        formatMinutes: 'åˆ†',
        formatHours: 'å°æ—¶',
        sendingFile: 'æ­£åœ¨å‘é€',
        sending: 'å‘é€ä¸­',
      },
      en: {
        appTitle: 'AnyDrop | LAN File Transfer Tool Like Snapdrop',
        myDevice: 'My Device',
        uploadFileFolder: 'Upload Folder',
        sendText: 'Send Text',
        searching: 'Searching for nearby devices...',
        instruction: 'Devices on the same network will appear automatically. Click a device to send files.',
        multiSelect: 'Multi',
        selected: 'Selected',
        more: 'More',
        receive: 'Receive',
        reject: 'Reject',
        send: 'Send',
        cancel: 'Cancel',
        waiting: 'Waiting...',
        preparing: 'Preparing...',
        receiving: 'Receiving',
        fileSending: 'Sending {1} files to {0} devices',
        fileReceiving: 'Receiving {0}',
        fileCompleted: 'File {0} transfer completed',
        fileCancelled: 'Cancelled {0} file {1}',
        noDevices: 'No devices available',
        selectDeviceTitle: 'Select Device',
        confirm: 'Confirm',
        selectAtLeastOne: 'Please select at least one device',
        sendToDevice: 'Send file to {0}',
        sendToMultiDevices: 'Send file to {0} devices',
        receivingFromDevice: 'File from {0}:',
        saveFile: 'Save File',
        openInNewWindow: 'Open in New Window',
        deviceJoined: '{0} joined',
        selectAll: 'Select All',
        fileReceived: 'File Received',
        downloadTip: 'Tip: If download doesn\'t start automatically, click "Save File" button',
        receiveFiles: 'Receive File',
        aboutTitle: 'About AnyDrop',
        appDescription: 'A simple, fast, and installation-free LAN file transfer tool. Easily share files between devices on the same network.',
        versionInfo: 'Version Info',
        version: 'Version: 1.0.0',
        releaseDate: 'Release Date: May 2025',
        techStack: 'Technology Stack',
        techDescription: 'This project is built with web technologies, using Socket.io for real-time communication, requiring no additional software installation.',
        openSource: 'Open Source Info',
        githubRepo: 'GitHub Repository',
        license: 'License: MIT License',
        contact: 'Contact & Feedback',
        feedback: 'For issues or suggestions, please submit an issue on GitHub or contact the developer directly.',
        helpTitle: 'Usage Help',
        help1: '1. Open this page on devices within the same local network to transfer files',
        help2: '2. Click the center button to select files for transfer',
        help3: '3. Click a device in the bottom list to select it',
        help4: '4. You can also drag and drop files to the center button',
        help5: '5. Text messages and folders are also supported',
        gotIt: 'Got it',
        close: 'Close',
        messageSent: 'Message sent',
        sendToSingleDevice: 'Send message to {0}',
        sendToMultiDevices: 'Send message to {0} devices',
        receiverDevices: 'Receiving devices:',
        messageSentMulti: 'Message sent to {0} devices',
        receivedMessage: 'Message Received',
        messageFrom: 'From {0}:',
        themeDark: 'Switched to dark mode',
        themeLight: 'Switched to light mode',
        switchToEnglish: 'Switched to English',
        switchToChinese: 'Switch to Chinese',
        switchTheme: 'Switch Theme',
        about: 'About',
        help: 'Help',
        switchLanguage: 'Switch Language',
        browser: 'Browser',
        phone: 'Phone',
        tablet: 'Tablet',
        computer: 'Computer', 
        unknownDevice: 'Unknown Device',
        requestSendFile: 'Waiting for receiver to accept...',
        selectDevice: 'Select Device',
        device: 'Device',
        files: 'files',
        totalSize: 'Total size',
        fileSize: 'File size',
        receivedFile: 'Received file',
        completed: 'Completed',
        failed: 'Failed',
        rejected: 'Rejected',
        transferCancelled: 'Cancelled',
        formatSeconds: 'sec',
        formatMinutes: 'min',
        formatHours: 'hr',
        sendingFile: 'Sending',
        sending: 'Sending',
      }
    };

    // è·å–ç¿»è¯‘æ–‡æœ¬
    function t(key, ...args) {
      let text = translations[currentLanguage][key] || key;
      
      // æ›¿æ¢å‚æ•° {0}, {1}, ç­‰
      if (args.length > 0) {
        args.forEach((arg, index) => {
          text = text.replace(`{${index}}`, arg);
        });
      }
      
      return text;
    }

    // åˆ‡æ¢è¯­è¨€
    function switchLanguage() {
      currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
      localStorage.setItem('language', currentLanguage);
      updateUI();
      
      // æ›´æ–°é¡µé¢æ ‡é¢˜
      document.title = t('appTitle');
      
      // æ˜¾ç¤ºè¯­è¨€åˆ‡æ¢é€šçŸ¥
      showNotification(t(currentLanguage === 'zh' ? 'switchToChinese' : 'switchToEnglish'));
    }

    // æ›´æ–°UIè¯­è¨€
    function updateUI() {
      // æ›´æ–°è®¾å¤‡åç§°æ ‡ç­¾
      document.querySelector('.device-label span').textContent = t('myDevice');
      
      // æ›´æ–°æŒ‰é’®æ–‡æœ¬
      document.getElementById('uploadFolderBtn').innerHTML = `<i class="ri-folder-upload-line"></i> ${t('uploadFileFolder')}`;
      document.getElementById('sendTextBtn').innerHTML = `<i class="ri-message-2-line"></i> ${t('sendText')}`;
      
      // æ›´æ–°è¯´æ˜æ–‡å­—
      document.querySelector('.instructions').textContent = t('instruction');
      
      // æ›´æ–°æ ‡é¢˜æç¤ºæ–‡æœ¬
      document.querySelector('[title="åˆ‡æ¢ä¸»é¢˜"]').title = t('switchTheme');
      document.querySelector('[title="å…³äº"]').title = t('about');
      document.querySelector('[title="å¸®åŠ©"]').title = t('help');
      document.getElementById('languageToggle').title = t('switchLanguage');
      
      // æ›´æ–°è®¾å¤‡åˆ—è¡¨
      updateDeviceList();
      
      // å¦‚æœæ˜¯è‹±æ–‡æ¨¡å¼ï¼Œæˆ–å±å¹•å®½åº¦å°äº480pxï¼Œåˆ™è°ƒæ•´æŒ‰é’®ä¸ºçºµå‘æ’åˆ—
      const actionButtons = document.querySelector('.action-buttons');
      if (currentLanguage === 'en' || window.innerWidth <= 480) {
        actionButtons.style.flexDirection = 'column';
        const actionBtns = document.querySelectorAll('.action-btn');
        actionBtns.forEach(btn => {
          btn.style.width = '100%';
        });
      } else {
        actionButtons.style.flexDirection = 'row';
        const actionBtns = document.querySelectorAll('.action-btn');
        actionBtns.forEach(btn => {
          btn.style.width = 'auto';
        });
      }
    }

    // æ–‡ä»¶æ¥æ”¶ç®¡ç† - ä½¿ç”¨Mapæ›¿ä»£å…¨å±€windowå˜é‡
    const fileReceivers = new Map();

    // æ£€æŸ¥å’Œåº”ç”¨ä¸»é¢˜è®¾ç½®
    function applyTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeToggle').innerHTML = '<i class="ri-moon-line"></i>';
        isDarkMode = true;
      } else {
        document.documentElement.removeAttribute('data-theme');
        document.getElementById('themeToggle').innerHTML = '<i class="ri-sun-line"></i>';
        isDarkMode = false;
      }
    }

    // åˆ‡æ¢ä¸»é¢˜
    function toggleTheme() {
      if (isDarkMode) {
        localStorage.setItem('theme', 'light');
      } else {
        localStorage.setItem('theme', 'dark');
      }
      applyTheme();
      showNotification(t(isDarkMode ? 'themeDark' : 'themeLight'));
    }

    // é¡µé¢åŠ è½½å®Œæˆå
    window.addEventListener('load', () => {
      // åº”ç”¨ä¿å­˜çš„ä¸»é¢˜
      applyTheme();
      
      // åŠ è½½ä¿å­˜çš„è¯­è¨€è®¾ç½®
      const savedLanguage = localStorage.getItem('language');
      if (savedLanguage && (savedLanguage === 'zh' || savedLanguage === 'en')) {
        currentLanguage = savedLanguage;
        // æ›´æ–°é¡µé¢æ ‡é¢˜
        document.title = t('appTitle');
      }
      
      // æ›´æ–°UIè¯­è¨€
      updateUI();
      
      // éšè—åŠ è½½åŠ¨ç”»
      setTimeout(() => {
        document.querySelector('.load-animation').classList.add('hidden');
      }, 800);
    });

    // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    
    // è¯­è¨€åˆ‡æ¢æŒ‰é’®
    document.getElementById('languageToggle').addEventListener('click', switchLanguage);

    // å‘é€å¿ƒè·³åŒ…
    setInterval(() => { socket.emit('heartbeat'); }, 5000);

    // è·å–è®¾å¤‡ç±»å‹å’Œå›¾æ ‡
    function getDeviceInfo() {
      const ua = navigator.userAgent.toLowerCase();
      let type = t('unknownDevice');
      let icon = 'ri-device-line';
      
      if (ua.includes('iphone') || ua.includes('android') && !ua.includes('tablet')) { 
        type = t('phone'); 
        icon = 'ri-smartphone-line'; 
      }
      else if (ua.includes('ipad') || ua.includes('tablet')) { 
        type = t('tablet'); 
        icon = 'ri-tablet-line'; 
      }
      else if (ua.includes('windows') || ua.includes('macintosh') || ua.includes('linux')) { 
        type = t('computer'); 
        icon = 'ri-computer-line'; 
      }
      
      return { type, icon };
    }

    // æ›´æ–°è®¾å¤‡å›¾æ ‡
    function updateDeviceTypeIcon() {
      const deviceIcon = document.getElementById('deviceTypeIcon');
      if (deviceIcon && myDeviceInfo.icon) {
        deviceIcon.className = myDeviceInfo.icon;
      }
    }

    // é€šçŸ¥
    function showNotification(message) {
      const notification = document.getElementById('notification');
      // å¤„ç†å¯èƒ½è¿‡é•¿çš„æ–‡ä»¶å
      if (message.includes('æ–‡ä»¶') && message.length > 30) {
        // æŸ¥æ‰¾æ–‡ä»¶åéƒ¨åˆ†å¹¶æˆªæ–­
        const parts = message.split('æ–‡ä»¶');
        if (parts.length >= 2) {
          const prefix = parts[0] + 'æ–‡ä»¶';
          let fileName = parts[1].trim();
          if (fileName.startsWith(':')) fileName = fileName.substring(1).trim();
          
          // å¦‚æœæ–‡ä»¶åè¿‡é•¿ï¼Œæˆªæ–­å®ƒ
          if (fileName.length > 15) {
            const extension = fileName.lastIndexOf('.') > 0 ? fileName.substring(fileName.lastIndexOf('.')) : '';
            fileName = fileName.substring(0, 12) + '...' + extension;
          }
          message = prefix + ': ' + fileName;
        }
      }
      
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => { notification.classList.remove('show'); }, 3000);
    }

    // ç”Ÿæˆé»˜è®¤è®¾å¤‡åç§°
    function generateDeviceName() {
      const deviceType = getDeviceInfo().type;
      const randomId = Math.random().toString(36).substring(2, 7);
      return `${deviceType} ${randomId}`;
    }

    // è®¾å¤‡åç§°è®¾ç½®
    const deviceNameInput = document.getElementById('deviceName');
    
    // åˆå§‹åŒ–è®¾å¤‡åç§°
    function initDeviceName() {
      let name = localStorage.getItem('deviceName');
      if (!name) {
        name = generateDeviceName();
        localStorage.setItem('deviceName', name);
      }
      deviceNameInput.value = name;
      return name;
    }
    
    deviceNameInput.addEventListener('change', function() {
      const name = this.value.trim();
      if (name) {
        myDeviceInfo.name = name;
        localStorage.setItem('deviceName', name);
        // å‘é€è®¾å¤‡ä¿¡æ¯æ›´æ–°åˆ°æœåŠ¡å™¨ï¼Œä½¿å…¶ä»–è®¾å¤‡ç«‹å³çœ‹åˆ°æ›´æ”¹
        socket.emit('device-info', { ...getDeviceInfo(), name });
        showNotification('è®¾å¤‡åç§°å·²æ›´æ–°');
      } else {
        // å¦‚æœåç§°ä¸ºç©ºï¼Œæ¢å¤ä¹‹å‰çš„åç§°
        this.value = myDeviceInfo.name || initDeviceName();
      }
    });
    
    deviceNameInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') this.blur();
    });
    
    document.querySelector('.edit-btn').addEventListener('click', () => {
      deviceNameInput.focus();
    });

    // æ–‡ä»¶ä¸Šä¼ 
    const fileInput = document.getElementById('fileInput');
    const mainUploadBtn = document.getElementById('mainUploadBtn');
    
    mainUploadBtn.addEventListener('click', () => {
      const deviceList = Array.from(devices.keys()).filter(id => id !== myDeviceId);
      if (deviceList.length === 0) {
        showNotification('æ²¡æœ‰å¯ç”¨çš„è®¾å¤‡');
        return;
      }
      // å…ˆæ¸…ç©ºinputçš„valueï¼Œç¡®ä¿ç›¸åŒæ–‡ä»¶å¯ä»¥å†æ¬¡é€‰æ‹©
      fileInput.value = '';
      fileInput.click();
    });
    
    mainUploadBtn.addEventListener('dragover', e => { 
      e.preventDefault(); 
      mainUploadBtn.style.transform = 'scale(1.05)';
      mainUploadBtn.style.boxShadow = 'var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15)';
    });
    
    mainUploadBtn.addEventListener('dragleave', e => { 
      mainUploadBtn.style.transform = '';
      mainUploadBtn.style.boxShadow = '';
    });
    
    mainUploadBtn.addEventListener('drop', e => {
      e.preventDefault();
      mainUploadBtn.style.transform = '';
      mainUploadBtn.style.boxShadow = '';
      handleFiles(e.dataTransfer.files);
      // æ¸…ç©ºæ‹–æ”¾äº‹ä»¶æ•°æ®
      e.dataTransfer.clearData();
    });
    
    fileInput.addEventListener('change', e => {
      debugLog('FILE-SELECT', `ç”¨æˆ·é€‰æ‹©äº† ${e.target.files?.length || 0} ä¸ªæ–‡ä»¶`);
      if (e.target.files?.length) {
        handleFiles(e.target.files);
      }
    });

    // æ–‡ä»¶å¤¹ä¸Šä¼ 
    const folderInput = document.getElementById('folderInput');
    document.getElementById('uploadFolderBtn').onclick = () => {
      const deviceList = Array.from(devices.keys()).filter(id => id !== myDeviceId);
      if (deviceList.length === 0) {
        showNotification('æ²¡æœ‰å¯ç”¨çš„è®¾å¤‡');
        return;
      }
      // å…ˆæ¸…ç©ºinputçš„value
      folderInput.value = '';
      folderInput.click();
    };
    folderInput.addEventListener('change', e => {
      debugLog('FOLDER-SELECT', `ç”¨æˆ·é€‰æ‹©äº† ${e.target.files?.length || 0} ä¸ªæ–‡ä»¶`);
      if (e.target.files?.length) {
        handleFiles(e.target.files);
      }
    });

    // å‘é€æ–‡æœ¬æ¶ˆæ¯
    document.getElementById('sendTextBtn').addEventListener('click', () => {
      const deviceList = Array.from(devices.keys()).filter(id => id !== myDeviceId);
      if (deviceList.length === 0) {
        showNotification('æ²¡æœ‰å¯ç”¨çš„è®¾å¤‡');
        return;
      }
      
      // å¦‚æœå·²ç»é€‰æ‹©äº†å¤šä¸ªè®¾å¤‡ï¼Œç›´æ¥ä½¿ç”¨è¿™äº›è®¾å¤‡
      if (selectedDevices.size > 0) {
        showMessageInputMulti(Array.from(selectedDevices));
      } 
      // å¦‚æœå·²ç»é€‰æ‹©äº†å•ä¸ªè®¾å¤‡ï¼Œä½¿ç”¨è¯¥è®¾å¤‡
      else if (selectedDeviceId) {
        showMessageInput(selectedDeviceId);
      } 
      // å¦åˆ™æ˜¾ç¤ºè®¾å¤‡é€‰æ‹©
      else {
        showDeviceSelector(deviceList, (targetIds) => {
          if (targetIds.length === 1) {
            showMessageInput(targetIds[0]);
          } else if (targetIds.length > 1) {
            showMessageInputMulti(targetIds);
          }
        });
      }
    });

    // å¤„ç†æ–‡ä»¶
    function handleFiles(files) {
      if (!files || files.length === 0) return;
      
      const deviceList = Array.from(devices.keys()).filter(id => id !== myDeviceId);
      if (deviceList.length === 0) { 
        showNotification('æ²¡æœ‰å¯ç”¨çš„è®¾å¤‡'); 
        return; 
      }
      
      // å¦‚æœå·²ç»é€‰æ‹©äº†å¤šä¸ªè®¾å¤‡ï¼Œç›´æ¥ä½¿ç”¨è¿™äº›è®¾å¤‡
      if (selectedDevices.size > 0) {
        showFileTransferConfirmMulti(files, Array.from(selectedDevices));
      } 
      // å¦‚æœå·²ç»é€‰æ‹©äº†å•ä¸ªè®¾å¤‡ï¼Œä½¿ç”¨è¯¥è®¾å¤‡
      else if (selectedDeviceId) {
        showFileTransferConfirm(files, selectedDeviceId);
      } 
      // å¦åˆ™æ˜¾ç¤ºè®¾å¤‡é€‰æ‹©
      else {
        showDeviceSelector(deviceList, (targetIds) => {
          if (targetIds.length === 1) {
            showFileTransferConfirm(files, targetIds[0]);
          } else if (targetIds.length > 1) {
            showFileTransferConfirmMulti(files, targetIds);
          }
        });
      }
    }
    
    // æ˜¾ç¤ºè®¾å¤‡é€‰æ‹©å™¨
    function showDeviceSelector(deviceList, callback) {
      let deviceListHtml = '<div class="device-select-container">';
      
      deviceList.forEach(deviceId => {
        const device = devices.get(deviceId);
        if (!device) return;
        
        const name = device.name || `${t('device')} ${deviceId.slice(0, 6)}`;
        const icon = device.icon || 'ri-device-line';
        
        deviceListHtml += `
          <div class="device-option" data-id="${deviceId}">
            <div class="checkbox"><i class="ri-check-line"></i></div>
            <i class="${icon}"></i>
            <span>${name}</span>
          </div>
        `;
      });
      
      deviceListHtml += '</div>';
      deviceListHtml += `<span class="device-select-all">${t('selectAll')}</span>`;
      
      showModal(
        t('selectDeviceTitle'),
        deviceListHtml,
        [
          {
            text: t('confirm'),
            class: 'primary',
            action: () => {
              const selectedIds = [];
              document.querySelectorAll('.device-option .checkbox.checked').forEach(checkbox => {
                const deviceId = checkbox.parentElement.dataset.id;
                selectedIds.push(deviceId);
              });
              
              if (selectedIds.length === 0) {
                showNotification(t('selectAtLeastOne'));
                return;
              }
              
              closeModal();
              callback(selectedIds);
            }
          },
          {
            text: t('cancel'),
            class: 'secondary',
            action: closeModal
          }
        ]
      );
      
      // è®¾ç½®ç‚¹å‡»äº‹ä»¶
      setTimeout(() => {
        const checkboxes = document.querySelectorAll('.device-option');
        checkboxes.forEach(option => {
          option.addEventListener('click', () => {
            const checkbox = option.querySelector('.checkbox');
            checkbox.classList.toggle('checked');
          });
        });
        
        const selectAllBtn = document.querySelector('.device-select-all');
        selectAllBtn.addEventListener('click', () => {
          const allChecked = document.querySelectorAll('.device-option .checkbox.checked').length === checkboxes.length;
          
          checkboxes.forEach(option => {
            const checkbox = option.querySelector('.checkbox');
            if (allChecked) {
              checkbox.classList.remove('checked');
            } else {
              checkbox.classList.add('checked');
            }
          });
        });
      }, 100);
    }
    
    // ç¡®è®¤æ–‡ä»¶ä¼ è¾“åˆ°å•ä¸ªè®¾å¤‡
    function showFileTransferConfirm(files, targetId) {
      const device = devices.get(targetId);
      const deviceName = device ? device.name || `${t('device')} ${targetId.slice(0, 6)}` : `${t('device')} ${targetId.slice(0, 6)}`;
      
      let fileListHtml = '';
      if (files.length <= 3) {
        for (const file of files) {
          // å¤„ç†é•¿æ–‡ä»¶å
          const fileName = truncateFileName(file.name, 20);
          fileListHtml += `<div style="text-align:left;margin:3px 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
            <i class="ri-file-line"></i> ${fileName} (${formatFileSize(file.size)})
          </div>`;
        }
      } else {
        fileListHtml = `<div>${files.length} ${t('files')}, ${t('totalSize')}: ${formatFileSize(Array.from(files).reduce((total, file) => total + file.size, 0))}</div>`;
      }
      
      showModal(
        t('sendToDevice', deviceName),
        `<div style="margin-bottom:1rem;">${fileListHtml}</div>`,
        [
          { 
            text: t('send'), 
            class: 'primary', 
            action: () => {
              for (const file of files) {
                startFileTransfer(file, targetId);
              }
              closeModal();
              
              // æ¸…é™¤è¾“å…¥çŠ¶æ€ï¼Œç¡®ä¿åŒä¸€æ–‡ä»¶å¯ä»¥å†æ¬¡é€‰æ‹©
              fileInput.value = '';
              folderInput.value = '';
            }
          },
          { 
            text: t('cancel'), 
            class: 'secondary', 
            action: () => {
              closeModal();
              // æ¸…é™¤è¾“å…¥çŠ¶æ€
              fileInput.value = '';
              folderInput.value = '';
            } 
          }
        ]
      );
    }
    
    // ç¡®è®¤æ–‡ä»¶ä¼ è¾“åˆ°å¤šä¸ªè®¾å¤‡
    function showFileTransferConfirmMulti(files, targetIds) {
      const deviceNames = targetIds.map(id => {
        const device = devices.get(id);
        return device ? device.name || `${t('device')} ${id.slice(0, 6)}` : `${t('device')} ${id.slice(0, 6)}`;
      });
      
      let fileListHtml = '';
      if (files.length <= 3) {
        for (const file of files) {
          // å¤„ç†é•¿æ–‡ä»¶å
          const fileName = truncateFileName(file.name, 20);
          fileListHtml += `<div style="text-align:left;margin:3px 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
            <i class="ri-file-line"></i> ${fileName} (${formatFileSize(file.size)})
          </div>`;
        }
      } else {
        fileListHtml = `<div>${files.length} ${t('files')}, ${t('totalSize')}: ${formatFileSize(Array.from(files).reduce((total, file) => total + file.size, 0))}</div>`;
      }
      
      showModal(
        t('sendToMultiDevices', targetIds.length),
        `
          <div style="margin-bottom:1rem;">${fileListHtml}</div>
          <div style="font-size:0.875rem;color:var(--color-text-secondary);margin-bottom:0.5rem;">${t('receiverDevices')}</div>
          <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;">
            ${deviceNames.map(name => `<span style="background:var(--color-surface);padding:2px 8px;border-radius:var(--radius-full);font-size:0.75rem;">${name}</span>`).join('')}
          </div>
        `,
        [
          { 
            text: t('send'), 
            class: 'primary', 
            action: () => {
              for (const file of files) {
                // è®°å½•å¼€å§‹æ—¶é—´ç”¨äºè®¡ç®—æ€»é€Ÿåº¦
                const startTime = Date.now();
                
                // ä¸ºæ¯ä¸ªç›®æ ‡è®¾å¤‡å•ç‹¬å¯åŠ¨ä¼ è¾“
                const transferMappings = [];
                for (const targetId of targetIds) {
                  const transferId = startFileTransfer(file, targetId);
                  transferMappings.push({ targetId, transferId });
                  // å»ºç«‹æ˜ å°„å…³ç³»
                  fileTransferMappings.set(transferId, targetId);
                }
                
                debugLog('MULTI-SEND', `å¤šè®¾å¤‡ä¼ è¾“å¼€å§‹`, { 
                  fileName: file.name, 
                  targetCount: targetIds.length, 
                  mappings: transferMappings 
                });
              }
              closeModal();
              showNotification(t('fileSending', targetIds.length, files.length));
              
              // æ¸…é™¤è¾“å…¥çŠ¶æ€ï¼Œç¡®ä¿åŒä¸€æ–‡ä»¶å¯ä»¥å†æ¬¡é€‰æ‹©
              fileInput.value = '';
              folderInput.value = '';
            }
          },
          { 
            text: t('cancel'), 
            class: 'secondary', 
            action: () => {
              closeModal();
              // æ¸…é™¤è¾“å…¥çŠ¶æ€
              fileInput.value = '';
              folderInput.value = '';
            }
          }
        ]
      );
    }

    // æ¶ˆæ¯è¾“å…¥åˆ°å•ä¸ªè®¾å¤‡
    function showMessageInput(targetId) {
      const device = devices.get(targetId);
      const deviceName = device ? device.name || `è®¾å¤‡ ${targetId.slice(0, 6)}` : `è®¾å¤‡ ${targetId.slice(0, 6)}`;
      
      showModal(
        `å‘é€æ¶ˆæ¯è‡³ ${deviceName}`,
        `<textarea id='msgInput' style='width:100%;height:100px;border-radius:var(--radius-md);border:1px solid var(--color-border);padding:0.75rem;font-size:0.875rem;resize:none;outline:none;background:var(--color-surface);color:var(--color-text-primary);'></textarea>`,
        [
          { 
            text: 'å‘é€', 
            class: 'primary', 
            action: () => {
              const msg = document.getElementById('msgInput').value.trim();
              if (msg) {
                socket.emit('send-message', { targetId, message: msg });
                showNotification('æ¶ˆæ¯å·²å‘é€');
              }
              closeModal();
            }
          },
          { 
            text: 'å–æ¶ˆ', 
            class: 'secondary', 
            action: closeModal 
          }
        ]
      );
      
      // è‡ªåŠ¨èšç„¦æ–‡æœ¬æ¡†
      setTimeout(() => {
        document.getElementById('msgInput').focus();
      }, 300);
    }
    
    // æ¶ˆæ¯è¾“å…¥åˆ°å¤šä¸ªè®¾å¤‡
    function showMessageInputMulti(targetIds) {
      const deviceNames = targetIds.map(id => {
        const device = devices.get(id);
        return device ? device.name || `è®¾å¤‡ ${id.slice(0, 6)}` : `è®¾å¤‡ ${id.slice(0, 6)}`;
      });
      
      showModal(
        `å‘é€æ¶ˆæ¯è‡³ ${targetIds.length} ä¸ªè®¾å¤‡`,
        `
          <div style="font-size:0.875rem;color:var(--color-text-secondary);margin-bottom:0.5rem;">æ¥æ”¶è®¾å¤‡ï¼š</div>
          <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;">
            ${deviceNames.map(name => `<span style="background:var(--color-surface);padding:2px 8px;border-radius:var(--radius-full);font-size:0.75rem;">${name}</span>`).join('')}
          </div>
          <textarea id='msgInput' style='width:100%;height:100px;border-radius:var(--radius-md);border:1px solid var(--color-border);padding:0.75rem;font-size:0.875rem;resize:none;outline:none;background:var(--color-surface);color:var(--color-text-primary);'></textarea>
        `,
        [
          { 
            text: 'å‘é€', 
            class: 'primary', 
            action: () => {
              const msg = document.getElementById('msgInput').value.trim();
              if (msg) {
                for (const targetId of targetIds) {
                  socket.emit('send-message', { targetId, message: msg });
                }
                showNotification(`å·²å‘ ${targetIds.length} ä¸ªè®¾å¤‡å‘é€æ¶ˆæ¯`);
              }
              closeModal();
            }
          },
          { 
            text: 'å–æ¶ˆ', 
            class: 'secondary', 
            action: closeModal 
          }
        ]
      );
      
      // è‡ªåŠ¨èšç„¦æ–‡æœ¬æ¡†
      setTimeout(() => {
        document.getElementById('msgInput').focus();
      }, 300);
    }

    // æ–‡ä»¶ä¼ è¾“
    function startFileTransfer(file, targetId) {
      // ä½¿ç”¨æ›´å¤æ‚çš„æ–¹å¼ç”Ÿæˆå”¯ä¸€IDï¼Œç¡®ä¿æ¯æ¬¡ä¼ è¾“çš„IDéƒ½ä¸åŒ
      const transferId = `${Date.now().toString()}-${Math.random().toString(36).substr(2, 9)}-${file.name.substring(0, 6).replace(/\s+/g, '-')}`;
      
      activeTransfers.set(transferId, { 
        file, 
        targetId, 
        progress: 0, 
        startTime: Date.now(),
        name: file.name,
        size: file.size,
        status: 'waiting' // æ–°çŠ¶æ€ï¼šç­‰å¾…æ¥æ”¶æ–¹ç¡®è®¤
      });
      
      debugLog('SEND', `è¯·æ±‚ä¼ è¾“æ–‡ä»¶ ${file.name} åˆ° ${targetId}`, {
        transferId,
        fileSize: file.size
      });
      
      // æ·»åŠ åˆ°æ˜ å°„è¡¨
      fileTransferMappings.set(transferId, targetId);
      
      // å‘é€ä¼ è¾“è¯·æ±‚ï¼Œç­‰å¾…ç¡®è®¤
      socket.emit('file-transfer-request', { 
        targetId, 
        fileName: file.name, 
        fileSize: file.size, 
        transferId 
      });
      
      // æ˜¾ç¤ºç­‰å¾…æ¥æ”¶æ–¹ç¡®è®¤çš„è¿›åº¦UI
      showTransferWaitingUI(transferId);
      
      showNotification(t('requestSendFile'));
      
      return transferId;
    }

    // æ˜¾ç¤ºç­‰å¾…æ¥æ”¶æ–¹ç¡®è®¤çš„UI
    function showTransferWaitingUI(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) return;
      
      debugLog('UI', 'æ˜¾ç¤ºç­‰å¾…ç¡®è®¤UI', { transferId });
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      if (document.getElementById(`send-${transferId}`)) return;
      
      // å‡†å¤‡æ˜¾ç¤ºåç§°ï¼Œé¿å…è¿‡é•¿
      const fileName = transfer.name.length > 15 ? 
        transfer.name.substring(0, 12) + '...' + 
        transfer.name.substring(transfer.name.lastIndexOf('.')) : 
        transfer.name;
      
      // åˆ›å»ºç­‰å¾…UIå…ƒç´ 
      const waitingElement = document.createElement('div');
      waitingElement.id = `send-${transferId}`;
      waitingElement.className = 'transfer-progress-container';
      waitingElement.style.position = 'fixed';
      waitingElement.style.top = '70px';
      waitingElement.style.right = '1rem';
      waitingElement.style.background = 'var(--color-background)';
      waitingElement.style.borderRadius = 'var(--radius-lg)';
      waitingElement.style.padding = '0.75rem 1rem';
      waitingElement.style.boxShadow = 'var(--shadow-md)';
      waitingElement.style.width = '280px';
      waitingElement.style.zIndex = '100';
      
      waitingElement.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
          <div style="font-size:0.875rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px;">
            <i class="ri-upload-line"></i> ${fileName}
          </div>
          <div style="font-size:0.75rem;color:var(--color-text-tertiary);" class="transfer-size">
            ${formatFileSize(transfer.size)}
          </div>
        </div>
        <div class="transfer-progress">
          <div class="progress-bar progress-bar-waiting" style="width:100%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--color-text-tertiary);margin-top:0.25rem;">
          <span class="progress-text">ç­‰å¾…ç¡®è®¤...</span>
          <button class="cancel-transfer" title="å–æ¶ˆ" style="background:none;border:none;color:var(--color-text-tertiary);cursor:pointer;padding:0;">
            <i class="ri-close-line"></i>
          </button>
        </div>
      `;
      
      document.body.appendChild(waitingElement);
      
      // æ·»åŠ CSSæ ·å¼
      if (!document.getElementById('transfer-waiting-style')) {
        const styleElement = document.createElement('style');
        styleElement.id = 'transfer-waiting-style';
        styleElement.textContent = `
          .progress-bar-waiting {
            background: #999;
            animation: progress-waiting 1.5s ease-in-out infinite;
            background-image: linear-gradient(
              -45deg,
              rgba(255, 255, 255, 0.2) 25%,
              transparent 25%,
              transparent 50%,
              rgba(255, 255, 255, 0.2) 50%,
              rgba(255, 255, 255, 0.2) 75%,
              transparent 75%,
              transparent
            );
            background-size: 50px 50px;
          }
          
          @keyframes progress-waiting {
            0% {
              background-position: 0 0;
            }
            100% {
              background-position: 50px 50px;
            }
          }
        `;
        document.head.appendChild(styleElement);
      }
      
      // æ·»åŠ å–æ¶ˆæŒ‰é’®äº‹ä»¶ç›‘å¬
      const cancelButton = waitingElement.querySelector('.cancel-transfer');
      if (cancelButton) {
        cancelButton.addEventListener('click', () => {
          cancelTransfer(transferId);
        });
      }
    }

    // æ˜¾ç¤ºä¼ è¾“è¢«æ‹’ç»çš„UI
    function showTransferRejectedUI(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) return;
      
      transfer.status = 'rejected';
      activeTransfers.set(transferId, transfer);
      
      // æ›´æ–°UI
      updateTransferProgress(transferId);
    }

    // å•ç‹¬çš„å‘é€æ–‡ä»¶æ•°æ®å‡½æ•°
    function sendFileData(file, targetId, transferId) {
      const chunkSize = 64 * 1024; // 64KB
      let offset = 0;
      let lastUpdateTime = Date.now();
      
      function readNextChunk() {
        const transfer = activeTransfers.get(transferId);
        if (!transfer || transfer.status !== 'active') {
          debugLog('SEND', `ä¼ è¾“ ${transferId} å·²åœæ­¢æˆ–å–æ¶ˆ`);
          return; // å¦‚æœä¼ è¾“å·²å–æ¶ˆæˆ–å®Œæˆï¼Œåœæ­¢å¤„ç†
        }
        
        const chunk = file.slice(offset, offset + chunkSize);
        const reader = new FileReader();
        
        reader.onload = (e) => {
          // å†æ¬¡æ£€æŸ¥ä¼ è¾“çŠ¶æ€
          const transfer = activeTransfers.get(transferId);
          if (!transfer || transfer.status !== 'active') {
            return; // å¦‚æœä¼ è¾“å·²å–æ¶ˆæˆ–å®Œæˆï¼Œåœæ­¢å¤„ç†
          }
          
          debugLog('SEND', `å‘é€æ•°æ®å— ${Math.round((offset / file.size) * 100)}%`, {
            transferId,
            offset,
            chunkSize: chunk.size
          });
          
          socket.emit('file-data', { 
            targetId, 
            chunk: e.target.result, 
            offset, 
            totalSize: file.size, 
            transferId, 
            fileName: file.name 
          });
          
          offset += chunk.size;
          
          // æ›´æ–°è¿›åº¦
          if (transfer) {
            const now = Date.now();
            transfer.progress = (offset / file.size) * 100;
            
            // è®¡ç®—é€Ÿåº¦ï¼ˆæ¯ 500ms æ›´æ–°ä¸€æ¬¡ï¼‰
            if (now - lastUpdateTime > 500) {
              const elapsedTime = (now - transfer.startTime) / 1000; // ç§’
              if (elapsedTime > 0) {
                transfer.speed = offset / elapsedTime; // å­—èŠ‚/ç§’
              }
              lastUpdateTime = now;
              updateTransferProgress(transferId);
            }
            
            activeTransfers.set(transferId, transfer);
          }
          
          if (offset < file.size) {
            // ä½¿ç”¨setTimeoutæ·»åŠ å°å»¶è¿Ÿï¼Œé¿å…çŸ­æ—¶é—´å†…å‘é€è¿‡å¤šæ•°æ®
            setTimeout(readNextChunk, 10);
          } else {
            // ä¼ è¾“å®Œæˆ
            debugLog('SEND', `æ–‡ä»¶ ${file.name} ä¼ è¾“å®Œæˆ`);
            const transfer = activeTransfers.get(transferId);
            if (transfer) {
              transfer.progress = 100;
              transfer.status = 'completed';
              activeTransfers.set(transferId, transfer);
              updateTransferProgress(transferId);
            }
            showNotification(`æ–‡ä»¶ ${file.name} ä¼ è¾“å®Œæˆ`);
            
            // å‡ ç§’åç§»é™¤è¿›åº¦æ¡
            setTimeout(() => {
              document.getElementById(`send-${transferId}`)?.remove();
            }, 3000);
          }
        };
        
        reader.onerror = (err) => {
          debugLog('SEND ERROR', `è¯»å–æ–‡ä»¶å—å‡ºé”™: ${err}`);
          const transfer = activeTransfers.get(transferId);
          if (transfer) {
            transfer.status = 'failed';
            activeTransfers.set(transferId, transfer);
            updateTransferProgress(transferId);
            showNotification(`æ–‡ä»¶ ${file.name} ä¼ è¾“å¤±è´¥`);
          }
        };
        
        reader.readAsArrayBuffer(chunk);
      }
      
      readNextChunk();
    }

    // å–æ¶ˆæ–‡ä»¶ä¼ è¾“
    function cancelTransfer(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) return;
      
      debugLog('CANCEL', `å–æ¶ˆæ–‡ä»¶ä¼ è¾“`, { transferId, status: transfer.status });
      
      // æ›´æ–°çŠ¶æ€
      transfer.status = 'cancelled';
      activeTransfers.set(transferId, transfer);
      
      // é€šçŸ¥å¯¹æ–¹ä¼ è¾“å·²å–æ¶ˆ
      if (transfer.targetId) {
        socket.emit('cancel-transfer', {
          targetId: transfer.targetId,
          transferId
        });
      }
      
      // æ›´æ–°UI
      updateTransferProgress(transferId);
      
      // æ˜¾ç¤ºé€šçŸ¥
      const actionText = transfer.targetId ? 'å‘é€' : 'æ¥æ”¶';
      showNotification(`å·²å–æ¶ˆ${actionText}æ–‡ä»¶ ${transfer.name}`);
      
      // ä¸€æ®µæ—¶é—´åç§»é™¤UI
      setTimeout(() => {
        const element = document.getElementById(`send-${transferId}`);
        if (element) {
          element.style.opacity = '0';
          element.style.transition = 'opacity 0.5s ease';
          setTimeout(() => element.remove(), 500);
        }
      }, 3000);
    }
    
    // æ˜¾ç¤ºä¼ è¾“è¿›åº¦
    function showTransferProgress(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) {
        debugLog('ERROR', 'æ— æ³•æ˜¾ç¤ºè¿›åº¦ï¼šæ‰¾ä¸åˆ°transferId', { transferId });
        return;
      }
      
      // æ¸…é™¤ç°æœ‰çš„è¿›åº¦UIï¼ˆå¦‚æœæœ‰ï¼‰
      const existingUI = document.getElementById(`send-${transferId}`);
      if (existingUI) existingUI.remove();
      
      debugLog('UI', 'åˆ›å»ºæ–‡ä»¶ä¼ è¾“è¿›åº¦UI', { transferId, status: transfer.status });
      
      // å‡†å¤‡æ˜¾ç¤ºåç§°ï¼Œé¿å…è¿‡é•¿
      const fileName = transfer.name.length > 15 ? 
        transfer.name.substring(0, 12) + '...' + 
        transfer.name.substring(transfer.name.lastIndexOf('.')) : 
        transfer.name;
      
      // åˆ›å»ºè¿›åº¦æ¡å…ƒç´ 
      const progressElement = document.createElement('div');
      progressElement.id = `send-${transferId}`;
      progressElement.className = 'transfer-progress-container';
      progressElement.style.position = 'fixed';
      progressElement.style.top = '70px';
      progressElement.style.right = '1rem';
      progressElement.style.background = 'var(--color-background)';
      progressElement.style.borderRadius = 'var(--radius-lg)';
      progressElement.style.padding = '0.75rem 1rem';
      progressElement.style.boxShadow = 'var(--shadow-md)';
      progressElement.style.width = '280px';
      progressElement.style.zIndex = '100';
      
      progressElement.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
          <div style="font-size:0.875rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px;">
            <i class="ri-upload-line"></i> ${fileName}
          </div>
          <div style="font-size:0.75rem;color:var(--color-text-tertiary);" class="transfer-size">
            ${formatFileSize(transfer.size)}
          </div>
        </div>
        <div class="transfer-progress">
          <div class="progress-bar" style="width:0%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--color-text-tertiary);margin-top:0.25rem;">
          <div>
            <span class="progress-text">0%</span>
            <span class="progress-speed">å‡†å¤‡ä¸­...</span>
          </div>
          <button class="cancel-transfer" title="å–æ¶ˆ" style="background:none;border:none;color:var(--color-text-tertiary);cursor:pointer;padding:0;">
            <i class="ri-close-line"></i>
          </button>
        </div>
      `;
      
      document.body.appendChild(progressElement);
      
      // æ·»åŠ å–æ¶ˆæŒ‰é’®äº‹ä»¶ç›‘å¬
      const cancelButton = progressElement.querySelector('.cancel-transfer');
      if (cancelButton) {
        cancelButton.addEventListener('click', () => {
          cancelTransfer(transferId);
        });
      }
      
      // åˆå§‹æ›´æ–°
      updateTransferProgress(transferId);
    }
    
    // æ›´æ–°ä¼ è¾“è¿›åº¦
    function updateTransferProgress(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) return;
      
      const progressContainer = document.getElementById(`send-${transferId}`);
      if (!progressContainer) {
        // å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºå®ƒ
        showTransferProgress(transferId);
        return;
      }
      
      const progressBar = progressContainer.querySelector('.progress-bar');
      const progressText = progressContainer.querySelector('.progress-text');
      const speedText = progressContainer.querySelector('.progress-speed');
      const cancelButton = progressContainer.querySelector('.cancel-transfer');
      
      // æ£€æŸ¥æ‰€æœ‰å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (!progressBar || !progressText) {
        debugLog('ERROR', 'è¿›åº¦UIå…ƒç´ ä¸å®Œæ•´ï¼Œé‡æ–°åˆ›å»º', { transferId });
        progressContainer.remove();
        showTransferProgress(transferId);
        return;
      }
      
      // æ ¹æ®ä¼ è¾“çŠ¶æ€æ›´æ–°UI
      switch (transfer.status) {
        case 'active':
          progressBar.style.width = `${transfer.progress}%`;
          progressText.textContent = `${Math.round(transfer.progress)}%`;
          
          if (transfer.speed) {
            speedText.textContent = `${formatFileSize(transfer.speed)}/s`;
          } else {
            speedText.textContent = `${t('preparing')}`;
          }
          
          if (cancelButton) cancelButton.style.display = 'block';
          break;
          
        case 'completed':
          progressBar.style.width = '100%';
          progressText.textContent = '100%';
          speedText.textContent = t('completed');
          if (cancelButton) cancelButton.style.display = 'none';
          
          // å‡ ç§’åç§»é™¤UI
          setTimeout(() => {
            progressContainer.remove();
          }, 3000);
          break;
          
        case 'cancelled':
          progressBar.style.width = `${transfer.progress}%`;
          progressBar.style.background = 'var(--color-text-tertiary)';
          progressText.textContent = t('transferCancelled');
          speedText.textContent = '';
          if (cancelButton) cancelButton.style.display = 'none';
          
          // å‡ ç§’åç§»é™¤UI
          setTimeout(() => {
            progressContainer.remove();
          }, 3000);
          break;
          
        case 'failed':
          progressBar.style.width = `${transfer.progress}%`;
          progressBar.style.background = '#EF4444';
          progressText.textContent = t('failed');
          speedText.textContent = '';
          if (cancelButton) cancelButton.style.display = 'none';
          
          // å‡ ç§’åç§»é™¤UI
          setTimeout(() => {
            progressContainer.remove();
          }, 3000);
          break;
          
        case 'rejected':
          progressBar.style.width = '100%';
          progressBar.style.background = '#EF4444';
          progressText.textContent = t('rejected');
          speedText.textContent = '';
          if (cancelButton) cancelButton.style.display = 'none';
          
          // å‡ ç§’åç§»é™¤UI
          setTimeout(() => {
            progressContainer.remove();
          }, 3000);
          break;
      }
    }

    // æ–‡ä»¶æ¥æ”¶ - å®Œå…¨é‡å†™
    function handleFileReceive(data) {
      const sender = devices.get(data.fromId);
      const senderName = sender ? sender.name || `${t('device')} ${data.fromId.slice(0, 6)}` : `${t('device')} ${data.fromId.slice(0, 6)}`;
      const transferId = data.transferId || `receive-${Date.now()}`;
      
      // å¤„ç†é•¿æ–‡ä»¶å
      const fileName = truncateFileName(data.fileName, 25);
      
      debugLog('RECEIVE', 'æ”¶åˆ°æ–‡ä»¶ä¼ è¾“è¯·æ±‚', { 
        fromId: data.fromId, 
        fileName: data.fileName, 
        fileSize: data.fileSize,
        transferId: transferId
      });
      
      showModal(
        t('receiveFiles'),
        `<div style="margin-bottom:1rem;">
          <div style="margin-bottom:0.5rem;font-weight:500;">${t('receivingFromDevice', senderName)}</div>
          <div style="display:flex;align-items:center;gap:0.5rem;border-radius:var(--radius-md);background:var(--color-surface);padding:0.75rem;">
            <i class="ri-file-line" style="font-size:1.5rem;color:var(--color-primary);"></i>
            <div style="max-width:calc(100% - 2.5rem);overflow:hidden;">
              <div style="font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${fileName}</div>
              <div style="font-size:0.75rem;color:var(--color-text-tertiary);">${formatFileSize(data.fileSize)}</div>
            </div>
          </div>
        </div>`,
        [
          { 
            text: t('receive'), 
            class: 'primary', 
            action: () => { 
              debugLog('RECEIVE', 'ç”¨æˆ·æ¥å—æ–‡ä»¶ä¼ è¾“');
              
              // 1. å‘é€æ¥å—å“åº”ç»™å‘é€æ–¹
              socket.emit('file-transfer-response', {
                targetId: data.fromId,
                transferId: transferId,
                accepted: true
              });
              
              // 2. åˆ›å»ºæ¥æ”¶çŠ¶æ€
              fileReceivers.set(transferId, {
                fileName: data.fileName,
                fileSize: data.fileSize,
                chunks: [],
                receivedSize: 0,
                active: true,
                startTime: Date.now()
              });
              
              // 3. æ˜¾ç¤ºæ¥æ”¶è¿›åº¦UI
              createReceiveProgressUI(transferId, data.fileName, data.fileSize);
              
              showNotification(t('fileReceiving', data.fileName));
              closeModal(); 
            } 
          },
          { 
            text: t('reject'), 
            class: 'secondary', 
            action: () => { 
              debugLog('RECEIVE', 'ç”¨æˆ·æ‹’ç»æ–‡ä»¶ä¼ è¾“');
              
              // å‘é€æ‹’ç»å“åº”ç»™å‘é€æ–¹
              socket.emit('file-transfer-response', {
                targetId: data.fromId,
                transferId: transferId,
                accepted: false
              });
              
              closeModal(); 
            }
          }
        ]
      );
    }
    
    // åˆ›å»ºæ–‡ä»¶æ¥æ”¶è¿›åº¦UI
    function createReceiveProgressUI(transferId, fileName, fileSize) {
      const containerId = `receive-${transferId}`;
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      if (document.getElementById(containerId)) return;
      
      // å¤„ç†é•¿æ–‡ä»¶å
      const truncatedFileName = truncateFileName(fileName, 20);
      
      const container = document.createElement('div');
      container.id = containerId;
      container.className = 'transfer-progress-container';
      container.style.position = 'fixed';
      container.style.bottom = '70px';
      container.style.left = '50%';
      container.style.transform = 'translateX(-50%)';
      container.style.background = 'var(--color-background)';
      container.style.borderRadius = 'var(--radius-lg)';
      container.style.padding = '0.75rem 1rem';
      container.style.boxShadow = 'var(--shadow-md)';
      container.style.width = '280px';
      container.style.zIndex = '50';
      
      container.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
          <div style="font-size:0.875rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px;">
            ${t('receiving')}: ${truncatedFileName}
          </div>
          <div style="font-size:0.75rem;color:var(--color-text-tertiary);" class="transfer-size">
            ${formatFileSize(fileSize)}
          </div>
        </div>
        <div class="transfer-progress">
          <div class="progress-bar" style="width:0%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--color-text-tertiary);margin-top:0.25rem;">
          <span class="progress-text">0%</span>
          <span class="progress-speed">${t('receiving')}...</span>
        </div>
      `;
      
      document.body.appendChild(container);
      debugLog('UI', 'åˆ›å»ºæ¥æ”¶è¿›åº¦UI');
    }
    
    // æ›´æ–°æ¥æ”¶è¿›åº¦UI
    function updateReceiveProgressUI(transferId, progress, status = 'active') {
      const container = document.getElementById(`receive-${transferId}`);
      if (!container) return;
      
      const progressBar = container.querySelector('.progress-bar');
      const progressText = container.querySelector('.progress-text');
      const speedText = container.querySelector('.progress-speed');
      
      // ç¡®ä¿è¿›åº¦ä¸è¶…è¿‡100%
      progress = Math.min(100, progress);
      
      switch (status) {
        case 'active':
          progressBar.style.width = `${progress}%`;
          progressText.textContent = `${Math.round(progress)}%`;
          break;
          
        case 'completed':
          progressBar.style.width = '100%';
          progressText.textContent = '100%';
          speedText.textContent = t('completed');
          
          // å‡ ç§’åç§»é™¤UI
          setTimeout(() => {
            container.remove();
          }, 3000);
          break;
          
        case 'failed':
          progressBar.style.width = `${progress}%`;
          progressBar.style.background = '#EF4444';
          progressText.textContent = t('failed');
          speedText.textContent = '';
          
          // å‡ ç§’åç§»é™¤UI
          setTimeout(() => {
            container.remove();
          }, 3000);
          break;
      }
    }
    
    // é‡å†™æ–‡ä»¶æ•°æ®æ¥æ”¶å¤„ç†
    socket.on('file-data', (data) => {
      try {
        const transferId = data.transferId || 'default';
        
        debugLog('FILE-DATA', 'æ”¶åˆ°æ–‡ä»¶æ•°æ®', { 
          transferId,
          chunkType: data.chunk ? (typeof data.chunk) : 'æœªçŸ¥',
          chunkConstructor: data.chunk ? (data.chunk.constructor ? data.chunk.constructor.name : 'æœªçŸ¥') : 'æœªçŸ¥',
          offset: data.offset,
          totalSize: data.totalSize
        });
        
        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¥æ”¶çŠ¶æ€
        if (!fileReceivers.has(transferId)) {
          debugLog('FILE-DATA', 'æœªæ‰¾åˆ°æ¥æ”¶çŠ¶æ€ï¼Œå¿½ç•¥æ•°æ®');
          return;
        }
        
        const receiver = fileReceivers.get(transferId);
        
        // æ£€æŸ¥æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€
        if (!receiver.active) {
          debugLog('FILE-DATA', 'æ¥æ”¶å·²åœæ­¢ï¼Œå¿½ç•¥æ•°æ®');
          return;
        }
        
        // å¤„ç†æ•°æ®å—
        let chunk = data.chunk;
        let chunkSize = 0;
        
        // å°è¯•ç¡®å®šæ•°æ®å¤§å°
        if (chunk.byteLength !== undefined) {
          chunkSize = chunk.byteLength;
        } else if (chunk.length !== undefined) {
          chunkSize = chunk.length;
        } else {
          debugLog('FILE-DATA', 'æ— æ³•ç¡®å®šæ•°æ®å—å¤§å°ï¼Œä½¿ç”¨ä¼°ç®—å€¼');
          chunkSize = 1024; // ä¼°ç®—å€¼
        }
        
        // æ·»åŠ æ•°æ®å—
        receiver.chunks.push(chunk);
        receiver.receivedSize += chunkSize;
        
        // è®¡ç®—è¿›åº¦
        const progress = (receiver.receivedSize / receiver.fileSize) * 100;
        
        // æ›´æ–°UIè¿›åº¦
        updateReceiveProgressUI(transferId, progress);
        
        // æ£€æŸ¥æ˜¯å¦æ¥æ”¶å®Œæˆï¼ˆå…è®¸1KBè¯¯å·®ï¼‰
        if (Math.abs(receiver.receivedSize - receiver.fileSize) <= 1024) {
          debugLog('FILE-DATA', 'æ–‡ä»¶æ¥æ”¶å®Œæˆ', {
            fileName: receiver.fileName,
            receivedSize: receiver.receivedSize,
            fileSize: receiver.fileSize
          });
          
          // æ›´æ–°UIä¸ºå®ŒæˆçŠ¶æ€
          updateReceiveProgressUI(transferId, 100, 'completed');
          
          // ä¿å­˜æ–‡ä»¶
          saveReceivedFile(transferId);
        }
      } catch (error) {
        debugLog('FILE-DATA ERROR', 'å¤„ç†æ–‡ä»¶æ•°æ®å‡ºé”™', error);
        console.error('å¤„ç†æ–‡ä»¶æ•°æ®å‡ºé”™:', error);
        showNotification('æ–‡ä»¶æ¥æ”¶å¤±è´¥: ' + error.message);
      }
    });
    
    // ä¿å­˜æ¥æ”¶åˆ°çš„æ–‡ä»¶
    function saveReceivedFile(transferId) {
      try {
        const receiver = fileReceivers.get(transferId);
        if (!receiver || !receiver.chunks || receiver.chunks.length === 0) {
          throw new Error('æ²¡æœ‰æœ‰æ•ˆçš„æ–‡ä»¶æ•°æ®');
        }
        
        debugLog('SAVE', 'å‡†å¤‡ä¿å­˜æ–‡ä»¶', {
          fileName: receiver.fileName,
          chunksCount: receiver.chunks.length,
          totalSize: receiver.receivedSize
        });
        
        // åˆ›å»ºBlobå¯¹è±¡
        const blob = new Blob(receiver.chunks, { type: getMimeType(receiver.fileName.split('.').pop().toLowerCase()) });
        debugLog('SAVE', 'Blobåˆ›å»ºæˆåŠŸ', { size: blob.size });
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const url = URL.createObjectURL(blob);
        debugLog('SAVE', 'URLåˆ›å»ºæˆåŠŸ');
        
        // æ˜¾ç¤ºä¿å­˜å¯¹è¯æ¡†
        showSaveFileDialog(url, receiver.fileName, blob.size, transferId);
        
        // æ ‡è®°æ¥æ”¶å®Œæˆ
        receiver.active = false;
        
      } catch (error) {
        debugLog('SAVE ERROR', 'ä¿å­˜æ–‡ä»¶å¤±è´¥', error);
        console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
        showNotification('ä¿å­˜æ–‡ä»¶å¤±è´¥: ' + error.message);
      }
    }
    
    // ä¿®æ”¹ä¿å­˜æ–‡ä»¶å¯¹è¯æ¡†å‡½æ•°ï¼Œæ·»åŠ transferIdå‚æ•°
    function showSaveFileDialog(url, fileName, fileSize, transferId) {
      // æ£€æµ‹æ–‡ä»¶ç±»å‹
      const fileExt = fileName.split('.').pop().toLowerCase();
      
      // æˆªæ–­æ–‡ä»¶åä»¥é¿å…æº¢å‡º
      const truncatedFileName = truncateFileName(fileName, 25);
      
      // è·å–MIMEç±»å‹
      const mimeType = getMimeType(fileExt);
      const isPreviewable = isFilePreviewable(fileExt, mimeType);
      
      debugLog('SAVE', 'å‡†å¤‡æ˜¾ç¤ºæ–‡ä»¶ä¿å­˜å¯¹è¯æ¡†', { 
        fileName, 
        fileSize, 
        fileExt, 
        mimeType, 
        isPreviewable,
        transferId
      });
      
      let previewHtml = '';
      if (isPreviewable) {
        if (mimeType.startsWith('image/')) {
          previewHtml = `<img src="${url}" style="max-width:100%;max-height:200px;margin-bottom:1rem;border-radius:var(--radius-md);" />`;
        } else if (mimeType.startsWith('video/')) {
          previewHtml = `<video src="${url}" controls style="max-width:100%;max-height:200px;margin-bottom:1rem;border-radius:var(--radius-md);"></video>`;
        } else if (mimeType.startsWith('audio/')) {
          previewHtml = `<audio src="${url}" controls style="width:100%;margin-bottom:1rem;"></audio>`;
        }
      }
      
      showModal(
        t('fileReceived'),
        `
        <div style="text-align:center;margin-bottom:1rem;">
          ${previewHtml}
          <div style="font-size:1.2rem;font-weight:500;margin-bottom:0.5rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
            ${truncatedFileName || t('receivedFile')}
          </div>
          <div style="font-size:0.9rem;color:var(--color-text-secondary);">
            ${t('fileSize')}: ${formatFileSize(fileSize)}
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:0.75rem;">
          <a id="saveFileBtn" href="${url}" download="${fileName}" style="text-decoration:none;text-align:center;width:100%;padding:0.75rem;border-radius:var(--radius-md);background:var(--color-primary);color:white;font-weight:500;border:none;cursor:pointer;">
            ${t('saveFile')}
          </a>
          <button id="openFileBtn" data-transfer-id="${transferId}" style="width:100%;padding:0.75rem;border-radius:var(--radius-md);background:var(--color-surface);color:var(--color-text-primary);font-weight:500;border:1px solid var(--color-border);cursor:pointer;">
            ${t('openInNewWindow')}
          </button>
        </div>
        <div style="margin-top:1rem;font-size:0.8rem;color:var(--color-text-tertiary);text-align:center;">
          ${t('downloadTip')}
        </div>
        `,
        [{ text: t('close'), class: 'secondary', action: () => {
          // å»¶è¿Ÿé‡Šæ”¾URLï¼Œç¡®ä¿æœ‰è¶³å¤Ÿæ—¶é—´ä¸‹è½½
          setTimeout(() => {
            URL.revokeObjectURL(url);
            debugLog('SAVE', 'URLå·²é‡Šæ”¾');
          }, 5000);
          closeModal();
        }}]
      );
      
      // è®¾ç½®æŒ‰é’®äº‹ä»¶
      setTimeout(() => {
        document.getElementById('saveFileBtn').addEventListener('click', () => {
          debugLog('SAVE', 'ç”¨æˆ·ç‚¹å‡»ä¿å­˜æ–‡ä»¶æŒ‰é’®');
          showNotification('æ–‡ä»¶å¼€å§‹ä¸‹è½½');
        });
        
        document.getElementById('openFileBtn').addEventListener('click', (e) => {
          debugLog('SAVE', 'ç”¨æˆ·ç‚¹å‡»åœ¨æ–°çª—å£æ‰“å¼€æŒ‰é’®');
          
          // è·å–transferId
          const openTransferId = e.currentTarget.dataset.transferId || transferId;
          const receiver = fileReceivers.get(openTransferId);
          
          if (!receiver || !receiver.chunks) {
            showNotification('æ— æ³•æ‰“å¼€æ–‡ä»¶ï¼šæ•°æ®å·²ä¸¢å¤±');
            return;
          }
          
          // åˆ›å»ºä¸€ä¸ªå¸¦æœ‰æ­£ç¡®MIMEç±»å‹çš„æ–°URL
          const blob = new Blob(receiver.chunks, { type: mimeType });
          const typedUrl = URL.createObjectURL(blob);
          
          window.open(typedUrl, '_blank');
          
          // åœ¨é€‚å½“çš„æ—¶å€™é‡Šæ”¾è¿™ä¸ªURL
          setTimeout(() => URL.revokeObjectURL(typedUrl), 30000);
        });
        
        // éç§»åŠ¨è®¾å¤‡è‡ªåŠ¨è§¦å‘ä¸‹è½½
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (!isPreviewable && !isMobile) {
          debugLog('SAVE', 'éç§»åŠ¨è®¾å¤‡ï¼Œè‡ªåŠ¨è§¦å‘ä¸‹è½½');
          document.getElementById('saveFileBtn').click();
        }
      }, 100);
    }

    // è·å–æ–‡ä»¶MIMEç±»å‹
    function getMimeType(fileExt) {
      const mimeTypes = {
        // å›¾ç‰‡
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'png': 'image/png',
        'gif': 'image/gif',
        'webp': 'image/webp',
        'svg': 'image/svg+xml',
        'ico': 'image/x-icon',
        
        // æ–‡æ¡£
        'pdf': 'application/pdf',
        'doc': 'application/msword',
        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'xls': 'application/vnd.ms-excel',
        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'ppt': 'application/vnd.ms-powerpoint',
        'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'txt': 'text/plain',
        'csv': 'text/csv',
        'json': 'application/json',
        'xml': 'application/xml',
        'html': 'text/html',
        'htm': 'text/html',
        'css': 'text/css',
        'js': 'text/javascript',
        
        // éŸ³è§†é¢‘
        'mp3': 'audio/mpeg',
        'wav': 'audio/wav',
        'mp4': 'video/mp4',
        'webm': 'video/webm',
        'ogg': 'audio/ogg',
        'ogv': 'video/ogg',
        'm4a': 'audio/mp4',
        
        // å‹ç¼©æ–‡ä»¶
        'zip': 'application/zip',
        'rar': 'application/x-rar-compressed',
        '7z': 'application/x-7z-compressed',
        'gz': 'application/gzip',
        'tar': 'application/x-tar',
        
        // å…¶ä»–å¸¸è§æ ¼å¼
        'apk': 'application/vnd.android.package-archive',
        'exe': 'application/x-msdownload',
        'dmg': 'application/x-apple-diskimage'
      };
      
      return mimeTypes[fileExt] || 'application/octet-stream';
    }

    // åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å¯é¢„è§ˆ
    function isFilePreviewable(fileExt, mimeType) {
      // å¯é¢„è§ˆçš„æ–‡ä»¶æ‰©å±•ååˆ—è¡¨
      const previewableExts = [
        // å›¾ç‰‡
        'jpg', 'jpeg', 'png', 'gif', 'webp', 'svg',
        
        // éŸ³é¢‘
        'mp3', 'wav', 'ogg', 'm4a',
        
        // è§†é¢‘
        'mp4', 'webm', 'ogv'
      ];
      
      // é¦–å…ˆæ£€æŸ¥æ–‡ä»¶æ‰©å±•å
      if (previewableExts.includes(fileExt)) {
        return true;
      }
      
      // ç„¶åæ£€æŸ¥MIMEç±»å‹
      if (mimeType.startsWith('image/') || 
          mimeType.startsWith('video/') || 
          mimeType.startsWith('audio/')) {
        return true;
      }
      
      return false;
    }

    // è®¾å¤‡åˆ—è¡¨æ¸²æŸ“
    function updateDeviceList() {
      const footer = document.getElementById('deviceFooter');
      const listInner = document.getElementById('deviceListInner');
      const deviceList = Array.from(devices.values()).filter(device => device.id !== myDeviceId);
      
      if (deviceList.length === 0) {
        listInner.innerHTML = `
          <div class="empty-state">
            <i class="ri-radar-line"></i>
            <p>${t('searching')}</p>
          </div>
        `;
        return;
      }
      
      listInner.innerHTML = '';
      
      // æ·»åŠ å¤šé€‰æŒ‰é’®ï¼Œå§‹ç»ˆæ˜¾ç¤ºåœ¨åº•éƒ¨è®¾å¤‡åˆ—è¡¨ä¸­
      if (deviceList.length > 1) {
        const multiSelectBtn = document.createElement('button');
        multiSelectBtn.className = 'device-chip';
        multiSelectBtn.style.background = selectedDevices.size > 0 ? 'var(--color-primary)' : '';
        multiSelectBtn.style.color = selectedDevices.size > 0 ? 'white' : '';
        multiSelectBtn.innerHTML = `<i class="ri-checkbox-multiple-line"></i>${selectedDevices.size > 0 ? 
          `${t('selected')}${selectedDevices.size}` : t('multiSelect')}`;
        
        multiSelectBtn.onclick = () => {
          showDeviceSelector(
            Array.from(devices.keys()).filter(id => id !== myDeviceId),
            (targetIds) => {
              selectedDevices = new Set(targetIds);
              selectedDeviceId = null; // æ¸…é™¤å•é€‰
              updateDeviceList();
              
              if (targetIds.length > 0) {
                showNotification(`å·²é€‰æ‹© ${targetIds.length} ä¸ªè®¾å¤‡`);
              }
            }
          );
        };
        
        listInner.appendChild(multiSelectBtn);
      }
      
      // é™åˆ¶åªæ˜¾ç¤ºå‰1-2ä¸ªè®¾å¤‡ï¼ˆåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼‰æˆ–å‰2-3ä¸ªè®¾å¤‡ï¼ˆåœ¨æ¡Œé¢è®¾å¤‡ä¸Šï¼‰
      const isMobile = window.innerWidth <= 768;
      const maxVisibleDevices = isMobile ? (deviceList.length > 3 ? 1 : 2) : (deviceList.length > 4 ? 2 : 3);
      
      // å¦‚æœæœ‰è¶…è¿‡æ˜¾ç¤ºä¸Šé™çš„è®¾å¤‡ï¼Œæ·»åŠ "æ›´å¤š"æŒ‰é’®
      const hasMoreDevices = deviceList.length > maxVisibleDevices;
      const visibleDevices = hasMoreDevices ? deviceList.slice(0, maxVisibleDevices) : deviceList;
      
      // æ¸²æŸ“å¯è§è®¾å¤‡
      visibleDevices.forEach(device => {
        const chip = createDeviceChip(device);
        listInner.appendChild(chip);
      });
      
      // å¦‚æœæœ‰æ›´å¤šè®¾å¤‡ï¼Œæ·»åŠ "æ›´å¤š"æŒ‰é’®
      if (hasMoreDevices) {
        const moreBtn = document.createElement('button');
        moreBtn.className = 'more-devices-btn';
        moreBtn.innerHTML = `<i class="ri-more-line"></i>(${deviceList.length - maxVisibleDevices})`;
        
        moreBtn.addEventListener('click', () => {
          showDevicesModal(deviceList);
        });
        
        listInner.appendChild(moreBtn);
      }
    }
    
    // åˆ›å»ºè®¾å¤‡chipå…ƒç´ 
    function createDeviceChip(device) {
      const chip = document.createElement('div');
      
      // è®¾ç½®æ ·å¼ç±»
      let className = 'device-chip';
      if (selectedDeviceId === device.id) {
        className += ' active';
      }
      if (selectedDevices.has(device.id)) {
        className += ' selected';
      }
      
      chip.className = className;
      chip.innerHTML = `<i class="${device.icon || 'ri-device-line'}"></i>${device.name || `è®¾å¤‡ ${device.id.slice(0,6)}`}`;
      chip.title = device.type || 'ç‚¹å‡»é€‰æ‹©è®¾å¤‡';
      chip.dataset.id = device.id;
      
      chip.onclick = () => {
        // å¦‚æœå·²ç»å¤„äºå¤šé€‰æ¨¡å¼
        if (selectedDevices.size > 0) {
          if (selectedDevices.has(device.id)) {
            selectedDevices.delete(device.id);
          } else {
            selectedDevices.add(device.id);
          }
          
          updateDeviceList();
          return;
        }
        
        // å•é€‰æ¨¡å¼
        selectedDeviceId = device.id;
        selectedDevices.clear(); // æ¸…é™¤å¤šé€‰
        document.querySelectorAll('.device-chip').forEach(el => el.classList.remove('active'));
        chip.classList.add('active');
        showNotification(`å·²é€‰æ‹©è®¾å¤‡: ${device.name || `è®¾å¤‡ ${device.id.slice(0,6)}`}`);
      };
      
      return chip;
    }
    
    // æ˜¾ç¤ºå®Œæ•´è®¾å¤‡åˆ—è¡¨å¼¹çª—
    function showDevicesModal(deviceList) {
      let content = '<div class="devices-modal-grid">';
      
      // æ·»åŠ æ‰€æœ‰è®¾å¤‡
      deviceList.forEach(device => {
        let className = 'device-chip';
        if (selectedDeviceId === device.id) {
          className += ' active';
        }
        if (selectedDevices.has(device.id)) {
          className += ' selected';
        }
        
        content += `
          <div class="${className}" data-id="${device.id}">
            <i class="${device.icon || 'ri-device-line'}"></i>
            <span>${device.name || `è®¾å¤‡ ${device.id.slice(0,6)}`}</span>
          </div>
        `;
      });
      
      content += '</div>';
      
      showModal(
        'æ‰€æœ‰è®¾å¤‡',
        content,
        [{ text: 'å…³é—­', class: 'primary', action: closeModal }]
      );
      
      // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
      setTimeout(() => {
        document.querySelectorAll('.devices-modal-grid .device-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            const deviceId = chip.dataset.id;
            if (!deviceId) return;
            
            // å¦‚æœå·²ç»å¤„äºå¤šé€‰æ¨¡å¼
            if (selectedDevices.size > 0) {
              if (selectedDevices.has(deviceId)) {
                selectedDevices.delete(deviceId);
                chip.classList.remove('selected');
              } else {
                selectedDevices.add(deviceId);
                chip.classList.add('selected');
              }
              return;
            }
            
            // å•é€‰æ¨¡å¼
            selectedDeviceId = deviceId;
            selectedDevices.clear(); // æ¸…é™¤å¤šé€‰
            
            document.querySelectorAll('.device-chip').forEach(el => el.classList.remove('active'));
            chip.classList.add('active');
            
            showNotification(`å·²é€‰æ‹©è®¾å¤‡: ${devices.get(deviceId)?.name || `è®¾å¤‡ ${deviceId.slice(0,6)}`}`);
            closeModal();
            updateDeviceList();
          });
        });
      }, 100);
    }

    // Socket.io äº‹ä»¶
    socket.on('connect', () => {
      debugLog('CONNECT', 'å·²è¿æ¥åˆ°æœåŠ¡å™¨');
      // åˆå§‹åŒ–è®¾å¤‡åç§°
      const deviceName = initDeviceName();
      
      // åˆå§‹åŒ–è®¾å¤‡ä¿¡æ¯
      myDeviceInfo = {
        ...getDeviceInfo(),
        name: deviceName
      };
      
      // å‘é€è®¾å¤‡ä¿¡æ¯åˆ°æœåŠ¡å™¨
      socket.emit('device-info', myDeviceInfo);
      
      // æ›´æ–°è®¾å¤‡å›¾æ ‡
      updateDeviceTypeIcon();
    });
    
    socket.on('device-info', (data) => {
      myDeviceId = data.id;
      data.devices.forEach(device => { 
        devices.set(device.id, device); 
      });
      updateDeviceList();
    });
    
    socket.on('device-joined', (data) => {
      devices.set(data.id, { 
        id: data.id, 
        lastSeen: Date.now(), 
        type: data.type, 
        icon: data.icon, 
        name: data.name 
      });
      updateDeviceList();
      showNotification(t('deviceJoined', data.name || `${t('device')} ${data.id.slice(0, 6)}`));
    });
    
    socket.on('device-left', (data) => {
      devices.delete(data.id);
      
      // å¦‚æœè®¾å¤‡è¢«é€‰ä¸­ï¼Œç§»é™¤é€‰æ‹©
      if (selectedDeviceId === data.id) {
        selectedDeviceId = null;
      }
      
      if (selectedDevices.has(data.id)) {
        selectedDevices.delete(data.id);
      }
      
      updateDeviceList();
    });
    
    socket.on('device-info-update', (data) => {
      if (devices.has(data.id)) {
        const device = devices.get(data.id);
        device.name = data.name;
        device.type = data.type;
        device.icon = data.icon;
        devices.set(data.id, device);
        updateDeviceList();
      }
    });
    
    socket.on('message', (data) => {
      const { fromId, message } = data;
      const device = devices.get(fromId);
      const deviceName = device ? device.name || `${t('device')} ${fromId.slice(0, 6)}` : `${t('device')} ${fromId.slice(0, 6)}`;
      
      showModal(
        t('receivedMessage'),
        `<div style="margin-bottom:1rem;">
          <div style="margin-bottom:0.5rem;font-weight:500;">${t('messageFrom', deviceName)}</div>
          <div style="border-radius:var(--radius-md);background:var(--color-surface);padding:0.75rem;word-break:break-all;">
            ${message}
          </div>
        </div>`,
        [{ text: t('close'), class: 'primary', action: closeModal }]
      );
    });

    socket.on('file-transfer-request', (data) => { 
      handleFileReceive(data); 
    });

    // Modalå¼¹çª—
    function showModal(title, content, buttons=[]) {
      const modal = document.getElementById('modal');
      
      let buttonsHtml = '';
      if (buttons.length > 0) {
        buttonsHtml = `<div class="modal-buttons">`;
        buttons.forEach(btn => {
          buttonsHtml += `<button class="modal-btn ${btn.class || ''}">${btn.text}</button>`;
        });
        buttonsHtml += `</div>`;
      }
      
      modal.innerHTML = `
        <div class="modal">
          <div class="modal-content">
            <div class="modal-title">${title}</div>
            <div>${content}</div>
            ${buttonsHtml}
          </div>
        </div>
      `;
      
      modal.style.display = 'block';
      
      if (buttons.length > 0) {
        modal.querySelectorAll('.modal-btn').forEach((btn, i) => {
          if (buttons[i].action) {
            btn.onclick = buttons[i].action;
          }
        });
      }
    }

    function closeModal() { 
      document.getElementById('modal').style.display = 'none'; 
    }

    // æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024, sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // æ–‡ä»¶åæˆªæ–­å¤„ç†
    function truncateFileName(fileName, maxLength = 20) {
      if (!fileName || fileName.length <= maxLength) return fileName;
      
      const extension = fileName.lastIndexOf('.') > 0 ? 
        fileName.substring(fileName.lastIndexOf('.')) : '';
      
      // ä¸ºæ‰©å±•åä¿ç•™ç©ºé—´
      const nameLength = maxLength - extension.length - 3; // 3æ˜¯"..."çš„é•¿åº¦
      if (nameLength < 5) {
        // å¦‚æœæ‰©å±•åå¤ªé•¿ï¼Œåªæ˜¾ç¤ºæ–‡ä»¶åçš„å¼€å¤´
        return fileName.substring(0, maxLength - 3) + '...';
      }
      
      // è¿”å›æˆªæ–­åçš„æ–‡ä»¶å + ... + æ‰©å±•å
      return fileName.substring(0, nameLength) + '...' + extension;
    }

    // å¸®åŠ©æŒ‰é’®
    document.querySelector('[title="å¸®åŠ©"]').addEventListener('click', () => {
      showModal(
        t('helpTitle'),
        `<div style="text-align:left;">
          <p style="margin-bottom:0.75rem;">${t('help1')}</p>
          <p style="margin-bottom:0.75rem;">${t('help2')}</p>
          <p style="margin-bottom:0.75rem;">${t('help3')}</p>
          <p style="margin-bottom:0.75rem;">${t('help4')}</p>
          <p>${t('help5')}</p>
        </div>`,
        [{ text: t('gotIt'), class: 'primary', action: closeModal }]
      );
    });

    // è®¾ç½®æŒ‰é’®
    document.querySelector('[title="å…³äº"]').addEventListener('click', () => {
      showModal(
        t('aboutTitle'),
        `<div style="text-align:left;">
          <div style="margin-bottom:1.25rem;">
            <h3 style="margin-bottom:0.5rem;font-size:1.1rem;color:var(--color-primary);">AnyDrop - ${currentLanguage === 'zh' ? 'å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“' : 'LAN File Transfer'}</h3>
            <p style="color:var(--color-text-secondary);font-size:0.9rem;">
              ${t('appDescription')}
            </p>
          </div>
          
          <div style="margin-bottom:1.25rem;">
            <h4 style="margin-bottom:0.5rem;font-size:0.95rem;">${t('versionInfo')}</h4>
            <p style="font-size:0.85rem;margin-bottom:0.25rem;">${t('version')}</p>
            <p style="font-size:0.85rem;">${t('releaseDate')}</p>
          </div>
          
          <div style="margin-bottom:1.25rem;">
            <h4 style="margin-bottom:0.5rem;font-size:0.95rem;">${t('techStack')}</h4>
            <p style="font-size:0.85rem;color:var(--color-text-secondary);">
              ${t('techDescription')}
            </p>
          </div>
          
          <div style="margin-bottom:1.25rem;">
            <h4 style="margin-bottom:0.5rem;font-size:0.95rem;">${t('openSource')}</h4>
            <p style="font-size:0.85rem;margin-bottom:0.5rem;">
              <a href="https://github.com/chenyibai9527/anydrop" target="_blank" style="color:var(--color-primary);text-decoration:none;display:flex;align-items:center;gap:0.25rem;">
                <i class="ri-github-fill"></i> ${t('githubRepo')}
              </a>
            </p>
            <p style="font-size:0.85rem;color:var(--color-text-secondary);">
              ${t('license')}
            </p>
          </div>
          
          <div>
            <h4 style="margin-bottom:0.5rem;font-size:0.95rem;">${t('contact')}</h4>
            <p style="font-size:0.85rem;color:var(--color-text-secondary);">
              ${t('feedback')}
            </p>
          </div>
        </div>`,
        [{ text: t('close'), class: 'primary', action: closeModal }]
      );
    });

    // ç›‘å¬å–æ¶ˆä¼ è¾“
    socket.on('cancel-transfer', (data) => {
      const { fromId, transferId } = data;
      debugLog('RECEIVED_CANCEL', 'æ”¶åˆ°å–æ¶ˆä¼ è¾“è¯·æ±‚', { fromId, transferId });
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯æ¥æ”¶ä¸­çš„æ–‡ä»¶
      if (fileReceivers.has(transferId)) {
        // å–æ¶ˆæ¥æ”¶
        fileReceivers.delete(transferId);
        showNotification('å¯¹æ–¹å·²å–æ¶ˆæ–‡ä»¶ä¼ è¾“');
        
        // å…³é—­ä»»ä½•æ­£åœ¨æ˜¾ç¤ºçš„è¿›åº¦æ¡
        const progressElement = document.getElementById(`transfer-${transferId}`);
        if (progressElement) {
          progressElement.querySelector('.progress-bar').style.background = 'var(--color-text-tertiary)';
          const progressText = progressElement.querySelector('.transfer-progress-text');
          if (progressText) progressText.textContent = 'å·²å–æ¶ˆ';
          
          // ä¸€æ®µæ—¶é—´åç§»é™¤UI
          setTimeout(() => {
            progressElement.style.opacity = '0';
            progressElement.style.transition = 'opacity 0.5s ease';
            setTimeout(() => progressElement.remove(), 500);
          }, 3000);
        }
      }
      
      // æ›´æ–°ä¼ è¾“çŠ¶æ€
      if (activeTransfers.has(transferId)) {
        const transfer = activeTransfers.get(transferId);
        transfer.status = 'cancelled';
        activeTransfers.set(transferId, transfer);
        updateTransferProgress(transferId);
      }
    });

    // ä¿®æ”¹file-transfer-responseäº‹ä»¶å¤„ç†å‡½æ•°
    socket.on('file-transfer-response', (data) => {
      const { fromId, transferId, accepted } = data;
      debugLog('RESPONSE', `æ”¶åˆ°ä¼ è¾“å“åº”`, { fromId, transferId, accepted });
      
      // æŸ¥æ‰¾æ­¤ä¼ è¾“IDå¯¹åº”çš„æ´»è·ƒä¼ è¾“
      const transfer = activeTransfers.get(transferId);
      
      // æŸ¥æ‰¾æ­¤ä¼ è¾“IDå¯¹åº”çš„ç›®æ ‡è®¾å¤‡ID
      const targetId = fileTransferMappings.get(transferId);
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯åˆæ³•çš„å“åº”
      if (transfer && fromId === targetId) {
        if (accepted) {
          debugLog('SEND', `ç›®æ ‡è®¾å¤‡å·²æ¥å—æ–‡ä»¶ä¼ è¾“è¯·æ±‚ï¼Œå¼€å§‹å‘é€æ•°æ®`, { transferId, targetId });
          
          // æ›´æ–°ä¼ è¾“çŠ¶æ€
          transfer.status = 'active';
          activeTransfers.set(transferId, transfer);
          
          // æ˜¾ç¤ºä¼ è¾“è¿›åº¦
          showTransferProgress(transferId);
          
          // å¼€å§‹ä¼ è¾“æ–‡ä»¶æ•°æ®
          sendFileData(transfer.file, targetId, transferId);
        } else {
          debugLog('SEND', `ç›®æ ‡è®¾å¤‡æ‹’ç»äº†æ–‡ä»¶ä¼ è¾“è¯·æ±‚`, { transferId, targetId });
          
          // æ›´æ–°ä¼ è¾“çŠ¶æ€
          transfer.status = 'rejected';
          activeTransfers.set(transferId, transfer);
          
          // æ›´æ–°UI
          showTransferRejectedUI(transferId);
          
          showNotification(`å¯¹æ–¹æ‹’ç»æ¥æ”¶æ–‡ä»¶ ${transfer.name}`);
        }
      }
    });

    // æ·»åŠ åœ¨é¡µé¢åŠ è½½å®Œæˆå‡½æ•°ä¸­
    // è®¾å¤‡åˆ—è¡¨æŠ˜å /å±•å¼€åˆ‡æ¢
    document.getElementById('deviceListToggle').addEventListener('click', function() {
      const footer = document.getElementById('deviceFooter');
      footer.classList.toggle('collapsed');
      
      // è®°å½•ç”¨æˆ·æ‰‹åŠ¨å±•å¼€çš„çŠ¶æ€
      if (!footer.classList.contains('collapsed')) {
        footer.classList.add('user-expanded');
      } else {
        footer.classList.remove('user-expanded');
      }
      
      // ä¿å­˜æŠ˜å çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('deviceListCollapsed', footer.classList.contains('collapsed'));
    });
  </script>
</body>
</html>