<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Drop | Â±ÄÂüüÁΩëÊñá‰ª∂‰∫í‰º†</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí´</text></svg>">
  <script src="/socket.io/socket.io.js"></script>
  <!-- Ë∞ÉËØïÂ∑•ÂÖ∑ -->
  <script>
    // Ë∞ÉËØïÂ∑•ÂÖ∑
    function debugLog(tag, ...args) {
      const timestamp = new Date().toISOString().substr(11, 8);
      console.log(`[${tag}] ${timestamp}`, ...args);
    }
    
    // ÂÖ®Â±ÄÈîôËØØÊçïËé∑
    window.addEventListener('error', function(event) {
      debugLog('ERROR', 'ÂÖ®Â±ÄÈîôËØØ:', event.error);
      console.error(event.error);
    });
  </script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #3B82F6;
      --color-primary-light: #60A5FA;
      --color-primary-dark: #2563EB;
      --color-secondary: #A78BFA;
      --color-accent: #F472B6;
      --color-background: #FFFFFF;
      --color-surface: #F9FAFB;
      --color-border: #E5E7EB;
      --color-text-primary: #1F2937;
      --color-text-secondary: #4B5563;
      --color-text-tertiary: #9CA3AF;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius-sm: 0.375rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.5rem;
      --radius-full: 9999px;
      --animation-speed: 300ms;
    }

    [data-theme="dark"] {
      --color-primary: #60A5FA;
      --color-primary-light: #93C5FD;
      --color-primary-dark: #3B82F6;
      --color-secondary: #A78BFA;
      --color-accent: #F472B6;
      --color-background: #111827;
      --color-surface: #1F2937;
      --color-border: #374151;
      --color-text-primary: #F9FAFB;
      --color-text-secondary: #E5E7EB;
      --color-text-tertiary: #9CA3AF;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.25);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--color-text-primary);
      background: var(--color-background);
      overflow-x: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.5rem;
      background: var(--color-background);
      position: relative;
      z-index: 10;
      transition: background-color 0.3s ease;
    }

    .app-logo {
      display: flex;
      align-items: center;
      font-weight: 600;
      font-size: 1.25rem;
      color: var(--color-primary);
    }

    .app-logo span {
      margin-left: 0.5rem;
    }

    .topbar-actions {
      display: flex;
      gap: 1rem;
    }

    .icon-btn {
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
      color: var(--color-text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
    }

    .icon-btn:hover {
      background: var(--color-surface);
      color: var(--color-primary);
    }

    .icon-btn i {
      font-size: 1.25rem;
    }

    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 2rem 1rem;
    }

    .radar-container {
      position: relative;
      width: 100%;
      max-width: 480px;
      height: 320px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .radar-circle {
      position: absolute;
      border-radius: 50%;
      border: 1px solid rgba(59, 130, 246, 0.1);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.05);
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .radar-circle {
      border-color: rgba(96, 165, 250, 0.15);
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.08);
    }

    .circle-1 {
      width: 80px;
      height: 80px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
      animation: pulse 3s infinite;
    }

    .circle-2 {
      width: 160px;
      height: 160px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
      animation: pulse 3s infinite 0.5s;
    }

    .circle-3 {
      width: 240px;
      height: 240px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.03) 0%, transparent 70%);
      animation: pulse 3s infinite 1s;
    }

    .circle-4 {
      width: 320px;
      height: 320px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.02) 0%, transparent 70%);
      animation: pulse 3s infinite 1.5s;
    }

    [data-theme="dark"] .circle-1 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.12) 0%, transparent 70%);
    }

    [data-theme="dark"] .circle-2 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.08) 0%, transparent 70%);
    }

    [data-theme="dark"] .circle-3 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.05) 0%, transparent 70%);
    }

    [data-theme="dark"] .circle-4 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.03) 0%, transparent 70%);
    }

    @keyframes pulse {
      0% {
        opacity: 0.7;
        transform: scale(0.95);
      }
      50% {
        opacity: 0.9;
        transform: scale(1);
      }
      100% {
        opacity: 0.7;
        transform: scale(0.95);
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .device-list-inner::-webkit-scrollbar {
      display: none;
    }

    /* ËÆæÂ§áÂàóË°®Â±ïÂºÄ/ÊäòÂè†ÊéßÂà∂ */
    .device-list-toggle {
      display: none; /* ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂ±ïÂºÄ/ÊäòÂè†ÊåâÈíÆ */
    }

    /* ËÆæÂ§áÈ°πÊ†∑Âºè */
    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Êõ¥Â§öËÆæÂ§áÊåâÈíÆÊ†∑Âºè */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .more-devices-btn:active {
      transform: scale(0.95);
      background: var(--color-background);
    }

    .more-devices-btn .device-count {
      background: var(--color-primary-light);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Âà†Èô§ÊµÆÂä®ÊåâÈíÆÊ†∑Âºè */
    .devices-float-btn {
      display: none;
    }

    /* ‰øùÁïôÂºπÁ™óÁõ∏ÂÖ≥Ê†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
        font-size: 1.3rem;
      }

      .device-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.6rem;
      }

      .device-card {
        padding: 0.6rem;
      }

      .device-card i {
        font-size: 1.3rem;
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .device-list-inner::-webkit-scrollbar {
      display: none;
    }

    /* ËÆæÂ§áÂàóË°®Â±ïÂºÄ/ÊäòÂè†ÊéßÂà∂ */
    .device-list-toggle {
      display: none; /* ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂ±ïÂºÄ/ÊäòÂè†ÊåâÈíÆ */
    }

    /* ËÆæÂ§áÈ°πÊ†∑Âºè */
    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Êõ¥Â§öËÆæÂ§áÊåâÈíÆÊ†∑Âºè */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .more-devices-btn:active {
      transform: scale(0.95);
      background: var(--color-background);
    }

    .more-devices-btn .device-count {
      background: var(--color-primary-light);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Âà†Èô§ÊµÆÂä®ÊåâÈíÆÊ†∑Âºè */
    .devices-float-btn {
      display: none;
    }

    /* ‰øùÁïôÂºπÁ™óÁõ∏ÂÖ≥Ê†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
        font-size: 1.3rem;
      }

      .device-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.6rem;
      }

      .device-card {
        padding: 0.6rem;
      }

      .device-card i {
        font-size: 1.3rem;
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .device-list-inner::-webkit-scrollbar {
      display: none;
    }

    /* ËÆæÂ§áÂàóË°®Â±ïÂºÄ/ÊäòÂè†ÊéßÂà∂ */
    .device-list-toggle {
      display: none; /* ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂ±ïÂºÄ/ÊäòÂè†ÊåâÈíÆ */
    }

    /* ËÆæÂ§áÈ°πÊ†∑Âºè */
    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Êõ¥Â§öËÆæÂ§áÊåâÈíÆÊ†∑Âºè */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .more-devices-btn:active {
      transform: scale(0.95);
      background: var(--color-background);
    }

    .more-devices-btn .device-count {
      background: var(--color-primary-light);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Âà†Èô§ÊµÆÂä®ÊåâÈíÆÊ†∑Âºè */
    .devices-float-btn {
      display: none;
    }

    /* ‰øùÁïôÂºπÁ™óÁõ∏ÂÖ≥Ê†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
        font-size: 1.3rem;
      }

      .device-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.6rem;
      }

      .device-card {
        padding: 0.6rem;
      }

      .device-card i {
        font-size: 1.3rem;
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .device-list-inner::-webkit-scrollbar {
      display: none;
    }

    /* ËÆæÂ§áÂàóË°®Â±ïÂºÄ/ÊäòÂè†ÊéßÂà∂ */
    .device-list-toggle {
      display: none; /* ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂ±ïÂºÄ/ÊäòÂè†ÊåâÈíÆ */
    }

    /* ËÆæÂ§áÈ°πÊ†∑Âºè */
    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Êõ¥Â§öËÆæÂ§áÊåâÈíÆÊ†∑Âºè */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .more-devices-btn:active {
      transform: scale(0.95);
      background: var(--color-background);
    }

    .more-devices-btn .device-count {
      background: var(--color-primary-light);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Âà†Èô§ÊµÆÂä®ÊåâÈíÆÊ†∑Âºè */
    .devices-float-btn {
      display: none;
    }

    /* ‰øùÁïôÂºπÁ™óÁõ∏ÂÖ≥Ê†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
        font-size: 1.3rem;
      }

      .device-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.6rem;
      }

      .device-card {
        padding: 0.6rem;
      }

      .device-card i {
        font-size: 1.3rem;
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .device-list-inner::-webkit-scrollbar {
      display: none;
    }

    /* ËÆæÂ§áÂàóË°®Â±ïÂºÄ/ÊäòÂè†ÊéßÂà∂ */
    .device-list-toggle {
      display: none; /* ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂ±ïÂºÄ/ÊäòÂè†ÊåâÈíÆ */
    }

    /* ËÆæÂ§áÈ°πÊ†∑Âºè */
    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Êõ¥Â§öËÆæÂ§áÊåâÈíÆÊ†∑Âºè */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .more-devices-btn:active {
      transform: scale(0.95);
      background: var(--color-background);
    }

    .more-devices-btn .device-count {
      background: var(--color-primary-light);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Âà†Èô§ÊµÆÂä®ÊåâÈíÆÊ†∑Âºè */
    .devices-float-btn {
      display: none;
    }

    /* ‰øùÁïôÂºπÁ™óÁõ∏ÂÖ≥Ê†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
        font-size: 1.3rem;
      }

      .device-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.6rem;
      }

      .device-card {
        padding: 0.6rem;
      }

      .device-card i {
        font-size: 1.3rem;
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .device-list-inner::-webkit-scrollbar {
      display: none;
    }

    /* ËÆæÂ§áÂàóË°®Â±ïÂºÄ/ÊäòÂè†ÊéßÂà∂ */
    .device-list-toggle {
      display: none; /* ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂ±ïÂºÄ/ÊäòÂè†ÊåâÈíÆ */
    }

    /* ËÆæÂ§áÈ°πÊ†∑Âºè */
    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Êõ¥Â§öËÆæÂ§áÊåâÈíÆÊ†∑Âºè */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .more-devices-btn:active {
      transform: scale(0.95);
      background: var(--color-background);
    }

    .more-devices-btn .device-count {
      background: var(--color-primary-light);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Âà†Èô§ÊµÆÂä®ÊåâÈíÆÊ†∑Âºè */
    .devices-float-btn {
      display: none;
    }

    /* ‰øùÁïôÂºπÁ™óÁõ∏ÂÖ≥Ê†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
        font-size: 1.3rem;
      }

      .device-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.6rem;
      }

      .device-card {
        padding: 0.6rem;
      }

      .device-card i {
        font-size: 1.3rem;
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .device-list-inner::-webkit-scrollbar {
      display: none;
    }

    /* ËÆæÂ§áÂàóË°®Â±ïÂºÄ/ÊäòÂè†ÊéßÂà∂ */
    .device-list-toggle {
      display: none; /* ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂ±ïÂºÄ/ÊäòÂè†ÊåâÈíÆ */
    }

    /* ËÆæÂ§áÈ°πÊ†∑Âºè */
    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Êõ¥Â§öËÆæÂ§áÊåâÈíÆÊ†∑Âºè */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .more-devices-btn:active {
      transform: scale(0.95);
      background: var(--color-background);
    }

    .more-devices-btn .device-count {
      background: var(--color-primary-light);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Âà†Èô§ÊµÆÂä®ÊåâÈíÆÊ†∑Âºè */
    .devices-float-btn {
      display: none;
    }

    /* ‰øùÁïôÂºπÁ™óÁõ∏ÂÖ≥Ê†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
        font-size: 1.3rem;
      }

      .device-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.6rem;
      }

      .device-card {
        padding: 0.6rem;
      }

      .device-card i {
        font-size: 1.3rem;
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .device-list-inner::-webkit-scrollbar {
      display: none;
    }

    /* ËÆæÂ§áÂàóË°®Â±ïÂºÄ/ÊäòÂè†ÊéßÂà∂ */
    .device-list-toggle {
      display: none; /* ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂ±ïÂºÄ/ÊäòÂè†ÊåâÈíÆ */
    }

    /* ËÆæÂ§áÈ°πÊ†∑Âºè */
    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Êõ¥Â§öËÆæÂ§áÊåâÈíÆÊ†∑Âºè */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .more-devices-btn:active {
      transform: scale(0.95);
      background: var(--color-background);
    }

    .more-devices-btn .device-count {
      background: var(--color-primary-light);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Âà†Èô§ÊµÆÂä®ÊåâÈíÆÊ†∑Âºè */
    .devices-float-btn {
      display: none;
    }

    /* ‰øùÁïôÂºπÁ™óÁõ∏ÂÖ≥Ê†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
        font-size: 1.3rem;
      }

      .device-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.6rem;
      }

      .device-card {
        padding: 0.6rem;
      }

      .device-card i {
        font-size: 1.3rem;
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .device-list-inner::-webkit-scrollbar {
      display: none;
    }

    /* ËÆæÂ§áÂàóË°®Â±ïÂºÄ/ÊäòÂè†ÊéßÂà∂ */
    .device-list-toggle {
      display: none; /* ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂ±ïÂºÄ/ÊäòÂè†ÊåâÈíÆ */
    }

    /* ËÆæÂ§áÈ°πÊ†∑Âºè */
    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Êõ¥Â§öËÆæÂ§áÊåâÈíÆÊ†∑Âºè */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .more-devices-btn:active {
      transform: scale(0.95);
      background: var(--color-background);
    }

    .more-devices-btn .device-count {
      background: var(--color-primary-light);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Âà†Èô§ÊµÆÂä®ÊåâÈíÆÊ†∑Âºè */
    .devices-float-btn {
      display: none;
    }

    /* ‰øùÁïôÂºπÁ™óÁõ∏ÂÖ≥Ê†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
        font-size: 1.3rem;
      }

      .device-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.6rem;
      }

      .device-card {
        padding: 0.6rem;
      }

      .device-card i {
        font-size: 1.3rem;
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .device-list-inner::-webkit-scrollbar {
      display: none;
    }

    /* ËÆæÂ§áÂàóË°®Â±ïÂºÄ/ÊäòÂè†ÊéßÂà∂ */
    .device-list-toggle {
      display: none; /* ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂ±ïÂºÄ/ÊäòÂè†ÊåâÈíÆ */
    }

    /* ËÆæÂ§áÈ°πÊ†∑Âºè */
    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Êõ¥Â§öËÆæÂ§áÊåâÈíÆÊ†∑Âºè */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .more-devices-btn:active {
      transform: scale(0.95);
      background: var(--color-background);
    }

    .more-devices-btn .device-count {
      background: var(--color-primary-light);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Âà†Èô§ÊµÆÂä®ÊåâÈíÆÊ†∑Âºè */
    .devices-float-btn {
      display: none;
    }

    /* ‰øùÁïôÂºπÁ™óÁõ∏ÂÖ≥Ê†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
        font-size: 1.3rem;
      }

      .device-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.6rem;
      }

      .device-card {
        padding: 0.6rem;
      }

      .device-card i {
        font-size: 1.3rem;
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .device-list-inner::-webkit-scrollbar {
      display: none;
    }

    /* ËÆæÂ§áÂàóË°®Â±ïÂºÄ/ÊäòÂè†ÊéßÂà∂ */
    .device-list-toggle {
      display: none; /* ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂ±ïÂºÄ/ÊäòÂè†ÊåâÈíÆ */
    }

    /* ËÆæÂ§áÈ°πÊ†∑Âºè */
    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Êõ¥Â§öËÆæÂ§áÊåâÈíÆÊ†∑Âºè */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .more-devices-btn:active {
      transform: scale(0.95);
      background: var(--color-background);
    }

    .more-devices-btn .device-count {
      background: var(--color-primary-light);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Âà†Èô§ÊµÆÂä®ÊåâÈíÆÊ†∑Âºè */
    .devices-float-btn {
      display: none;
    }

    /* ‰øùÁïôÂºπÁ™óÁõ∏ÂÖ≥Ê†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
        font-size: 1.3rem;
      }

      .device-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.6rem;
      }

      .device-card {
        padding: 0.6rem;
      }

      .device-card i {
        font-size: 1.3rem;
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
    }

    .device-list-inner {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .device-list-inner::-webkit-scrollbar {
      display: none;
    }

    /* ËÆæÂ§áÂàóË°®Â±ïÂºÄ/ÊäòÂè†ÊéßÂà∂ */
    .device-list-toggle {
      display: none; /* ÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂ±ïÂºÄ/ÊäòÂè†ÊåâÈíÆ */
    }

    /* ËÆæÂ§áÈ°πÊ†∑Âºè */
    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Êõ¥Â§öËÆæÂ§áÊåâÈíÆÊ†∑Âºè */
    .more-devices-btn {
      background: var(--color-surface);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .more-devices-btn:active {
      transform: scale(0.95);
      background: var(--color-background);
    }

    .more-devices-btn .device-count {
      background: var(--color-primary-light);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Âà†Èô§ÊµÆÂä®ÊåâÈíÆÊ†∑Âºè */
    .devices-float-btn {
      display: none;
    }

    /* ‰øùÁïôÂºπÁ™óÁõ∏ÂÖ≥Ê†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Drop | Â±ÄÂüüÁΩëÊñá‰ª∂‰∫í‰º†</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí´</text></svg>">
  <script src="/socket.io/socket.io.js"></script>
  <!-- Ë∞ÉËØïÂ∑•ÂÖ∑ -->
  <script>
    // Ë∞ÉËØïÂ∑•ÂÖ∑
    function debugLog(tag, ...args) {
      const timestamp = new Date().toISOString().substr(11, 8);
      console.log(`[${tag}] ${timestamp}`, ...args);
    }
    
    // ÂÖ®Â±ÄÈîôËØØÊçïËé∑
    window.addEventListener('error', function(event) {
      debugLog('ERROR', 'ÂÖ®Â±ÄÈîôËØØ:', event.error);
      console.error(event.error);
    });
  </script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #3B82F6;
      --color-primary-light: #60A5FA;
      --color-primary-dark: #2563EB;
      --color-secondary: #A78BFA;
      --color-accent: #F472B6;
      --color-background: #FFFFFF;
      --color-surface: #F9FAFB;
      --color-border: #E5E7EB;
      --color-text-primary: #1F2937;
      --color-text-secondary: #4B5563;
      --color-text-tertiary: #9CA3AF;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius-sm: 0.375rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.5rem;
      --radius-full: 9999px;
      --animation-speed: 300ms;
    }

    [data-theme="dark"] {
      --color-primary: #60A5FA;
      --color-primary-light: #93C5FD;
      --color-primary-dark: #3B82F6;
      --color-secondary: #A78BFA;
      --color-accent: #F472B6;
      --color-background: #111827;
      --color-surface: #1F2937;
      --color-border: #374151;
      --color-text-primary: #F9FAFB;
      --color-text-secondary: #E5E7EB;
      --color-text-tertiary: #9CA3AF;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.25);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--color-text-primary);
      background: var(--color-background);
      overflow-x: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.5rem;
      background: var(--color-background);
      position: relative;
      z-index: 10;
      transition: background-color 0.3s ease;
    }

    .app-logo {
      display: flex;
      align-items: center;
      font-weight: 600;
      font-size: 1.25rem;
      color: var(--color-primary);
    }

    .app-logo span {
      margin-left: 0.5rem;
    }

    .topbar-actions {
      display: flex;
      gap: 1rem;
    }

    .icon-btn {
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-full);
      color: var(--color-text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
    }

    .icon-btn:hover {
      background: var(--color-surface);
      color: var(--color-primary);
    }

    .icon-btn i {
      font-size: 1.25rem;
    }

    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 2rem 1rem;
    }

    .radar-container {
      position: relative;
      width: 100%;
      max-width: 480px;
      height: 320px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .radar-circle {
      position: absolute;
      border-radius: 50%;
      border: 1px solid rgba(59, 130, 246, 0.1);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.05);
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .radar-circle {
      border-color: rgba(96, 165, 250, 0.15);
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.08);
    }

    .circle-1 {
      width: 80px;
      height: 80px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
      animation: pulse 3s infinite;
    }

    .circle-2 {
      width: 160px;
      height: 160px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
      animation: pulse 3s infinite 0.5s;
    }

    .circle-3 {
      width: 240px;
      height: 240px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.03) 0%, transparent 70%);
      animation: pulse 3s infinite 1s;
    }

    .circle-4 {
      width: 320px;
      height: 320px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.02) 0%, transparent 70%);
      animation: pulse 3s infinite 1.5s;
    }

    [data-theme="dark"] .circle-1 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.12) 0%, transparent 70%);
    }

    [data-theme="dark"] .circle-2 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.08) 0%, transparent 70%);
    }

    [data-theme="dark"] .circle-3 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.05) 0%, transparent 70%);
    }

    [data-theme="dark"] .circle-4 {
      background: radial-gradient(circle, rgba(96, 165, 250, 0.03) 0%, transparent 70%);
    }

    @keyframes pulse {
      0% {
        opacity: 0.7;
        transform: scale(0.95);
      }
      50% {
        opacity: 0.9;
        transform: scale(1);
      }
      100% {
        opacity: 0.7;
        transform: scale(0.95);
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      display: none; /* ÈöêËóèÂéüÊúâÂ∫ïÈÉ®ËÆæÂ§áÂàóË°® */
    }

    /* Ê∑ªÂä†ÊµÆÂä®ËÆæÂ§áÊåâÈíÆ */
    .devices-float-btn {
      position: fixed;
      right: 1rem;
      bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-lg);
      z-index: 90;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: none;
    }

    .devices-float-btn:active {
      transform: scale(0.92);
    }

    .devices-float-btn i {
      font-size: 1.4rem;
    }

    .devices-float-btn .device-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--color-accent);
      color: white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      border: 2px solid var(--color-background);
    }

    /* ËÆæÂ§áÂàóË°®ÂºπÁ™óÊ†∑Âºè */
    .devices-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 1rem;
      padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
      animation: modal-fade-in 0.3s ease;
    }

    .devices-modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg) var(--radius-lg) var(--radius-lg) var(--radius-lg);
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
      animation: slide-up 0.3s ease;
      overflow: hidden;
    }

    .devices-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--color-border);
    }

    .devices-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .devices-modal-close {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      font-size: 1.2rem;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .devices-modal-close:active {
      background: var(--color-surface);
    }

    .devices-modal-body {
      padding: 1rem;
      overflow-y: auto;
      max-height: calc(70vh - 60px);
      scrollbar-width: thin;
    }

    .devices-modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .devices-modal-body::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .device-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      width: 100%;
    }

    .device-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
      position: relative;
      text-align: center;
    }

    .device-card:active {
      transform: scale(0.96);
    }

    .device-card.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-card.selected {
      border-color: var(--color-primary);
    }

    .device-card.selected:after {
      content: "";
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-card i {
      font-size: 1.5rem;
      color: inherit;
    }

    .device-card-name {
      font-size: 0.875rem;
      font-weight: 500;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-card.active .device-card-name {
      color: white;
    }

    .device-select-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      font-weight: 500;
      margin-top: 1rem;
      width: 100%;
      cursor: pointer;
    }

    .device-select-btn:active {
      transform: scale(0.98);
    }

    .multi-select-notice {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border-radius: var(--radius-md);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    @keyframes slide-up {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @media (max-width: 480px) {
      .devices-float-btn {
        width: 50px;
        height: 50px;
      }

      .devices-float-btn i {
        font-size: 1.3rem;
      }

      .device-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.6rem;
      }

      .device-card {
        padding: 0.6rem;
      }

      .device-card i {
        font-size: 1.3rem;
      }
    }

    .upload-button {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(59, 130, 246, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    [data-theme="dark"] .upload-button {
      box-shadow: var(--shadow-md), 0 0 0 6px rgba(96, 165, 250, 0.15);
    }

    .upload-button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15);
    }

    [data-theme="dark"] .upload-button:hover {
      box-shadow: var(--shadow-lg), 0 0 0 10px rgba(96, 165, 250, 0.2);
    }

    .upload-button:active {
      transform: scale(0.95);
    }

    .upload-button:focus {
      outline: none;
    }

    .upload-button input[type="file"] {
      display: none;
    }

    .device-info {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 400px;
      width: 100%;
    }

    .device-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-tertiary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .device-label i {
      font-size: 1rem;
    }

    .device-name-field {
      display: flex;
      align-items: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .device-name-field input {
      border: none;
      border-bottom: 2px solid var(--color-border);
      background: transparent;
      font-size: 1.25rem;
      font-weight: 500;
      color: var(--color-text-primary);
      text-align: center;
      padding: 0.5rem;
      width: auto;
      min-width: 120px;
      max-width: 220px;
      outline: none;
      transition: all var(--animation-speed) ease;
    }

    .device-name-field input:focus {
      border-color: var(--color-primary);
    }

    .device-name-field .edit-btn {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      margin-left: 0.5rem;
      cursor: pointer;
      transition: color var(--animation-speed) ease;
    }

    .device-name-field .edit-btn:hover {
      color: var(--color-primary);
    }

    .instructions {
      color: var(--color-text-secondary);
      text-align: center;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-direction: row;
      justify-content: center;
      width: 100%;
      max-width: 360px;
    }

    .action-btn {
      flex: 1;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      border-radius: var(--radius-lg);
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-width: 140px;
      box-shadow: var(--shadow-sm);
    }

    .action-btn:hover {
      background: var(--color-primary-light);
      color: white;
      border-color: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-btn i {
      font-size: 1.2rem;
    }

    .device-list {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      transition: all var(--animation-speed) ease;
      z-index: 5;
      max-height: calc(40vh + env(safe-area-inset-bottom, 0px));
      overflow-y: auto;
      scrollbar-width: thin;
      -webkit-overflow-scrolling: touch;
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }

    .device-list-inner {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      width: 100%;
      justify-content: center;
      padding: 0.25rem 0 0.5rem;
    }

    /* ËÆæÂ§áÂàóË°®ÊªöÂä®Êù°Ê†∑Âºè */
    .device-list::-webkit-scrollbar {
      height: 4px;
      width: 4px;
    }

    .device-list::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    /* ËÆæÂ§áÂàóË°®ÊäòÂè†/Â±ïÂºÄÊéßÂà∂ */
    .device-list-toggle {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: -24px;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-bottom: none;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      width: 48px;
      height: 24px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      color: var(--color-text-tertiary);
      z-index: 1;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
    }

    .device-list-toggle:hover {
      color: var(--color-primary);
    }

    .device-list.collapsed {
      max-height: 64px;
      overflow-y: hidden;
    }

    .device-list.collapsed .device-list-toggle i {
      transform: rotate(180deg);
    }

    .device-list.collapsed .device-list-inner {
      overflow-x: auto;
      flex-wrap: nowrap;
      justify-content: flex-start;
      padding-bottom: 4px;
    }

    .device-chip {
      background: var(--color-background);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--animation-speed) ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .device-chip:hover {
      border-color: var(--color-primary-light);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .device-chip.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .device-chip.selected {
      position: relative;
    }

    .device-chip.selected:after {
      content: "";
      position: absolute;
      top: -4px;
      right: -4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--color-accent);
      border: 2px solid var(--color-background);
    }

    .device-chip i {
      font-size: 1rem;
      color: inherit;
    }

    .notification {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--color-background);
      border-radius: var(--radius-lg);
      padding: 1rem 1.5rem;
      font-weight: 500;
      color: var(--color-text-primary);
      box-shadow: var(--shadow-lg);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      z-index: 100;
      border: 1px solid var(--color-border);
    }

    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    [data-theme="dark"] .modal {
      background: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background: var(--color-background);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      max-width: 400px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      animation: modal-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid var(--color-border);
    }

    @keyframes modal-in {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 1rem;
    }

    .modal-buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
      border: none;
    }

    .modal-btn.primary {
      background: var(--color-primary);
      color: white;
    }

    .modal-btn.primary:hover {
      background: var(--color-primary-dark);
    }

    .modal-btn.secondary {
      background: var(--color-surface);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
    }

    .modal-btn.secondary:hover {
      background: var(--color-border);
    }

    .transfer-progress {
      margin-top: 1rem;
      width: 100%;
      background: var(--color-surface);
      border-radius: var(--radius-full);
      height: 6px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
      border-radius: var(--radius-full);
      transition: width 0.3s ease;
    }

    .load-animation {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-background);
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    .load-animation.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .load-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-surface);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 2rem 0;
      color: var(--color-text-tertiary);
    }

    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }

    .device-select-container {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-bottom: 1rem;
      max-height: 150px;
      overflow-y: auto;
    }

    .device-select-container .device-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .device-select-container .device-option:hover {
      background: var(--color-background);
    }

    .device-select-container .checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--color-border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
    }

    .device-select-container .checkbox.checked {
      background: var(--color-primary);
      border-color: var(--color-primary);
    }

    .device-select-all {
      font-size: 0.875rem;
      color: var(--color-primary);
      cursor: pointer;
      margin-top: 0.5rem;
      display: inline-block;
    }

    .transfer-progress-container {
      transition: all 0.3s ease !important;
      border: 1px solid var(--color-border);
    }

    @media (max-width: 768px) {
      .radar-container {
        height: 280px;
      }
      
      .circle-4 {
        width: 280px;
        height: 280px;
      }
      
      .circle-3 {
        width: 210px;
        height: 210px;
      }
      
      .circle-2 {
        width: 140px;
        height: 140px;
      }
      
      .upload-button {
        width: 70px;
        height: 70px;
        font-size: 1.25rem;
      }
      
      .topbar {
        padding: 1rem;
      }
      
      .device-list {
        padding: 0.75rem 0.75rem calc(0.75rem + env(safe-area-inset-bottom, 0.75rem));
        max-height: calc(35vh + env(safe-area-inset-bottom, 0px));
      }
      
      .device-list.collapsed {
        max-height: 60px;
      }
      
      .device-list-inner {
        padding: 0.25rem 0.5rem 0.25rem;
      }
      
      .device-chip {
        padding: 0.4rem 0.9rem;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .radar-container {
        height: 220px;
        margin-bottom: 0;
      }
      
      .circle-4 {
        width: 220px;
        height: 220px;
      }
      
      .circle-3 {
        width: 165px;
        height: 165px;
      }
      
      .circle-2 {
        width: 110px;
        height: 110px;
      }
      
      .circle-1 {
        width: 55px;
        height: 55px;
      }
      
      .upload-button {
        width: 55px;
        height: 55px;
        font-size: 1rem;
      }
      
      .action-buttons {
        flex-direction: column;
        gap: 0.6rem;
        width: 100%;
        max-width: 260px;
        margin-bottom: 1.2rem;
      }
      
      .action-btn {
        width: 100%;
        min-width: unset;
        padding: 0.7rem 1rem;
        justify-content: flex-start;
      }
      
      .action-btn i {
        width: 28px;
        text-align: center;
      }
      
      .device-name-field input {
        font-size: 1.1rem;
      }
      
      .instructions {
        font-size: 0.85rem;
      }
    }

    /* ÁßªÈô§ÊâÄÊúâÊåâÈíÆÂíåÂèØ‰∫§‰∫íÂÖÉÁ¥†ÁöÑËß¶Êë∏È´ò‰∫Æ */
    button, a, .device-chip, .icon-btn, .action-btn, .modal-btn {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      outline: none;
      user-select: none;
    }

    /* Á°Æ‰øùÊåâÈíÆÁÇπÂáªÊïàÊûú */
    .action-btn:active, .device-chip:active, .icon-btn:active {
      transform: scale(0.95);
    }

    /* ‰øÆÂ§çÊåâÈíÆÁÑ¶ÁÇπÊ†∑Âºè */
    .action-btn:focus, .device-chip:focus, .icon-btn:focus, .modal-btn:focus {
      outline: none;
    }

    /* Ê∑ªÂä†ËøõÂ∫¶Êù°Ê†∑ÂºèÂà∞Â§¥ÈÉ®Ê†∑ÂºèÂå∫Âüü */
    .transfer-progress .progress-container {
      height: 6px;
      background: var(--color-background);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin: 0.5rem 0 0.25rem 0;
    }

    .transfer-progress .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-secondary) 100%);
      border-radius: var(--radius-full);
      transition: width 0.2s ease-out;
    }

    .transfer-progress .transfer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
    }

    .transfer-progress .transfer-filename {
      font-weight: 500;
      font-size: 0.875rem;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .transfer-progress .cancel-transfer {
      background: none;
      border: none;
      color: var(--color-text-tertiary);
      cursor: pointer;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      padding: 0;
      transition: all 0.2s ease;
    }

    .transfer-progress .cancel-transfer:hover {
      background: var(--color-background);
      color: var(--color-text-secondary);
    }

    #transfersContainer {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom, 0px) + 80px);
      right: 1rem;
      z-index: 6;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 50vh;
      overflow-y: auto;
      padding-right: 0.5rem;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }

    #transfersContainer::-webkit-scrollbar {
      width: 4px;
    }

    #transfersContainer::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    /* ÁßªÂä®Á´ØÈÄÇÈÖç */
    @media (max-width: 768px) {
      #transfersContainer {
        right: 0.5rem;
        max-width: calc(100vw - 2rem);
      }
      
      .transfer-progress {
        max-width: calc(100vw - 2rem);
      }
    }
  </style>
</head>
<body ontouchstart="">
  <div class="load-animation">
    <div class="load-spinner"></div>
  </div>

  <div class="app-container">
    <!-- È°∂ÈÉ®ÂØºËà™ -->
    <header class="topbar">
      <div class="app-logo">
        <i class="ri-share-forward-fill"></i>
        <span>Drop</span>
      </div>
      <div class="topbar-actions">
        <button class="icon-btn" id="themeToggle" title="ÂàáÊç¢‰∏ªÈ¢ò">
          <i class="ri-sun-line"></i>
        </button>
        <button class="icon-btn" title="ËÆæÁΩÆ">
          <i class="ri-settings-3-line"></i>
        </button>
        <button class="icon-btn" title="Â∏ÆÂä©">
          <i class="ri-question-line"></i>
        </button>
      </div>
    </header>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫ -->
    <main class="main-area">
      <div class="radar-container">
        <!-- Èõ∑ËææÂúÜÂúà -->
        <div class="radar-circle circle-1"></div>
        <div class="radar-circle circle-2"></div>
        <div class="radar-circle circle-3"></div>
        <div class="radar-circle circle-4"></div>

        <!-- ‰∏ä‰º†ÊåâÈíÆ -->
        <button class="upload-button" id="mainUploadBtn" title="ÁÇπÂáª‰∏ä‰º†Êñá‰ª∂">
          <i class="ri-upload-cloud-line"></i>
          <input type="file" id="fileInput" multiple>
        </button>
      </div>

      <!-- ËÆæÂ§á‰ø°ÊÅØ -->
      <div class="device-info">
        <div class="action-buttons">
          <button class="action-btn" id="uploadFolderBtn">
            <i class="ri-folder-upload-line"></i>
            ‰∏ä‰º†Êñá‰ª∂Â§π
          </button>
          <button class="action-btn" id="sendTextBtn">
            <i class="ri-message-2-line"></i>
            ÂèëÈÄÅÊñáÊú¨
          </button>
        </div>
        
        <div class="device-label">
          <i class="ri-device-line" id="deviceTypeIcon"></i>
          <span>ÊàëÁöÑËÆæÂ§á</span>
        </div>
        <div class="device-name-field">
          <input id="deviceName" value="ÊàëÁöÑËÆæÂ§á" maxlength="20" />
          <button class="edit-btn" title="ÁºñËæëÂêçÁß∞">
            <i class="ri-edit-line"></i>
          </button>
        </div>
        <p class="instructions">Âú®Âêå‰∏ÄÁΩëÁªú‰∏ãÁöÑËÆæÂ§á‰ºöËá™Âä®ÊòæÁ§∫</p>
        <p class="instructions">ÁÇπÂáª‰∏≠ÂøÉÊåâÈíÆÂç≥ÂèØÈÄâÊã©Ë¶ÅÂèëÈÄÅÁöÑÊñá‰ª∂</p>
      </div>
    </main>

    <!-- ËÆæÂ§áÂàóË°® -->
    <div class="device-list" id="deviceFooter">
      <div class="device-list-toggle" id="deviceListToggle">
        <i class="ri-arrow-up-s-line"></i>
      </div>
      <div class="device-list-inner" id="deviceListInner"></div>
    </div>

    <!-- Ê∑ªÂä†ÊµÆÂä®ËÆæÂ§áÊåâÈíÆ -->
    <button class="devices-float-btn" id="deviceFloatBtn">
      <i class="ri-device-line"></i>
      <span class="device-count" id="deviceCount">0</span>
    </button>
  </div>

  <!-- Êñá‰ª∂Â§π‰∏ä‰º†ÈöêËóèinput -->
  <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none">
  
  <!-- ÈÄöÁü• -->
  <div id="notification" class="notification"></div>
  
  <!-- ÂºπÁ™óÂå∫ -->
  <div id="modal" style="display:none"></div>

  <!-- ËÑöÊú¨ÈÉ®ÂàÜ -->
  <script>
    // ÈÖçÁΩÆSocket.IOÊ≠£Á°ÆÂ§ÑÁêÜ‰∫åËøõÂà∂Êï∞ÊçÆ
    const socket = io({
      binaryType: 'arraybuffer'
    });
    
    debugLog('INIT', 'Socket.IOÂ∑≤ÂàùÂßãÂåñÔºåÈÖçÁΩÆ‰∏∫Â§ÑÁêÜ‰∫åËøõÂà∂Êï∞ÊçÆ');
    
    let myDeviceId = null;
    let devices = new Map();
    let myDeviceInfo = {};
    let transferStartTime = null;
    let activeTransfers = new Map();
    let selectedDeviceId = null;
    let selectedDevices = new Set(); // Â≠òÂÇ®Â∑≤ÈÄâÊã©ÁöÑÂ§ö‰∏™ËÆæÂ§áID
    let isDarkMode = false;
    let fileTransferMappings = new Map(); // Â≠òÂÇ®transferIdÂà∞targetIdÁöÑÊò†Â∞ÑÔºåÁî®‰∫éÂ§öËÆæÂ§á‰º†Ëæì

    // Êñá‰ª∂Êé•Êî∂ÁÆ°ÁêÜ - ‰ΩøÁî®MapÊõø‰ª£ÂÖ®Â±ÄwindowÂèòÈáè
    const fileReceivers = new Map();

    // Ê£ÄÊü•ÂíåÂ∫îÁî®‰∏ªÈ¢òËÆæÁΩÆ
    function applyTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeToggle').innerHTML = '<i class="ri-moon-line"></i>';
        isDarkMode = true;
      } else {
        document.documentElement.removeAttribute('data-theme');
        document.getElementById('themeToggle').innerHTML = '<i class="ri-sun-line"></i>';
        isDarkMode = false;
      }
    }

    // ÂàáÊç¢‰∏ªÈ¢ò
    function toggleTheme() {
      if (isDarkMode) {
        localStorage.setItem('theme', 'light');
      } else {
        localStorage.setItem('theme', 'dark');
      }
      applyTheme();
    }

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêé
    window.addEventListener('load', () => {
      // Â∫îÁî®‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
      applyTheme();
      
      // Â∫îÁî®ËÆæÂ§áÂàóË°®ÊäòÂè†Áä∂ÊÄÅ
      const deviceListCollapsed = localStorage.getItem('deviceListCollapsed');
      if (deviceListCollapsed === 'true') {
        document.getElementById('deviceFooter').classList.add('collapsed');
      } else if (deviceListCollapsed === 'false') {
        document.getElementById('deviceFooter').classList.remove('collapsed');
      }
      
      // ÈöêËóèÂä†ËΩΩÂä®Áîª
      setTimeout(() => {
        document.querySelector('.load-animation').classList.add('hidden');
      }, 800);
    });

    // ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ
    document.getElementById('themeToggle').addEventListener('click', () => {
      toggleTheme();
      showNotification(isDarkMode ? 'Â∑≤ÂàáÊç¢Âà∞ÊöóËâ≤Ê®°Âºè' : 'Â∑≤ÂàáÊç¢Âà∞‰∫ÆËâ≤Ê®°Âºè');
    });

    // ÂèëÈÄÅÂøÉË∑≥ÂåÖ
    setInterval(() => { socket.emit('heartbeat'); }, 5000);

    // Ëé∑ÂèñËÆæÂ§áÁ±ªÂûãÂíåÂõæÊ†á
    function getDeviceInfo() {
      const ua = navigator.userAgent.toLowerCase();
      let type = 'Êú™Áü•ËÆæÂ§á';
      let icon = 'ri-device-line';
      
      if (ua.includes('iphone') || ua.includes('android') && !ua.includes('tablet')) { 
        type = 'ÊâãÊú∫'; 
        icon = 'ri-smartphone-line'; 
      }
      else if (ua.includes('ipad') || ua.includes('tablet')) { 
        type = 'Âπ≥Êùø'; 
        icon = 'ri-tablet-line'; 
      }
      else if (ua.includes('windows') || ua.includes('macintosh') || ua.includes('linux')) { 
        type = 'ÁîµËÑë'; 
        icon = 'ri-computer-line'; 
      }
      
      return { type, icon };
    }

    // Êõ¥Êñ∞ËÆæÂ§áÂõæÊ†á
    function updateDeviceTypeIcon() {
      const deviceIcon = document.getElementById('deviceTypeIcon');
      if (deviceIcon && myDeviceInfo.icon) {
        deviceIcon.className = myDeviceInfo.icon;
      }
    }

    // ÈÄöÁü•
    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => { notification.classList.remove('show'); }, 3000);
    }

    // ÁîüÊàêÈªòËÆ§ËÆæÂ§áÂêçÁß∞
    function generateDeviceName() {
      const deviceType = getDeviceInfo().type;
      const randomId = Math.random().toString(36).substring(2, 7);
      return `${deviceType} ${randomId}`;
    }

    // ËÆæÂ§áÂêçÁß∞ËÆæÁΩÆ
    const deviceNameInput = document.getElementById('deviceName');
    
    // ÂàùÂßãÂåñËÆæÂ§áÂêçÁß∞
    function initDeviceName() {
      let name = localStorage.getItem('deviceName');
      if (!name) {
        name = generateDeviceName();
        localStorage.setItem('deviceName', name);
      }
      deviceNameInput.value = name;
      return name;
    }
    
    deviceNameInput.addEventListener('change', function() {
      const name = this.value.trim();
      if (name) {
        myDeviceInfo.name = name;
        localStorage.setItem('deviceName', name);
        // ÂèëÈÄÅËÆæÂ§á‰ø°ÊÅØÊõ¥Êñ∞Âà∞ÊúçÂä°Âô®Ôºå‰ΩøÂÖ∂‰ªñËÆæÂ§áÁ´ãÂç≥ÁúãÂà∞Êõ¥Êîπ
        socket.emit('device-info', { ...getDeviceInfo(), name });
        showNotification('ËÆæÂ§áÂêçÁß∞Â∑≤Êõ¥Êñ∞');
      } else {
        // Â¶ÇÊûúÂêçÁß∞‰∏∫Á©∫ÔºåÊÅ¢Â§ç‰πãÂâçÁöÑÂêçÁß∞
        this.value = myDeviceInfo.name || initDeviceName();
      }
    });
    
    deviceNameInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') this.blur();
    });
    
    document.querySelector('.edit-btn').addEventListener('click', () => {
      deviceNameInput.focus();
    });

    // Êñá‰ª∂‰∏ä‰º†
    const fileInput = document.getElementById('fileInput');
    const mainUploadBtn = document.getElementById('mainUploadBtn');
    
    mainUploadBtn.addEventListener('click', () => {
      const deviceList = Array.from(devices.keys()).filter(id => id !== myDeviceId);
      if (deviceList.length === 0) {
        showNotification('Ê≤°ÊúâÂèØÁî®ÁöÑËÆæÂ§á');
        return;
      }
      // ÂÖàÊ∏ÖÁ©∫inputÁöÑvalueÔºåÁ°Æ‰øùÁõ∏ÂêåÊñá‰ª∂ÂèØ‰ª•ÂÜçÊ¨°ÈÄâÊã©
      fileInput.value = '';
      fileInput.click();
    });
    
    mainUploadBtn.addEventListener('dragover', e => { 
      e.preventDefault(); 
      mainUploadBtn.style.transform = 'scale(1.05)';
      mainUploadBtn.style.boxShadow = 'var(--shadow-lg), 0 0 0 10px rgba(59, 130, 246, 0.15)';
    });
    
    mainUploadBtn.addEventListener('dragleave', e => { 
      mainUploadBtn.style.transform = '';
      mainUploadBtn.style.boxShadow = '';
    });
    
    mainUploadBtn.addEventListener('drop', e => {
      e.preventDefault();
      mainUploadBtn.style.transform = '';
      mainUploadBtn.style.boxShadow = '';
      handleFiles(e.dataTransfer.files);
      // Ê∏ÖÁ©∫ÊãñÊîæ‰∫ã‰ª∂Êï∞ÊçÆ
      e.dataTransfer.clearData();
    });
    
    fileInput.addEventListener('change', e => {
      debugLog('FILE-SELECT', `Áî®Êà∑ÈÄâÊã©‰∫Ü ${e.target.files?.length || 0} ‰∏™Êñá‰ª∂`);
      if (e.target.files?.length) {
        handleFiles(e.target.files);
      }
    });

    // Êñá‰ª∂Â§π‰∏ä‰º†
    const folderInput = document.getElementById('folderInput');
    document.getElementById('uploadFolderBtn').onclick = () => {
      const deviceList = Array.from(devices.keys()).filter(id => id !== myDeviceId);
      if (deviceList.length === 0) {
        showNotification('Ê≤°ÊúâÂèØÁî®ÁöÑËÆæÂ§á');
        return;
      }
      // ÂÖàÊ∏ÖÁ©∫inputÁöÑvalue
      folderInput.value = '';
      folderInput.click();
    };
    folderInput.addEventListener('change', e => {
      debugLog('FOLDER-SELECT', `Áî®Êà∑ÈÄâÊã©‰∫Ü ${e.target.files?.length || 0} ‰∏™Êñá‰ª∂`);
      if (e.target.files?.length) {
        handleFiles(e.target.files);
      }
    });

    // ÂèëÈÄÅÊñáÊú¨Ê∂àÊÅØ
    document.getElementById('sendTextBtn').addEventListener('click', () => {
      const deviceList = Array.from(devices.keys()).filter(id => id !== myDeviceId);
      if (deviceList.length === 0) {
        showNotification('Ê≤°ÊúâÂèØÁî®ÁöÑËÆæÂ§á');
        return;
      }
      
      // Â¶ÇÊûúÂ∑≤ÁªèÈÄâÊã©‰∫ÜÂ§ö‰∏™ËÆæÂ§áÔºåÁõ¥Êé•‰ΩøÁî®Ëøô‰∫õËÆæÂ§á
      if (selectedDevices.size > 0) {
        showMessageInputMulti(Array.from(selectedDevices));
      } 
      // Â¶ÇÊûúÂ∑≤ÁªèÈÄâÊã©‰∫ÜÂçï‰∏™ËÆæÂ§áÔºå‰ΩøÁî®ËØ•ËÆæÂ§á
      else if (selectedDeviceId) {
        showMessageInput(selectedDeviceId);
      } 
      // Âê¶ÂàôÊòæÁ§∫ËÆæÂ§áÈÄâÊã©
      else {
        showDeviceSelector(deviceList, (targetIds) => {
          if (targetIds.length === 1) {
            showMessageInput(targetIds[0]);
          } else if (targetIds.length > 1) {
            showMessageInputMulti(targetIds);
          }
        });
      }
    });

    // Â§ÑÁêÜÊñá‰ª∂
    function handleFiles(files) {
      if (!files || files.length === 0) return;
      
      const deviceList = Array.from(devices.keys()).filter(id => id !== myDeviceId);
      if (deviceList.length === 0) { 
        showNotification('Ê≤°ÊúâÂèØÁî®ÁöÑËÆæÂ§á'); 
        return; 
      }
      
      // Â¶ÇÊûúÂ∑≤ÁªèÈÄâÊã©‰∫ÜÂ§ö‰∏™ËÆæÂ§áÔºåÁõ¥Êé•‰ΩøÁî®Ëøô‰∫õËÆæÂ§á
      if (selectedDevices.size > 0) {
        showFileTransferConfirmMulti(files, Array.from(selectedDevices));
      } 
      // Â¶ÇÊûúÂ∑≤ÁªèÈÄâÊã©‰∫ÜÂçï‰∏™ËÆæÂ§áÔºå‰ΩøÁî®ËØ•ËÆæÂ§á
      else if (selectedDeviceId) {
        showFileTransferConfirm(files, selectedDeviceId);
      } 
      // Âê¶ÂàôÂºπÂá∫ËÆæÂ§áÂàóË°®ÈÄâÊã©
      else {
        showDevicesModal();
        showNotification('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂèëÈÄÅÂà∞ÁöÑËÆæÂ§á');
      }
    }
    
    // ÊòæÁ§∫ËÆæÂ§áÈÄâÊã©Âô®
    function showDeviceSelector(deviceList, callback) {
      let deviceListHtml = '<div class="device-select-container">';
      
      deviceList.forEach(deviceId => {
        const device = devices.get(deviceId);
        if (!device) return;
        
        const name = device.name || `ËÆæÂ§á ${deviceId.slice(0, 6)}`;
        const icon = device.icon || 'ri-device-line';
        
        deviceListHtml += `
          <div class="device-option" data-id="${deviceId}">
            <div class="checkbox"><i class="ri-check-line"></i></div>
            <i class="${icon}"></i>
            <span>${name}</span>
          </div>
        `;
      });
      
      deviceListHtml += '</div>';
      deviceListHtml += '<span class="device-select-all">ÂÖ®ÈÄâ</span>';
      
      showModal(
        'ÈÄâÊã©ËÆæÂ§á',
        deviceListHtml,
        [
          {
            text: 'Á°ÆËÆ§',
            class: 'primary',
            action: () => {
              const selectedIds = [];
              document.querySelectorAll('.device-option .checkbox.checked').forEach(checkbox => {
                const deviceId = checkbox.parentElement.dataset.id;
                selectedIds.push(deviceId);
              });
              
              if (selectedIds.length === 0) {
                showNotification('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ËÆæÂ§á');
                return;
              }
              
              closeModal();
              callback(selectedIds);
            }
          },
          {
            text: 'ÂèñÊ∂à',
            class: 'secondary',
            action: closeModal
          }
        ]
      );
      
      // ËÆæÁΩÆÁÇπÂáª‰∫ã‰ª∂
      setTimeout(() => {
        const checkboxes = document.querySelectorAll('.device-option');
        checkboxes.forEach(option => {
          option.addEventListener('click', () => {
            const checkbox = option.querySelector('.checkbox');
            checkbox.classList.toggle('checked');
          });
        });
        
        const selectAllBtn = document.querySelector('.device-select-all');
        selectAllBtn.addEventListener('click', () => {
          const allChecked = document.querySelectorAll('.device-option .checkbox.checked').length === checkboxes.length;
          
          checkboxes.forEach(option => {
            const checkbox = option.querySelector('.checkbox');
            if (allChecked) {
              checkbox.classList.remove('checked');
            } else {
              checkbox.classList.add('checked');
            }
          });
        });
      }, 100);
    }
    
    // Á°ÆËÆ§Êñá‰ª∂‰º†ËæìÂà∞Âçï‰∏™ËÆæÂ§á
    function showFileTransferConfirm(files, targetId) {
      const device = devices.get(targetId);
      const deviceName = device ? device.name || `ËÆæÂ§á ${targetId.slice(0, 6)}` : `ËÆæÂ§á ${targetId.slice(0, 6)}`;
      
      let fileListHtml = '';
      if (files.length <= 3) {
        for (const file of files) {
          fileListHtml += `<div style="text-align:left;margin:3px 0;"><i class="ri-file-line"></i> ${file.name} (${formatFileSize(file.size)})</div>`;
        }
      } else {
        fileListHtml = `<div>${files.length} ‰∏™Êñá‰ª∂ÔºåÊÄªÂ§ßÂ∞è: ${formatFileSize(Array.from(files).reduce((total, file) => total + file.size, 0))}</div>`;
      }
      
      showModal(
        `ÂèëÈÄÅÊñá‰ª∂Ëá≥ ${deviceName}`,
        `<div style="margin-bottom:1rem;">${fileListHtml}</div>`,
        [
          { 
            text: 'ÂèëÈÄÅ', 
            class: 'primary', 
            action: () => {
              for (const file of files) {
                startFileTransfer(file, targetId);
              }
              closeModal();
              
              // Ê∏ÖÈô§ËæìÂÖ•Áä∂ÊÄÅÔºåÁ°Æ‰øùÂêå‰∏ÄÊñá‰ª∂ÂèØ‰ª•ÂÜçÊ¨°ÈÄâÊã©
              fileInput.value = '';
              folderInput.value = '';
            }
          },
          { 
            text: 'ÂèñÊ∂à', 
            class: 'secondary', 
            action: () => {
              closeModal();
              // Ê∏ÖÈô§ËæìÂÖ•Áä∂ÊÄÅ
              fileInput.value = '';
              folderInput.value = '';
            } 
          }
        ]
      );
    }
    
    // Á°ÆËÆ§Êñá‰ª∂‰º†ËæìÂà∞Â§ö‰∏™ËÆæÂ§á
    function showFileTransferConfirmMulti(files, targetIds) {
      const deviceNames = targetIds.map(id => {
        const device = devices.get(id);
        return device ? device.name || `ËÆæÂ§á ${id.slice(0, 6)}` : `ËÆæÂ§á ${id.slice(0, 6)}`;
      });
      
      let fileListHtml = '';
      if (files.length <= 3) {
        for (const file of files) {
          fileListHtml += `<div style="text-align:left;margin:3px 0;"><i class="ri-file-line"></i> ${file.name} (${formatFileSize(file.size)})</div>`;
        }
      } else {
        fileListHtml = `<div>${files.length} ‰∏™Êñá‰ª∂ÔºåÊÄªÂ§ßÂ∞è: ${formatFileSize(Array.from(files).reduce((total, file) => total + file.size, 0))}</div>`;
      }
      
      showModal(
        `ÂèëÈÄÅÊñá‰ª∂Ëá≥ ${targetIds.length} ‰∏™ËÆæÂ§á`,
        `
          <div style="margin-bottom:1rem;">${fileListHtml}</div>
          <div style="font-size:0.875rem;color:var(--color-text-secondary);margin-bottom:0.5rem;">Êé•Êî∂ËÆæÂ§áÔºö</div>
          <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;">
            ${deviceNames.map(name => `<span style="background:var(--color-surface);padding:2px 8px;border-radius:var(--radius-full);font-size:0.75rem;">${name}</span>`).join('')}
          </div>
        `,
        [
          { 
            text: 'ÂèëÈÄÅ', 
            class: 'primary', 
            action: () => {
              for (const file of files) {
                // ËÆ∞ÂΩïÂºÄÂßãÊó∂Èó¥Áî®‰∫éËÆ°ÁÆóÊÄªÈÄüÂ∫¶
                const startTime = Date.now();
                
                // ‰∏∫ÊØè‰∏™ÁõÆÊ†áËÆæÂ§áÂçïÁã¨ÂêØÂä®‰º†Ëæì
                const transferMappings = [];
                for (const targetId of targetIds) {
                  const transferId = startFileTransfer(file, targetId);
                  transferMappings.push({ targetId, transferId });
                  // Âª∫Á´ãÊò†Â∞ÑÂÖ≥Á≥ª
                  fileTransferMappings.set(transferId, targetId);
                }
                
                debugLog('MULTI-SEND', `Â§öËÆæÂ§á‰º†ËæìÂºÄÂßã`, { 
                  fileName: file.name, 
                  targetCount: targetIds.length, 
                  mappings: transferMappings 
                });
              }
              closeModal();
              showNotification(`Ê≠£Âú®Âêë ${targetIds.length} ‰∏™ËÆæÂ§áÂèëÈÄÅ ${files.length} ‰∏™Êñá‰ª∂`);
              
              // Ê∏ÖÈô§ËæìÂÖ•Áä∂ÊÄÅÔºåÁ°Æ‰øùÂêå‰∏ÄÊñá‰ª∂ÂèØ‰ª•ÂÜçÊ¨°ÈÄâÊã©
              fileInput.value = '';
              folderInput.value = '';
            }
          },
          { 
            text: 'ÂèñÊ∂à', 
            class: 'secondary', 
            action: () => {
              closeModal();
              // Ê∏ÖÈô§ËæìÂÖ•Áä∂ÊÄÅ
              fileInput.value = '';
              folderInput.value = '';
            }
          }
        ]
      );
    }

    // Ê∂àÊÅØËæìÂÖ•Âà∞Âçï‰∏™ËÆæÂ§á
    function showMessageInput(targetId) {
      const device = devices.get(targetId);
      const deviceName = device ? device.name || `ËÆæÂ§á ${targetId.slice(0, 6)}` : `ËÆæÂ§á ${targetId.slice(0, 6)}`;
      
      showModal(
        `ÂèëÈÄÅÊ∂àÊÅØËá≥ ${deviceName}`,
        `<textarea id='msgInput' style='width:100%;height:100px;border-radius:var(--radius-md);border:1px solid var(--color-border);padding:0.75rem;font-size:0.875rem;resize:none;outline:none;background:var(--color-surface);color:var(--color-text-primary);'></textarea>`,
        [
          { 
            text: 'ÂèëÈÄÅ', 
            class: 'primary', 
            action: () => {
              const msg = document.getElementById('msgInput').value.trim();
              if (msg) {
                socket.emit('send-message', { targetId, message: msg });
                showNotification('Ê∂àÊÅØÂ∑≤ÂèëÈÄÅ');
              }
              closeModal();
            }
          },
          { 
            text: 'ÂèñÊ∂à', 
            class: 'secondary', 
            action: closeModal 
          }
        ]
      );
      
      // Ëá™Âä®ËÅöÁÑ¶ÊñáÊú¨Ê°Ü
      setTimeout(() => {
        document.getElementById('msgInput').focus();
      }, 300);
    }
    
    // Ê∂àÊÅØËæìÂÖ•Âà∞Â§ö‰∏™ËÆæÂ§á
    function showMessageInputMulti(targetIds) {
      const deviceNames = targetIds.map(id => {
        const device = devices.get(id);
        return device ? device.name || `ËÆæÂ§á ${id.slice(0, 6)}` : `ËÆæÂ§á ${id.slice(0, 6)}`;
      });
      
      showModal(
        `ÂèëÈÄÅÊ∂àÊÅØËá≥ ${targetIds.length} ‰∏™ËÆæÂ§á`,
        `
          <div style="font-size:0.875rem;color:var(--color-text-secondary);margin-bottom:0.5rem;">Êé•Êî∂ËÆæÂ§áÔºö</div>
          <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;">
            ${deviceNames.map(name => `<span style="background:var(--color-surface);padding:2px 8px;border-radius:var(--radius-full);font-size:0.75rem;">${name}</span>`).join('')}
          </div>
          <textarea id='msgInput' style='width:100%;height:100px;border-radius:var(--radius-md);border:1px solid var(--color-border);padding:0.75rem;font-size:0.875rem;resize:none;outline:none;background:var(--color-surface);color:var(--color-text-primary);'></textarea>
        `,
        [
          { 
            text: 'ÂèëÈÄÅ', 
            class: 'primary', 
            action: () => {
              const msg = document.getElementById('msgInput').value.trim();
              if (msg) {
                for (const targetId of targetIds) {
                  socket.emit('send-message', { targetId, message: msg });
                }
                showNotification(`Â∑≤Âêë ${targetIds.length} ‰∏™ËÆæÂ§áÂèëÈÄÅÊ∂àÊÅØ`);
              }
              closeModal();
            }
          },
          { 
            text: 'ÂèñÊ∂à', 
            class: 'secondary', 
            action: closeModal 
          }
        ]
      );
      
      // Ëá™Âä®ËÅöÁÑ¶ÊñáÊú¨Ê°Ü
      setTimeout(() => {
        document.getElementById('msgInput').focus();
      }, 300);
    }

    // Êñá‰ª∂‰º†Ëæì
    function startFileTransfer(file, targetId) {
      // ‰ΩøÁî®Êõ¥Â§çÊùÇÁöÑÊñπÂºèÁîüÊàêÂîØ‰∏ÄIDÔºåÁ°Æ‰øùÊØèÊ¨°‰º†ËæìÁöÑIDÈÉΩ‰∏çÂêå
      const transferId = `${Date.now().toString()}-${Math.random().toString(36).substr(2, 9)}-${file.name.substring(0, 6).replace(/\s+/g, '-')}`;
      
      activeTransfers.set(transferId, { 
        file, 
        targetId, 
        progress: 0, 
        startTime: Date.now(),
        name: file.name,
        size: file.size,
        status: 'waiting' // Êñ∞Áä∂ÊÄÅÔºöÁ≠âÂæÖÊé•Êî∂ÊñπÁ°ÆËÆ§
      });
      
      debugLog('SEND', `ËØ∑Ê±Ç‰º†ËæìÊñá‰ª∂ ${file.name} Âà∞ ${targetId}`, {
        transferId,
        fileSize: file.size
      });
      
      // Ê∑ªÂä†Âà∞Êò†Â∞ÑË°®
      fileTransferMappings.set(transferId, targetId);
      
      // ÂèëÈÄÅ‰º†ËæìËØ∑Ê±ÇÔºåÁ≠âÂæÖÁ°ÆËÆ§
      socket.emit('file-transfer-request', { 
        targetId, 
        fileName: file.name, 
        fileSize: file.size, 
        transferId 
      });
      
      // ÊòæÁ§∫Á≠âÂæÖÊé•Êî∂ÊñπÁ°ÆËÆ§ÁöÑËøõÂ∫¶UI
      showTransferWaitingUI(transferId);
      
      showNotification(`Á≠âÂæÖÂØπÊñπÊé•ÂèóÊñá‰ª∂...`);
      
      return transferId;
    }

    // ÊòæÁ§∫Á≠âÂæÖÊé•Êî∂ÊñπÁ°ÆËÆ§ÁöÑUI
    function showTransferWaitingUI(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) return;
      
      debugLog('UI', 'ÊòæÁ§∫Á≠âÂæÖÁ°ÆËÆ§UI', { transferId });
      
      // ÂàõÂª∫ÊàñËé∑ÂèñËΩ¨ËæìÂÆπÂô®
      let transfersContainer = document.getElementById('transfersContainer');
      if (!transfersContainer) {
        transfersContainer = document.createElement('div');
        transfersContainer.id = 'transfersContainer';
        transfersContainer.style.cssText = `
          position: fixed;
          bottom: 1rem;
          right: 1rem;
          z-index: 1000;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
        `;
        document.body.appendChild(transfersContainer);
      }
      
      // ÂàõÂª∫Á≠âÂæÖUIÂÖÉÁ¥†
      const waitingElement = document.createElement('div');
      waitingElement.id = `transfer-${transferId}`;
      waitingElement.className = 'transfer-progress';
      waitingElement.innerHTML = `
        <div class="transfer-header">
          <div style="display:flex;align-items:center;gap:0.5rem;">
            <i class="ri-file-transfer-line"></i>
            <span class="transfer-filename">${transfer.name}</span>
          </div>
          <div style="display:flex;align-items:center;gap:0.5rem;">
            <span class="transfer-progress-text">Á≠âÂæÖÁ°ÆËÆ§...</span>
            <button class="cancel-transfer" title="ÂèñÊ∂à‰º†Ëæì">
              <i class="ri-close-line"></i>
            </button>
          </div>
        </div>
        <div class="progress-container">
          <div class="progress-bar progress-bar-waiting" style="width: 100%"></div>
        </div>
      `;
      
      // Ê∑ªÂä†Ê†∑Âºè
      waitingElement.style.cssText = `
        background: var(--color-surface);
        border-radius: var(--radius-md);
        padding: 0.75rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        width: 300px;
        font-size: 0.875rem;
      `;
      
      // Ê∑ªÂä†CSSÊ†∑Âºè
      if (!document.getElementById('transfer-waiting-style')) {
        const styleElement = document.createElement('style');
        styleElement.id = 'transfer-waiting-style';
        styleElement.textContent = `
          .progress-bar-waiting {
            background: #999;
            animation: progress-waiting 1.5s ease-in-out infinite;
            background-image: linear-gradient(
              -45deg,
              rgba(255, 255, 255, 0.2) 25%,
              transparent 25%,
              transparent 50%,
              rgba(255, 255, 255, 0.2) 50%,
              rgba(255, 255, 255, 0.2) 75%,
              transparent 75%,
              transparent
            );
            background-size: 50px 50px;
          }
          
          @keyframes progress-waiting {
            0% {
              background-position: 0 0;
            }
            100% {
              background-position: 50px 50px;
            }
          }
        `;
        document.head.appendChild(styleElement);
      }
      
      // Ê∑ªÂä†Âà∞ÂÆπÂô®
      transfersContainer.appendChild(waitingElement);
      
      // Ê∑ªÂä†ÂèñÊ∂àÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
      const cancelButton = waitingElement.querySelector('.cancel-transfer');
      if (cancelButton) {
        cancelButton.addEventListener('click', () => {
          cancelTransfer(transferId);
        });
      }
    }

    // ÊòæÁ§∫‰º†ËæìË¢´ÊãíÁªùÁöÑUI
    function showTransferRejectedUI(transferId) {
      const progressContainer = document.getElementById(`transfer-${transferId}`);
      if (!progressContainer) return;
      
      // Â∞ÜÁ≠âÂæÖÂä®ÁîªÊõøÊç¢‰∏∫ÊãíÁªùÊèêÁ§∫
      const waitingAnimation = progressContainer.querySelector('.waiting-animation');
      if (waitingAnimation) {
        waitingAnimation.innerHTML = `
          <div style="color:#EF4444;font-weight:500;">ÂØπÊñπÊãíÁªùÊé•Êî∂</div>
        `;
      }
      
      // ÈöêËóèÂèñÊ∂àÊåâÈíÆ
      const cancelBtn = progressContainer.querySelector('.cancel-waiting-transfer');
      if (cancelBtn) {
        cancelBtn.remove();
      }
      
      // Âá†ÁßíÂêéÁßªÈô§UI
      setTimeout(() => {
        progressContainer.remove();
      }, 3000);
    }

    // ÂçïÁã¨ÁöÑÂèëÈÄÅÊñá‰ª∂Êï∞ÊçÆÂáΩÊï∞
    function sendFileData(file, targetId, transferId) {
      const chunkSize = 64 * 1024; // 64KB
      let offset = 0;
      let lastUpdateTime = Date.now();
      
      function readNextChunk() {
        const transfer = activeTransfers.get(transferId);
        if (!transfer || transfer.status !== 'active') {
          debugLog('SEND', `‰º†Ëæì ${transferId} Â∑≤ÂÅúÊ≠¢ÊàñÂèñÊ∂à`);
          return; // Â¶ÇÊûú‰º†ËæìÂ∑≤ÂèñÊ∂àÊàñÂÆåÊàêÔºåÂÅúÊ≠¢Â§ÑÁêÜ
        }
        
        const chunk = file.slice(offset, offset + chunkSize);
        const reader = new FileReader();
        
        reader.onload = (e) => {
          // ÂÜçÊ¨°Ê£ÄÊü•‰º†ËæìÁä∂ÊÄÅ
          const transfer = activeTransfers.get(transferId);
          if (!transfer || transfer.status !== 'active') {
            return; // Â¶ÇÊûú‰º†ËæìÂ∑≤ÂèñÊ∂àÊàñÂÆåÊàêÔºåÂÅúÊ≠¢Â§ÑÁêÜ
          }
          
          debugLog('SEND', `ÂèëÈÄÅÊï∞ÊçÆÂùó ${Math.round((offset / file.size) * 100)}%`, {
            transferId,
            offset,
            chunkSize: chunk.size
          });
          
          socket.emit('file-data', { 
            targetId, 
            chunk: e.target.result, 
            offset, 
            totalSize: file.size, 
            transferId, 
            fileName: file.name 
          });
          
          offset += chunk.size;
          
          // Êõ¥Êñ∞ËøõÂ∫¶
          if (transfer) {
            const now = Date.now();
            transfer.progress = (offset / file.size) * 100;
            
            // ËÆ°ÁÆóÈÄüÂ∫¶ÔºàÊØè 500ms Êõ¥Êñ∞‰∏ÄÊ¨°Ôºâ
            if (now - lastUpdateTime > 500) {
              const elapsedTime = (now - transfer.startTime) / 1000; // Áßí
              if (elapsedTime > 0) {
                transfer.speed = offset / elapsedTime; // Â≠óËäÇ/Áßí
              }
              lastUpdateTime = now;
              updateTransferProgress(transferId);
            }
            
            activeTransfers.set(transferId, transfer);
          }
          
          if (offset < file.size) {
            // ‰ΩøÁî®setTimeoutÊ∑ªÂä†Â∞èÂª∂ËøüÔºåÈÅøÂÖçÁü≠Êó∂Èó¥ÂÜÖÂèëÈÄÅËøáÂ§öÊï∞ÊçÆ
            setTimeout(readNextChunk, 10);
          } else {
            // ‰º†ËæìÂÆåÊàê
            debugLog('SEND', `Êñá‰ª∂ ${file.name} ‰º†ËæìÂÆåÊàê`);
            const transfer = activeTransfers.get(transferId);
            if (transfer) {
              transfer.progress = 100;
              transfer.status = 'completed';
              activeTransfers.set(transferId, transfer);
              updateTransferProgress(transferId);
            }
            showNotification(`Êñá‰ª∂ ${file.name} ‰º†ËæìÂÆåÊàê`);
            
            // Âá†ÁßíÂêéÁßªÈô§ËøõÂ∫¶Êù°
            setTimeout(() => {
              document.getElementById(`transfer-${transferId}`)?.remove();
            }, 3000);
          }
        };
        
        reader.onerror = (err) => {
          debugLog('SEND ERROR', `ËØªÂèñÊñá‰ª∂ÂùóÂá∫Èîô: ${err}`);
          const transfer = activeTransfers.get(transferId);
          if (transfer) {
            transfer.status = 'failed';
            activeTransfers.set(transferId, transfer);
            updateTransferProgress(transferId);
            showNotification(`Êñá‰ª∂ ${file.name} ‰º†ËæìÂ§±Ë¥•`);
          }
        };
        
        reader.readAsArrayBuffer(chunk);
      }
      
      readNextChunk();
    }

    // ÂèñÊ∂àÊñá‰ª∂‰º†Ëæì
    function cancelTransfer(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) return;
      
      debugLog('CANCEL', `ÂèñÊ∂àÊñá‰ª∂‰º†Ëæì`, { transferId, status: transfer.status });
      
      // Êõ¥Êñ∞Áä∂ÊÄÅ
      transfer.status = 'cancelled';
      activeTransfers.set(transferId, transfer);
      
      // ÈÄöÁü•ÂØπÊñπ‰º†ËæìÂ∑≤ÂèñÊ∂à
      if (transfer.targetId) {
        socket.emit('cancel-transfer', {
          targetId: transfer.targetId,
          transferId
        });
      }
      
      // Êõ¥Êñ∞UI
      updateTransferProgress(transferId);
      
      // ÊòæÁ§∫ÈÄöÁü•
      const actionText = transfer.targetId ? 'ÂèëÈÄÅ' : 'Êé•Êî∂';
      showNotification(`Â∑≤ÂèñÊ∂à${actionText}Êñá‰ª∂ ${transfer.name}`);
      
      // ‰∏ÄÊÆµÊó∂Èó¥ÂêéÁßªÈô§UI
      setTimeout(() => {
        const element = document.getElementById(`transfer-${transferId}`);
        if (element) {
          element.style.opacity = '0';
          element.style.transition = 'opacity 0.5s ease';
          setTimeout(() => element.remove(), 500);
        }
      }, 3000);
    }
    
    // ÊòæÁ§∫‰º†ËæìËøõÂ∫¶
    function showTransferProgress(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) {
        debugLog('ERROR', 'Êó†Ê≥ïÊòæÁ§∫ËøõÂ∫¶ÔºöÊâæ‰∏çÂà∞transferId', { transferId });
        return;
      }
      
      // Ê∏ÖÈô§Áé∞ÊúâÁöÑËøõÂ∫¶UIÔºàÂ¶ÇÊûúÊúâÔºâ
      const existingUI = document.getElementById(`transfer-${transferId}`);
      if (existingUI) existingUI.remove();
      
      debugLog('UI', 'ÂàõÂª∫Êñá‰ª∂‰º†ËæìËøõÂ∫¶UI', { transferId, status: transfer.status });
      
      // ÂàõÂª∫ËøõÂ∫¶ÊòæÁ§∫ÂÆπÂô®
      const transfersContainer = document.getElementById('transfersContainer');
      if (!transfersContainer) {
        // Â¶ÇÊûúÂÆπÂô®‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏Ä‰∏™
        const newContainer = document.createElement('div');
        newContainer.id = 'transfersContainer';
        newContainer.style.position = 'fixed';
        newContainer.style.bottom = '1rem';
        newContainer.style.right = '1rem';
        newContainer.style.zIndex = '1000';
        newContainer.style.display = 'flex';
        newContainer.style.flexDirection = 'column';
        newContainer.style.gap = '0.5rem';
        document.body.appendChild(newContainer);
      }
      
      // Ëé∑ÂèñÊàñÂàõÂª∫‰º†ËæìÂÆπÂô®
      const transfersContainer2 = document.getElementById('transfersContainer') || document.createElement('div');
      
      const fileName = transfer.name.length > 20 ? 
        transfer.name.substring(0, 17) + '...' + 
        transfer.name.substring(transfer.name.lastIndexOf('.')) : 
        transfer.name;
      
      // ÂàõÂª∫ËøõÂ∫¶Êù°ÂÖÉÁ¥†
      const progressElement = document.createElement('div');
      progressElement.id = `transfer-${transferId}`;
      progressElement.className = 'transfer-progress';
      progressElement.innerHTML = `
        <div class="transfer-header">
          <div style="display:flex;align-items:center;gap:0.5rem;">
            <i class="ri-file-transfer-line"></i>
            <span class="transfer-filename">${fileName}</span>
          </div>
          <div style="display:flex;align-items:center;gap:0.5rem;">
            <span class="transfer-progress-text">0%</span>
            <span class="transfer-speed">ÂáÜÂ§á‰∏≠...</span>
            <button class="cancel-transfer" title="ÂèñÊ∂à‰º†Ëæì">
              <i class="ri-close-line"></i>
            </button>
          </div>
        </div>
        <div class="progress-container">
          <div class="progress-bar" style="width: 0%"></div>
        </div>
      `;
      
      // Ê∑ªÂä†Ê†∑Âºè
      progressElement.style.cssText = `
        background: var(--color-surface);
        border-radius: var(--radius-md);
        padding: 0.75rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        width: 300px;
        font-size: 0.875rem;
      `;
      
      // Ê∑ªÂä†Âà∞ÂÆπÂô®
      transfersContainer2.appendChild(progressElement);
      
      // Á°Æ‰øùÂÆπÂô®Âú®DOM‰∏≠
      if (!document.getElementById('transfersContainer')) {
        document.body.appendChild(transfersContainer2);
      }
      
      // Ê∑ªÂä†ÂèñÊ∂àÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
      const cancelButton = progressElement.querySelector('.cancel-transfer');
      if (cancelButton) {
        cancelButton.addEventListener('click', () => {
          cancelTransfer(transferId);
        });
      }
      
      // ÂàùÂßãÊõ¥Êñ∞
      updateTransferProgress(transferId);
    }
    
    // Êõ¥Êñ∞‰º†ËæìËøõÂ∫¶
    function updateTransferProgress(transferId) {
      const transfer = activeTransfers.get(transferId);
      if (!transfer) return;
      
      const progressContainer = document.getElementById(`transfer-${transferId}`);
      if (!progressContainer) {
        // Â¶ÇÊûúÂÆπÂô®‰∏çÂ≠òÂú®ÔºåÂÖàÂàõÂª∫ÂÆÉ
        showTransferProgress(transferId);
        return;
      }
      
      const progressBar = progressContainer.querySelector('.progress-bar');
      const progressText = progressContainer.querySelector('.transfer-progress-text');
      const speedText = progressContainer.querySelector('.transfer-speed');
      const cancelButton = progressContainer.querySelector('.cancel-transfer');
      
      // Ê£ÄÊü•ÊâÄÊúâÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
      if (!progressBar || !progressText || !speedText) {
        debugLog('ERROR', 'ËøõÂ∫¶UIÂÖÉÁ¥†‰∏çÂÆåÊï¥ÔºåÈáçÊñ∞ÂàõÂª∫', { transferId });
        progressContainer.remove();
        showTransferProgress(transferId);
        return;
      }
      
      // Ê†πÊçÆ‰º†ËæìÁä∂ÊÄÅÊõ¥Êñ∞UI
      switch (transfer.status) {
        case 'active':
          progressBar.style.width = `${transfer.progress}%`;
          progressText.textContent = `${Math.round(transfer.progress)}%`;
          
          if (transfer.speed) {
            speedText.textContent = `${formatFileSize(transfer.speed)}/s`;
          } else {
            speedText.textContent = `ÂáÜÂ§á‰∏≠...`;
          }
          
          if (cancelButton) cancelButton.style.display = 'block';
          break;
          
        case 'completed':
          progressBar.style.width = '100%';
          progressText.textContent = '100%';
          speedText.textContent = 'Â∑≤ÂÆåÊàê';
          if (cancelButton) cancelButton.style.display = 'none';
          break;
          
        case 'cancelled':
          progressBar.style.width = `${transfer.progress}%`;
          progressBar.style.background = 'var(--color-text-tertiary)';
          progressText.textContent = 'Â∑≤ÂèñÊ∂à';
          speedText.textContent = '';
          if (cancelButton) cancelButton.style.display = 'none';
          break;
          
        case 'failed':
          progressBar.style.width = `${transfer.progress}%`;
          progressBar.style.background = '#EF4444';
          progressText.textContent = 'Â§±Ë¥•';
          speedText.textContent = '';
          if (cancelButton) cancelButton.style.display = 'none';
          break;
      }
    }

    // Êñá‰ª∂Êé•Êî∂ - ÂÆåÂÖ®ÈáçÂÜô
    function handleFileReceive(data) {
      const sender = devices.get(data.fromId);
      const senderName = sender ? sender.name || `ËÆæÂ§á ${data.fromId.slice(0, 6)}` : `ËÆæÂ§á ${data.fromId.slice(0, 6)}`;
      const transferId = data.transferId || `receive-${Date.now()}`;
      
      debugLog('RECEIVE', 'Êî∂Âà∞Êñá‰ª∂‰º†ËæìËØ∑Ê±Ç', { 
        fromId: data.fromId, 
        fileName: data.fileName, 
        fileSize: data.fileSize,
        transferId: transferId
      });
      
      showModal(
        'Êé•Êî∂Êñá‰ª∂',
        `<div style="margin-bottom:1rem;">
          <div style="margin-bottom:0.5rem;font-weight:500;">Êù•Ëá™ ${senderName} ÁöÑÊñá‰ª∂Ôºö</div>
          <div style="display:flex;align-items:center;gap:0.5rem;border-radius:var(--radius-md);background:var(--color-surface);padding:0.75rem;">
            <i class="ri-file-line" style="font-size:1.5rem;color:var(--color-primary);"></i>
            <div>
              <div style="font-weight:500;">${data.fileName}</div>
              <div style="font-size:0.75rem;color:var(--color-text-tertiary);">${formatFileSize(data.fileSize)}</div>
            </div>
          </div>
        </div>`,
        [
          { 
            text: 'Êé•Êî∂', 
            class: 'primary', 
            action: () => { 
              debugLog('RECEIVE', 'Áî®Êà∑Êé•ÂèóÊñá‰ª∂‰º†Ëæì');
              
              // 1. ÂèëÈÄÅÊé•ÂèóÂìçÂ∫îÁªôÂèëÈÄÅÊñπ
              socket.emit('file-transfer-response', {
                targetId: data.fromId,
                transferId: transferId,
                accepted: true
              });
              
              // 2. ÂàõÂª∫Êé•Êî∂Áä∂ÊÄÅ
              fileReceivers.set(transferId, {
                fileName: data.fileName,
                fileSize: data.fileSize,
                chunks: [],
                receivedSize: 0,
                active: true,
                startTime: Date.now()
              });
              
              // 3. ÊòæÁ§∫Êé•Êî∂ËøõÂ∫¶UI
              createReceiveProgressUI(transferId, data.fileName, data.fileSize);
              
              showNotification(`Ê≠£Âú®Êé•Êî∂ ${data.fileName}`);
              closeModal(); 
            } 
          },
          { 
            text: 'ÊãíÁªù', 
            class: 'secondary', 
            action: () => { 
              debugLog('RECEIVE', 'Áî®Êà∑ÊãíÁªùÊñá‰ª∂‰º†Ëæì');
              
              // ÂèëÈÄÅÊãíÁªùÂìçÂ∫îÁªôÂèëÈÄÅÊñπ
              socket.emit('file-transfer-response', {
                targetId: data.fromId,
                transferId: transferId,
                accepted: false
              });
              
              closeModal(); 
            }
          }
        ]
      );
    }
    
    // ÂàõÂª∫Êñá‰ª∂Êé•Êî∂ËøõÂ∫¶UI
    function createReceiveProgressUI(transferId, fileName, fileSize) {
      const containerId = `receive-${transferId}`;
      
      // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
      if (document.getElementById(containerId)) return;
      
      const container = document.createElement('div');
      container.id = containerId;
      container.className = 'transfer-progress-container';
      container.style.position = 'fixed';
      container.style.bottom = '70px';
      container.style.left = '50%';
      container.style.transform = 'translateX(-50%)';
      container.style.background = 'var(--color-background)';
      container.style.borderRadius = 'var(--radius-lg)';
      container.style.padding = '0.75rem 1rem';
      container.style.boxShadow = 'var(--shadow-md)';
      container.style.width = '280px';
      container.style.zIndex = '50';
      
      container.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
          <div style="font-size:0.875rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px;">
            Ê≠£Âú®Êé•Êî∂: ${fileName}
          </div>
          <div style="font-size:0.75rem;color:var(--color-text-tertiary);" class="transfer-size">
            ${formatFileSize(fileSize)}
          </div>
        </div>
        <div class="transfer-progress">
          <div class="progress-bar" style="width:0%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--color-text-tertiary);margin-top:0.25rem;">
          <span class="progress-text">0%</span>
          <span class="progress-speed">Êé•Êî∂‰∏≠...</span>
        </div>
      `;
      
      document.body.appendChild(container);
      debugLog('UI', 'ÂàõÂª∫Êé•Êî∂ËøõÂ∫¶UI');
    }
    
    // Êõ¥Êñ∞Êé•Êî∂ËøõÂ∫¶UI
    function updateReceiveProgressUI(transferId, progress, status = 'active') {
      const container = document.getElementById(`receive-${transferId}`);
      if (!container) return;
      
      const progressBar = container.querySelector('.progress-bar');
      const progressText = container.querySelector('.progress-text');
      const speedText = container.querySelector('.progress-speed');
      
      // Á°Æ‰øùËøõÂ∫¶‰∏çË∂ÖËøá100%
      progress = Math.min(100, progress);
      
      switch (status) {
        case 'active':
          progressBar.style.width = `${progress}%`;
          progressText.textContent = `${Math.round(progress)}%`;
          break;
          
        case 'completed':
          progressBar.style.width = '100%';
          progressText.textContent = '100%';
          speedText.textContent = 'Â∑≤ÂÆåÊàê';
          
          // Âá†ÁßíÂêéÁßªÈô§UI
          setTimeout(() => {
            container.remove();
          }, 3000);
          break;
          
        case 'failed':
          progressBar.style.width = `${progress}%`;
          progressBar.style.background = '#EF4444';
          progressText.textContent = 'Â§±Ë¥•';
          speedText.textContent = '';
          
          // Âá†ÁßíÂêéÁßªÈô§UI
          setTimeout(() => {
            container.remove();
          }, 3000);
          break;
      }
    }
    
    // ÈáçÂÜôÊñá‰ª∂Êï∞ÊçÆÊé•Êî∂Â§ÑÁêÜ
    socket.on('file-data', (data) => {
      try {
        const transferId = data.transferId || 'default';
        
        debugLog('FILE-DATA', 'Êî∂Âà∞Êñá‰ª∂Êï∞ÊçÆ', { 
          transferId,
          chunkType: data.chunk ? (typeof data.chunk) : 'Êú™Áü•',
          chunkConstructor: data.chunk ? (data.chunk.constructor ? data.chunk.constructor.name : 'Êú™Áü•') : 'Êú™Áü•',
          offset: data.offset,
          totalSize: data.totalSize
        });
        
        // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®Êé•Êî∂Áä∂ÊÄÅ
        if (!fileReceivers.has(transferId)) {
          debugLog('FILE-DATA', 'Êú™ÊâæÂà∞Êé•Êî∂Áä∂ÊÄÅÔºåÂøΩÁï•Êï∞ÊçÆ');
          return;
        }
        
        const receiver = fileReceivers.get(transferId);
        
        // Ê£ÄÊü•ÊòØÂê¶Â§Ñ‰∫éÊ¥ªÂä®Áä∂ÊÄÅ
        if (!receiver.active) {
          debugLog('FILE-DATA', 'Êé•Êî∂Â∑≤ÂÅúÊ≠¢ÔºåÂøΩÁï•Êï∞ÊçÆ');
          return;
        }
        
        // Â§ÑÁêÜÊï∞ÊçÆÂùó
        let chunk = data.chunk;
        let chunkSize = 0;
        
        // Â∞ùËØïÁ°ÆÂÆöÊï∞ÊçÆÂ§ßÂ∞è
        if (chunk.byteLength !== undefined) {
          chunkSize = chunk.byteLength;
        } else if (chunk.length !== undefined) {
          chunkSize = chunk.length;
        } else {
          debugLog('FILE-DATA', 'Êó†Ê≥ïÁ°ÆÂÆöÊï∞ÊçÆÂùóÂ§ßÂ∞èÔºå‰ΩøÁî®‰º∞ÁÆóÂÄº');
          chunkSize = 1024; // ‰º∞ÁÆóÂÄº
        }
        
        // Ê∑ªÂä†Êï∞ÊçÆÂùó
        receiver.chunks.push(chunk);
        receiver.receivedSize += chunkSize;
        
        // ËÆ°ÁÆóËøõÂ∫¶
        const progress = (receiver.receivedSize / receiver.fileSize) * 100;
        
        // Êõ¥Êñ∞UIËøõÂ∫¶
        updateReceiveProgressUI(transferId, progress);
        
        // Ê£ÄÊü•ÊòØÂê¶Êé•Êî∂ÂÆåÊàêÔºàÂÖÅËÆ∏1KBËØØÂ∑ÆÔºâ
        if (Math.abs(receiver.receivedSize - receiver.fileSize) <= 1024) {
          debugLog('FILE-DATA', 'Êñá‰ª∂Êé•Êî∂ÂÆåÊàê', {
            fileName: receiver.fileName,
            receivedSize: receiver.receivedSize,
            fileSize: receiver.fileSize
          });
          
          // Êõ¥Êñ∞UI‰∏∫ÂÆåÊàêÁä∂ÊÄÅ
          updateReceiveProgressUI(transferId, 100, 'completed');
          
          // ‰øùÂ≠òÊñá‰ª∂
          saveReceivedFile(transferId);
        }
      } catch (error) {
        debugLog('FILE-DATA ERROR', 'Â§ÑÁêÜÊñá‰ª∂Êï∞ÊçÆÂá∫Èîô', error);
        console.error('Â§ÑÁêÜÊñá‰ª∂Êï∞ÊçÆÂá∫Èîô:', error);
        showNotification('Êñá‰ª∂Êé•Êî∂Â§±Ë¥•: ' + error.message);
      }
    });
    
    // ‰øùÂ≠òÊé•Êî∂Âà∞ÁöÑÊñá‰ª∂
    function saveReceivedFile(transferId) {
      try {
        const receiver = fileReceivers.get(transferId);
        if (!receiver || !receiver.chunks || receiver.chunks.length === 0) {
          throw new Error('Ê≤°ÊúâÊúâÊïàÁöÑÊñá‰ª∂Êï∞ÊçÆ');
        }
        
        debugLog('SAVE', 'ÂáÜÂ§á‰øùÂ≠òÊñá‰ª∂', {
          fileName: receiver.fileName,
          chunksCount: receiver.chunks.length,
          totalSize: receiver.receivedSize
        });
        
        // ÂàõÂª∫BlobÂØπË±°
        const blob = new Blob(receiver.chunks, { type: getMimeType(receiver.fileName.split('.').pop().toLowerCase()) });
        debugLog('SAVE', 'BlobÂàõÂª∫ÊàêÂäü', { size: blob.size });
        
        // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
        const url = URL.createObjectURL(blob);
        debugLog('SAVE', 'URLÂàõÂª∫ÊàêÂäü');
        
        // ÊòæÁ§∫‰øùÂ≠òÂØπËØùÊ°Ü
        showSaveFileDialog(url, receiver.fileName, blob.size, transferId);
        
        // Ê†áËÆ∞Êé•Êî∂ÂÆåÊàê
        receiver.active = false;
        
      } catch (error) {
        debugLog('SAVE ERROR', '‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•', error);
        console.error('‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•:', error);
        showNotification('‰øùÂ≠òÊñá‰ª∂Â§±Ë¥•: ' + error.message);
      }
    }
    
    // ‰øÆÊîπ‰øùÂ≠òÊñá‰ª∂ÂØπËØùÊ°ÜÂáΩÊï∞ÔºåÊ∑ªÂä†transferIdÂèÇÊï∞
    function showSaveFileDialog(url, fileName, fileSize, transferId) {
      // Ê£ÄÊµãÊñá‰ª∂Á±ªÂûã
      const fileExt = fileName.split('.').pop().toLowerCase();
      
      // Ëé∑ÂèñMIMEÁ±ªÂûã
      const mimeType = getMimeType(fileExt);
      const isPreviewable = isFilePreviewable(fileExt, mimeType);
      
      debugLog('SAVE', 'ÂáÜÂ§áÊòæÁ§∫Êñá‰ª∂‰øùÂ≠òÂØπËØùÊ°Ü', { 
        fileName, 
        fileSize, 
        fileExt, 
        mimeType, 
        isPreviewable,
        transferId
      });
      
      let previewHtml = '';
      if (isPreviewable) {
        if (mimeType.startsWith('image/')) {
          previewHtml = `<img src="${url}" style="max-width:100%;max-height:200px;margin-bottom:1rem;border-radius:var(--radius-md);" />`;
        } else if (mimeType.startsWith('video/')) {
          previewHtml = `<video src="${url}" controls style="max-width:100%;max-height:200px;margin-bottom:1rem;border-radius:var(--radius-md);"></video>`;
        } else if (mimeType.startsWith('audio/')) {
          previewHtml = `<audio src="${url}" controls style="width:100%;margin-bottom:1rem;"></audio>`;
        }
      }
      
      showModal(
        'Êñá‰ª∂Â∑≤Êé•Êî∂',
        `
        <div style="text-align:center;margin-bottom:1rem;">
          ${previewHtml}
          <div style="font-size:1.2rem;font-weight:500;margin-bottom:0.5rem;">
            ${fileName || 'Êé•Êî∂ÁöÑÊñá‰ª∂'}
          </div>
          <div style="font-size:0.9rem;color:var(--color-text-secondary);">
            Êñá‰ª∂Â§ßÂ∞è: ${formatFileSize(fileSize)}
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:0.75rem;">
          <a id="saveFileBtn" href="${url}" download="${fileName}" style="text-decoration:none;text-align:center;width:100%;padding:0.75rem;border-radius:var(--radius-md);background:var(--color-primary);color:white;font-weight:500;border:none;cursor:pointer;">
            ‰øùÂ≠òÊñá‰ª∂
          </a>
          <button id="openFileBtn" data-transfer-id="${transferId}" style="width:100%;padding:0.75rem;border-radius:var(--radius-md);background:var(--color-surface);color:var(--color-text-primary);font-weight:500;border:1px solid var(--color-border);cursor:pointer;">
            Âú®Êñ∞Á™óÂè£ÊâìÂºÄ
          </button>
        </div>
        <div style="margin-top:1rem;font-size:0.8rem;color:var(--color-text-tertiary);text-align:center;">
          ÊèêÁ§∫: Â¶ÇÊûú‰∏ãËΩΩ‰∏çËá™Âä®ÂºÄÂßãÔºåËØ∑ÁÇπÂáª"‰øùÂ≠òÊñá‰ª∂"ÊåâÈíÆ
        </div>
        `,
        [{ text: 'ÂÖ≥Èó≠', class: 'secondary', action: () => {
          // Âª∂ËøüÈáäÊîæURLÔºåÁ°Æ‰øùÊúâË∂≥Â§üÊó∂Èó¥‰∏ãËΩΩ
          setTimeout(() => {
            URL.revokeObjectURL(url);
            debugLog('SAVE', 'URLÂ∑≤ÈáäÊîæ');
          }, 5000);
          closeModal();
        }}]
      );
      
      // ËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂
      setTimeout(() => {
        document.getElementById('saveFileBtn').addEventListener('click', () => {
          debugLog('SAVE', 'Áî®Êà∑ÁÇπÂáª‰øùÂ≠òÊñá‰ª∂ÊåâÈíÆ');
          showNotification('Êñá‰ª∂ÂºÄÂßã‰∏ãËΩΩ');
        });
        
        document.getElementById('openFileBtn').addEventListener('click', (e) => {
          debugLog('SAVE', 'Áî®Êà∑ÁÇπÂáªÂú®Êñ∞Á™óÂè£ÊâìÂºÄÊåâÈíÆ');
          
          // Ëé∑ÂèñtransferId
          const openTransferId = e.currentTarget.dataset.transferId || transferId;
          const receiver = fileReceivers.get(openTransferId);
          
          if (!receiver || !receiver.chunks) {
            showNotification('Êó†Ê≥ïÊâìÂºÄÊñá‰ª∂ÔºöÊï∞ÊçÆÂ∑≤‰∏¢Â§±');
            return;
          }
          
          // ÂàõÂª∫‰∏Ä‰∏™Â∏¶ÊúâÊ≠£Á°ÆMIMEÁ±ªÂûãÁöÑÊñ∞URL
          const blob = new Blob(receiver.chunks, { type: mimeType });
          const typedUrl = URL.createObjectURL(blob);
          
          window.open(typedUrl, '_blank');
          
          // Âú®ÈÄÇÂΩìÁöÑÊó∂ÂÄôÈáäÊîæËøô‰∏™URL
          setTimeout(() => URL.revokeObjectURL(typedUrl), 30000);
        });
        
        // ÈùûÁßªÂä®ËÆæÂ§áËá™Âä®Ëß¶Âèë‰∏ãËΩΩ
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (!isPreviewable && !isMobile) {
          debugLog('SAVE', 'ÈùûÁßªÂä®ËÆæÂ§áÔºåËá™Âä®Ëß¶Âèë‰∏ãËΩΩ');
          document.getElementById('saveFileBtn').click();
        }
      }, 100);
    }

    // Ëé∑ÂèñÊñá‰ª∂MIMEÁ±ªÂûã
    function getMimeType(fileExt) {
      const mimeTypes = {
        // ÂõæÁâá
        'jpg': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'png': 'image/png',
        'gif': 'image/gif',
        'webp': 'image/webp',
        'svg': 'image/svg+xml',
        'ico': 'image/x-icon',
        
        // ÊñáÊ°£
        'pdf': 'application/pdf',
        'doc': 'application/msword',
        'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'xls': 'application/vnd.ms-excel',
        'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'ppt': 'application/vnd.ms-powerpoint',
        'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'txt': 'text/plain',
        'csv': 'text/csv',
        'json': 'application/json',
        'xml': 'application/xml',
        'html': 'text/html',
        'htm': 'text/html',
        'css': 'text/css',
        'js': 'text/javascript',
        
        // Èü≥ËßÜÈ¢ë
        'mp3': 'audio/mpeg',
        'wav': 'audio/wav',
        'mp4': 'video/mp4',
        'webm': 'video/webm',
        'ogg': 'audio/ogg',
        'ogv': 'video/ogg',
        'm4a': 'audio/mp4',
        
        // ÂéãÁº©Êñá‰ª∂
        'zip': 'application/zip',
        'rar': 'application/x-rar-compressed',
        '7z': 'application/x-7z-compressed',
        'gz': 'application/gzip',
        'tar': 'application/x-tar',
        
        // ÂÖ∂‰ªñÂ∏∏ËßÅÊ†ºÂºè
        'apk': 'application/vnd.android.package-archive',
        'exe': 'application/x-msdownload',
        'dmg': 'application/x-apple-diskimage'
      };
      
      return mimeTypes[fileExt] || 'application/octet-stream';
    }

    // Âà§Êñ≠Êñá‰ª∂ÊòØÂê¶ÂèØÈ¢ÑËßà
    function isFilePreviewable(fileExt, mimeType) {
      // ÂèØÈ¢ÑËßàÁöÑÊñá‰ª∂Êâ©Â±ïÂêçÂàóË°®
      const previewableExts = [
        // ÂõæÁâá
        'jpg', 'jpeg', 'png', 'gif', 'webp', 'svg',
        
        // Èü≥È¢ë
        'mp3', 'wav', 'ogg', 'm4a',
        
        // ËßÜÈ¢ë
        'mp4', 'webm', 'ogv'
      ];
      
      // È¶ñÂÖàÊ£ÄÊü•Êñá‰ª∂Êâ©Â±ïÂêç
      if (previewableExts.includes(fileExt)) {
        return true;
      }
      
      // ÁÑ∂ÂêéÊ£ÄÊü•MIMEÁ±ªÂûã
      if (mimeType.startsWith('image/') || 
          mimeType.startsWith('video/') || 
          mimeType.startsWith('audio/')) {
        return true;
      }
      
      return false;
    }

    // ËÆæÂ§áÂàóË°®Ê∏≤Êüì
    function updateDeviceList() {
      // Ëé∑ÂèñËÆæÂ§áÂàóË°®
      const deviceList = Array.from(devices.values()).filter(device => device.id !== myDeviceId);
      
      // Êõ¥Êñ∞ÊµÆÂä®ÊåâÈíÆ‰∏äÁöÑËÆæÂ§áÊï∞Èáè
      const deviceCount = document.getElementById('deviceCount');
      deviceCount.textContent = deviceList.length;
      
      // Â¶ÇÊûúÊ≤°ÊúâËÆæÂ§áÔºå‰∏çÈúÄË¶ÅËøõ‰∏ÄÊ≠•Â§ÑÁêÜ
      if (deviceList.length === 0) {
        return;
      }
    }

    // ÊòæÁ§∫ËÆæÂ§áÂàóË°®ÂºπÁ™ó
    function showDevicesModal() {
      const deviceList = Array.from(devices.values()).filter(device => device.id !== myDeviceId);
      
      if (deviceList.length === 0) {
        showNotification('Ê≤°ÊúâÂèØÁî®ÁöÑËÆæÂ§á');
        return;
      }
      
      // ÂàõÂª∫Ê®°ÊÄÅÁ™óÂè£
      const modal = document.createElement('div');
      modal.className = 'devices-modal';
      modal.id = 'devicesModal';
      
      // ÂàõÂª∫Â§öÈÄâÊ®°ÂºèÊèêÁ§∫
      let multiSelectNotice = '';
      if (showMultiSelect) {
        multiSelectNotice = `
          <div class="multi-select-notice">
            <i class="ri-checkbox-multiple-line"></i>
            <span>‰Ω†ÂèØ‰ª•ÈÄâÊã©Â§ö‰∏™ËÆæÂ§á</span>
          </div>
        `;
      }
      
      // ÂºπÁ™óÂÜÖÂÆπ
      modal.innerHTML = `
        <div class="devices-modal-content">
          <div class="devices-modal-header">
            <div class="devices-modal-title">ÂèØÁî®ËÆæÂ§á (${deviceList.length})</div>
            <button class="devices-modal-close" id="closeDevicesModal">
              <i class="ri-close-line"></i>
            </button>
          </div>
          <div class="devices-modal-body">
            ${multiSelectNotice}
            <div class="device-list-grid" id="deviceGrid">
              ${deviceList.map(device => {
                // ËÆæÁΩÆÊ†∑ÂºèÁ±ª
                let className = 'device-card';
                if (selectedDeviceId === device.id) {
                  className += ' active';
                }
                if (selectedDevices.has(device.id)) {
                  className += ' selected';
                }
                
                return `
                  <div class="${className}" data-id="${device.id}">
                    <i class="${device.icon || 'ri-device-line'}"></i>
                    <div class="device-card-name">${device.name || `ËÆæÂ§á ${device.id.slice(0, 6)}`}</div>
                  </div>
                `;
              }).join('')}
            </div>
            ${showMultiSelect ? `
              <button class="device-select-btn" id="confirmDeviceSelection">
                <i class="ri-check-line"></i>
                Á°ÆËÆ§ÈÄâÊã© (${selectedDevices.size})
              </button>
            ` : ''}
          </div>
        </div>
      `;
      
      // Ê∑ªÂä†Âà∞body
      document.body.appendChild(modal);
      
      // ÁÇπÂáªÂÖ≥Èó≠ÊåâÈíÆ
      document.getElementById('closeDevicesModal').addEventListener('click', () => {
        closeDevicesModal();
      });
      
      // ÁÇπÂáªËÆæÂ§áÂç°Áâá
      document.querySelectorAll('.device-card').forEach(card => {
        card.addEventListener('click', () => {
          const deviceId = card.dataset.id;
          
          if (showMultiSelect) {
            // Â§öÈÄâÊ®°Âºè
            if (selectedDevices.has(deviceId)) {
              selectedDevices.delete(deviceId);
              card.classList.remove('selected');
            } else {
              selectedDevices.add(deviceId);
              card.classList.add('selected');
            }
            
            // Êõ¥Êñ∞Á°ÆËÆ§ÊåâÈíÆÊñáÂ≠ó
            const confirmBtn = document.getElementById('confirmDeviceSelection');
            if (confirmBtn) {
              confirmBtn.innerHTML = `<i class="ri-check-line"></i>Á°ÆËÆ§ÈÄâÊã© (${selectedDevices.size})`;
            }
          } else {
            // ÂçïÈÄâÊ®°ÂºèÔºåÁõ¥Êé•ÈÄâÊã©Âπ∂ÂÖ≥Èó≠
            selectedDeviceId = deviceId;
            selectedDevices.clear();
            showNotification(`Â∑≤ÈÄâÊã©ËÆæÂ§á: ${devices.get(deviceId)?.name || `ËÆæÂ§á ${deviceId.slice(0, 6)}`}`);
            closeDevicesModal();
          }
        });
      });
      
      // Â§öÈÄâÊ®°Âºè‰∏ãÁöÑÁ°ÆËÆ§ÊåâÈíÆ
      if (showMultiSelect) {
        document.getElementById('confirmDeviceSelection').addEventListener('click', () => {
          if (selectedDevices.size > 0) {
            showNotification(`Â∑≤ÈÄâÊã© ${selectedDevices.size} ‰∏™ËÆæÂ§á`);
            closeDevicesModal();
          } else {
            showNotification('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ËÆæÂ§á');
          }
        });
      }
      
      // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeDevicesModal();
        }
      });
    }
    
    // ÂÖ≥Èó≠ËÆæÂ§áÂàóË°®ÂºπÁ™ó
    function closeDevicesModal() {
      const modal = document.getElementById('devicesModal');
      if (modal) {
        modal.remove();
      }
    }
    
    // ÂàáÊç¢Â§öÈÄâÊ®°Âºè
    function toggleMultiSelect() {
      showMultiSelect = !showMultiSelect;
      if (!showMultiSelect) {
        selectedDevices.clear();
      }
      
      // ÈáçÊñ∞ÊâìÂºÄËÆæÂ§áÂºπÁ™ó
      closeDevicesModal();
      showDevicesModal();
    }

    // ÊµÆÂä®ËÆæÂ§áÊåâÈíÆ‰∫ã‰ª∂
    document.getElementById('deviceFloatBtn').addEventListener('click', () => {
      showDevicesModal();
    });
    
    // ÈïøÊåâÊµÆÂä®ÊåâÈíÆÂàáÊç¢Â§öÈÄâÊ®°Âºè
    document.getElementById('deviceFloatBtn').addEventListener('contextmenu', (e) => {
      e.preventDefault();
      toggleMultiSelect();
      return false;
    });
    
    // ‰∏∫ÁßªÂä®ËÆæÂ§áÊ∑ªÂä†ÈïøÊåâÊîØÊåÅ
    let pressTimer;
    document.getElementById('deviceFloatBtn').addEventListener('touchstart', () => {
      pressTimer = setTimeout(() => {
        toggleMultiSelect();
      }, 800);
    });
    
    document.getElementById('deviceFloatBtn').addEventListener('touchend', () => {
      clearTimeout(pressTimer);
    });
    
    document.getElementById('deviceFloatBtn').addEventListener('touchmove', () => {
      clearTimeout(pressTimer);
    });

    // Socket.io ‰∫ã‰ª∂
    socket.on('connect', () => {
      debugLog('CONNECT', 'Â∑≤ËøûÊé•Âà∞ÊúçÂä°Âô®');
      // ÂàùÂßãÂåñËÆæÂ§áÂêçÁß∞
      const deviceName = initDeviceName();
      
      // ÂàùÂßãÂåñËÆæÂ§á‰ø°ÊÅØ
      myDeviceInfo = {
        ...getDeviceInfo(),
        name: deviceName
      };
      
      // ÂèëÈÄÅËÆæÂ§á‰ø°ÊÅØÂà∞ÊúçÂä°Âô®
      socket.emit('device-info', myDeviceInfo);
      
      // Êõ¥Êñ∞ËÆæÂ§áÂõæÊ†á
      updateDeviceTypeIcon();
    });
    
    socket.on('device-info', (data) => {
      myDeviceId = data.id;
      data.devices.forEach(device => { 
        devices.set(device.id, device); 
      });
      updateDeviceList();
    });
    
    socket.on('device-joined', (data) => {
      devices.set(data.id, { 
        id: data.id, 
        lastSeen: Date.now(), 
        type: data.type, 
        icon: data.icon, 
        name: data.name 
      });
      updateDeviceList();
      showNotification(`${data.name || `ËÆæÂ§á ${data.id.slice(0, 6)}`} Â∑≤Âä†ÂÖ•`);
    });
    
    socket.on('device-left', (data) => {
      devices.delete(data.id);
      
      // Â¶ÇÊûúËÆæÂ§áË¢´ÈÄâ‰∏≠ÔºåÁßªÈô§ÈÄâÊã©
      if (selectedDeviceId === data.id) {
        selectedDeviceId = null;
      }
      
      if (selectedDevices.has(data.id)) {
        selectedDevices.delete(data.id);
      }
      
      updateDeviceList();
    });
    
    socket.on('device-info-update', (data) => {
      if (devices.has(data.id)) {
        const device = devices.get(data.id);
        device.name = data.name;
        device.type = data.type;
        device.icon = data.icon;
        devices.set(data.id, device);
        updateDeviceList();
      }
    });
    
    socket.on('message', (data) => {
      const { fromId, message } = data;
      const device = devices.get(fromId);
      const deviceName = device ? device.name || `ËÆæÂ§á ${fromId.slice(0, 6)}` : `ËÆæÂ§á ${fromId.slice(0, 6)}`;
      
      showModal(
        'Êî∂Âà∞Ê∂àÊÅØ',
        `<div style="margin-bottom:1rem;">
          <div style="margin-bottom:0.5rem;font-weight:500;">Êù•Ëá™ ${deviceName}Ôºö</div>
          <div style="border-radius:var(--radius-md);background:var(--color-surface);padding:0.75rem;word-break:break-all;">
            ${message}
          </div>
        </div>`,
        [{ text: 'ÂÖ≥Èó≠', class: 'primary', action: closeModal }]
      );
    });

    socket.on('file-transfer-request', (data) => { 
      handleFileReceive(data); 
    });

    // ModalÂºπÁ™ó
    function showModal(title, content, buttons=[]) {
      const modal = document.getElementById('modal');
      
      let buttonsHtml = '';
      if (buttons.length > 0) {
        buttonsHtml = `<div class="modal-buttons">`;
        buttons.forEach(btn => {
          buttonsHtml += `<button class="modal-btn ${btn.class || ''}">${btn.text}</button>`;
        });
        buttonsHtml += `</div>`;
      }
      
      modal.innerHTML = `
        <div class="modal">
          <div class="modal-content">
            <div class="modal-title">${title}</div>
            <div>${content}</div>
            ${buttonsHtml}
          </div>
        </div>
      `;
      
      modal.style.display = 'block';
      
      if (buttons.length > 0) {
        modal.querySelectorAll('.modal-btn').forEach((btn, i) => {
          if (buttons[i].action) {
            btn.onclick = buttons[i].action;
          }
        });
      }
    }

    function closeModal() { 
      document.getElementById('modal').style.display = 'none'; 
    }

    // Êñá‰ª∂Â§ßÂ∞èÊ†ºÂºèÂåñ
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024, sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Â∏ÆÂä©ÊåâÈíÆ
    document.querySelector('[title="Â∏ÆÂä©"]').addEventListener('click', () => {
      showModal(
        '‰ΩøÁî®Â∏ÆÂä©',
        `<div style="text-align:left;">
          <p style="margin-bottom:0.75rem;">1. Âú®Âêå‰∏ÄÂ±ÄÂüüÁΩë‰∏ãÊâìÂºÄÊú¨È°µÈù¢Âç≥ÂèØ‰∫í‰º†Êñá‰ª∂</p>
          <p style="margin-bottom:0.75rem;">2. ÁÇπÂáª‰∏≠ÂøÉÊåâÈíÆÈÄâÊã©Ë¶Å‰º†ËæìÁöÑÊñá‰ª∂</p>
          <p style="margin-bottom:0.75rem;">3. ÁÇπÂáªÂ∫ïÈÉ®ËÆæÂ§áÂàóË°®‰∏≠ÁöÑËÆæÂ§áËøõË°åÈÄâÊã©</p>
          <p style="margin-bottom:0.75rem;">4. ÊîØÊåÅÊãñÊîæÊñá‰ª∂Âà∞‰∏≠ÂøÉÊåâÈíÆËøõË°å‰∏ä‰º†</p>
          <p>5. ÊîØÊåÅÊñáÊú¨Ê∂àÊÅØÂíåÊñá‰ª∂Â§πÁöÑ‰º†Ëæì</p>
        </div>`,
        [{ text: 'Áü•ÈÅì‰∫Ü', class: 'primary', action: closeModal }]
      );
    });

    // ËÆæÁΩÆÊåâÈíÆ
    document.querySelector('[title="ËÆæÁΩÆ"]').addEventListener('click', () => {
      showNotification('ËÆæÁΩÆÂäüËÉΩÂç≥Â∞Ü‰∏äÁ∫øÔºåÊï¨ËØ∑ÊúüÂæÖÔºÅ');
    });

    // ÁõëÂê¨ÂèñÊ∂à‰º†Ëæì
    socket.on('cancel-transfer', (data) => {
      const { fromId, transferId } = data;
      debugLog('RECEIVED_CANCEL', 'Êî∂Âà∞ÂèñÊ∂à‰º†ËæìËØ∑Ê±Ç', { fromId, transferId });
      
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÊé•Êî∂‰∏≠ÁöÑÊñá‰ª∂
      if (fileReceivers.has(transferId)) {
        // ÂèñÊ∂àÊé•Êî∂
        fileReceivers.delete(transferId);
        showNotification('ÂØπÊñπÂ∑≤ÂèñÊ∂àÊñá‰ª∂‰º†Ëæì');
        
        // ÂÖ≥Èó≠‰ªª‰ΩïÊ≠£Âú®ÊòæÁ§∫ÁöÑËøõÂ∫¶Êù°
        const progressElement = document.getElementById(`transfer-${transferId}`);
        if (progressElement) {
          progressElement.querySelector('.progress-bar').style.background = 'var(--color-text-tertiary)';
          const progressText = progressElement.querySelector('.transfer-progress-text');
          if (progressText) progressText.textContent = 'Â∑≤ÂèñÊ∂à';
          
          // ‰∏ÄÊÆµÊó∂Èó¥ÂêéÁßªÈô§UI
          setTimeout(() => {
            progressElement.style.opacity = '0';
            progressElement.style.transition = 'opacity 0.5s ease';
            setTimeout(() => progressElement.remove(), 500);
          }, 3000);
        }
      }
      
      // Êõ¥Êñ∞‰º†ËæìÁä∂ÊÄÅ
      if (activeTransfers.has(transferId)) {
        const transfer = activeTransfers.get(transferId);
        transfer.status = 'cancelled';
        activeTransfers.set(transferId, transfer);
        updateTransferProgress(transferId);
      }
    });

    // ‰øÆÊîπfile-transfer-response‰∫ã‰ª∂Â§ÑÁêÜÂáΩÊï∞
    socket.on('file-transfer-response', (data) => {
      const { fromId, transferId, accepted } = data;
      debugLog('RESPONSE', `Êî∂Âà∞‰º†ËæìÂìçÂ∫î`, { fromId, transferId, accepted });
      
      // Êü•ÊâæÊ≠§‰º†ËæìIDÂØπÂ∫îÁöÑÊ¥ªË∑É‰º†Ëæì
      const transfer = activeTransfers.get(transferId);
      
      // Êü•ÊâæÊ≠§‰º†ËæìIDÂØπÂ∫îÁöÑÁõÆÊ†áËÆæÂ§áID
      const targetId = fileTransferMappings.get(transferId);
      
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÂêàÊ≥ïÁöÑÂìçÂ∫î
      if (transfer && fromId === targetId) {
        if (accepted) {
          debugLog('SEND', `ÁõÆÊ†áËÆæÂ§áÂ∑≤Êé•ÂèóÊñá‰ª∂‰º†ËæìËØ∑Ê±ÇÔºåÂºÄÂßãÂèëÈÄÅÊï∞ÊçÆ`, { transferId, targetId });
          
          // Êõ¥Êñ∞‰º†ËæìÁä∂ÊÄÅ
          transfer.status = 'active';
          activeTransfers.set(transferId, transfer);
          
          // ÊòæÁ§∫‰º†ËæìËøõÂ∫¶
          showTransferProgress(transferId);
          
          // ÂºÄÂßã‰º†ËæìÊñá‰ª∂Êï∞ÊçÆ
          sendFileData(transfer.file, targetId, transferId);
        } else {
          debugLog('SEND', `ÁõÆÊ†áËÆæÂ§áÊãíÁªù‰∫ÜÊñá‰ª∂‰º†ËæìËØ∑Ê±Ç`, { transferId, targetId });
          
          // Êõ¥Êñ∞‰º†ËæìÁä∂ÊÄÅ
          transfer.status = 'rejected';
          activeTransfers.set(transferId, transfer);
          
          // Êõ¥Êñ∞UI
          showTransferRejectedUI(transferId);
          
          showNotification(`ÂØπÊñπÊãíÁªùÊé•Êî∂Êñá‰ª∂ ${transfer.name}`);
        }
      }
    });

    // Ê∑ªÂä†Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂáΩÊï∞‰∏≠
    // ËÆæÂ§áÂàóË°®ÊäòÂè†/Â±ïÂºÄÂàáÊç¢
    document.getElementById('deviceListToggle').addEventListener('click', function() {
      const footer = document.getElementById('deviceFooter');
      footer.classList.toggle('collapsed');
      
      // ËÆ∞ÂΩïÁî®Êà∑ÊâãÂä®Â±ïÂºÄÁöÑÁä∂ÊÄÅ
      if (!footer.classList.contains('collapsed')) {
        footer.classList.add('user-expanded');
      } else {
        footer.classList.remove('user-expanded');
      }
      
      // ‰øùÂ≠òÊäòÂè†Áä∂ÊÄÅÂà∞Êú¨Âú∞Â≠òÂÇ®
      localStorage.setItem('deviceListCollapsed', footer.classList.contains('collapsed'));
    });

    let showMultiSelect = false; // ÊòØÂê¶ÊòæÁ§∫Â§öÈÄâÊ®°Âºè
  </script>
</body>
</html>